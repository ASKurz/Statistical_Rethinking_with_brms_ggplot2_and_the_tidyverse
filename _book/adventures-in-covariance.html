<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>13 Adventures in Covariance | Statistical rethinking with brms, ggplot2, and the tidyverse</title>
  <meta name="description" content="This project is an attempt to re-express the code in McElreath’s textbook. His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="13 Adventures in Covariance | Statistical rethinking with brms, ggplot2, and the tidyverse" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This project is an attempt to re-express the code in McElreath’s textbook. His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  <meta name="github-repo" content="ASKURZ/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="13 Adventures in Covariance | Statistical rethinking with brms, ggplot2, and the tidyverse" />
  <meta name="twitter:site" content="@SolomonKurz" />
  <meta name="twitter:description" content="This project is an attempt to re-express the code in McElreath’s textbook. His models are re-fit in brms, plots are redone with ggplot2, and the general data wrangling code predominantly follows the tidyverse style." />
  

<meta name="author" content="A Solomon Kurz" />


<meta name="date" content="2020-10-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="multilevel-models.html"/>
<link rel="next" href="missing-data-and-other-opportunities.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>This is a love letter</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#why-this"><i class="fa fa-check"></i>Why this?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#my-assumptions-about-you"><i class="fa fa-check"></i>My assumptions about you</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-use-and-understand-this-project"><i class="fa fa-check"></i>How to use and understand this project</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#you-can-do-this-too"><i class="fa fa-check"></i>You can do this, too</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#we-have-updates"><i class="fa fa-check"></i>We have updates</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#version-0.9.0."><i class="fa fa-check"></i>Version 0.9.0.</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#version-1.0.0."><i class="fa fa-check"></i>Version 1.0.0.</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#version-1.0.1."><i class="fa fa-check"></i>Version 1.0.1.</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#version-1.1.0."><i class="fa fa-check"></i>Version 1.1.0.</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#version-1.2.0."><i class="fa fa-check"></i>Version 1.2.0.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#is-this-material-obsolete"><i class="fa fa-check"></i>Is this material obsolete?</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#thank-yous-are-in-order"><i class="fa fa-check"></i>Thank-you’s are in order</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html"><i class="fa fa-check"></i><b>1</b> The Golem of Prague</a><ul>
<li class="chapter" data-level="" data-path="the-golem-of-prague.html"><a href="the-golem-of-prague.html#session-info"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html"><i class="fa fa-check"></i><b>2</b> Small Worlds and Large Worlds</a><ul>
<li class="chapter" data-level="2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#the-garden-of-forking-data"><i class="fa fa-check"></i><b>2.1</b> The garden of forking data</a><ul>
<li class="chapter" data-level="2.1.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#counting-possibilities."><i class="fa fa-check"></i><b>2.1.1</b> Counting possibilities.</a></li>
<li class="chapter" data-level="2.1.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#using-prior-information."><i class="fa fa-check"></i><b>2.1.2</b> Using prior information.</a></li>
<li class="chapter" data-level="2.1.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#from-counts-to-probability."><i class="fa fa-check"></i><b>2.1.3</b> From counts to probability.</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#building-a-model"><i class="fa fa-check"></i><b>2.2</b> Building a model</a><ul>
<li class="chapter" data-level="2.2.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#a-data-story."><i class="fa fa-check"></i><b>2.2.1</b> A data story.</a></li>
<li class="chapter" data-level="2.2.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#bayesian-updating."><i class="fa fa-check"></i><b>2.2.2</b> Bayesian updating.</a></li>
<li class="chapter" data-level="2.2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#evaluate."><i class="fa fa-check"></i><b>2.2.3</b> Evaluate.</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#components-of-the-model"><i class="fa fa-check"></i><b>2.3</b> Components of the model</a><ul>
<li class="chapter" data-level="2.3.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#likelihood."><i class="fa fa-check"></i><b>2.3.1</b> Likelihood.</a></li>
<li class="chapter" data-level="2.3.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#parameters."><i class="fa fa-check"></i><b>2.3.2</b> Parameters.</a></li>
<li class="chapter" data-level="2.3.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#prior."><i class="fa fa-check"></i><b>2.3.3</b> Prior.</a></li>
<li class="chapter" data-level="2.3.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#posterior."><i class="fa fa-check"></i><b>2.3.4</b> Posterior.</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#making-the-model-go"><i class="fa fa-check"></i><b>2.4</b> Making the model go</a><ul>
<li class="chapter" data-level="2.4.1" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#grid-approximation."><i class="fa fa-check"></i><b>2.4.1</b> Grid approximation.</a></li>
<li class="chapter" data-level="2.4.2" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#quadratic-approximation."><i class="fa fa-check"></i><b>2.4.2</b> Quadratic approximation.</a></li>
<li class="chapter" data-level="2.4.3" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#markov-chain-monte-carlo."><i class="fa fa-check"></i><b>2.4.3</b> Markov chain Monte Carlo.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="small-worlds-and-large-worlds.html"><a href="small-worlds-and-large-worlds.html#session-info-1"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html"><i class="fa fa-check"></i><b>3</b> Sampling the Imaginary</a><ul>
<li class="chapter" data-level="3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-from-a-grid-like-approximate-posterior"><i class="fa fa-check"></i><b>3.1</b> Sampling from a grid-like approximate posterior</a></li>
<li class="chapter" data-level="3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-summarize"><i class="fa fa-check"></i><b>3.2</b> Sampling to summarize</a><ul>
<li class="chapter" data-level="3.2.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-boundaries."><i class="fa fa-check"></i><b>3.2.1</b> Intervals of defined boundaries.</a></li>
<li class="chapter" data-level="3.2.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#intervals-of-defined-mass."><i class="fa fa-check"></i><b>3.2.2</b> Intervals of defined mass.</a></li>
<li class="chapter" data-level="3.2.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#point-estimates."><i class="fa fa-check"></i><b>3.2.3</b> Point estimates.</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#sampling-to-simulate-prediction"><i class="fa fa-check"></i><b>3.3</b> Sampling to simulate prediction</a><ul>
<li class="chapter" data-level="3.3.1" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#dummy-data."><i class="fa fa-check"></i><b>3.3.1</b> Dummy data.</a></li>
<li class="chapter" data-level="3.3.2" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#model-checking."><i class="fa fa-check"></i><b>3.3.2</b> Model checking.</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#summary-lets-practice-with-brms"><i class="fa fa-check"></i><b>3.4</b> <del>Summary</del> Let’s practice with brms</a></li>
<li class="chapter" data-level="" data-path="sampling-the-imaginary.html"><a href="sampling-the-imaginary.html#session-info-2"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="linear-models.html"><a href="linear-models.html"><i class="fa fa-check"></i><b>4</b> Linear Models</a><ul>
<li class="chapter" data-level="4.1" data-path="linear-models.html"><a href="linear-models.html#why-normal-distributions-are-normal"><i class="fa fa-check"></i><b>4.1</b> Why normal distributions are normal</a><ul>
<li class="chapter" data-level="4.1.1" data-path="linear-models.html"><a href="linear-models.html#normal-by-addition."><i class="fa fa-check"></i><b>4.1.1</b> Normal by addition.</a></li>
<li class="chapter" data-level="4.1.2" data-path="linear-models.html"><a href="linear-models.html#normal-by-multiplication."><i class="fa fa-check"></i><b>4.1.2</b> Normal by multiplication.</a></li>
<li class="chapter" data-level="4.1.3" data-path="linear-models.html"><a href="linear-models.html#normal-by-log-multiplication."><i class="fa fa-check"></i><b>4.1.3</b> Normal by log-multiplication.</a></li>
<li class="chapter" data-level="4.1.4" data-path="linear-models.html"><a href="linear-models.html#using-gaussian-distributions."><i class="fa fa-check"></i><b>4.1.4</b> Using Gaussian distributions.</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="linear-models.html"><a href="linear-models.html#a-language-for-describing-models"><i class="fa fa-check"></i><b>4.2</b> A language for describing models</a><ul>
<li class="chapter" data-level="4.2.1" data-path="linear-models.html"><a href="linear-models.html#re-describing-the-globe-tossing-model."><i class="fa fa-check"></i><b>4.2.1</b> Re-describing the globe tossing model.</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="linear-models.html"><a href="linear-models.html#a-gaussian-model-of-height"><i class="fa fa-check"></i><b>4.3</b> A Gaussian model of height</a><ul>
<li class="chapter" data-level="4.3.1" data-path="linear-models.html"><a href="linear-models.html#the-data."><i class="fa fa-check"></i><b>4.3.1</b> The data.</a></li>
<li class="chapter" data-level="4.3.2" data-path="linear-models.html"><a href="linear-models.html#the-model."><i class="fa fa-check"></i><b>4.3.2</b> The model.</a></li>
<li class="chapter" data-level="4.3.3" data-path="linear-models.html"><a href="linear-models.html#grid-approximation-of-the-posterior-distribution."><i class="fa fa-check"></i><b>4.3.3</b> Grid approximation of the posterior distribution.</a></li>
<li class="chapter" data-level="4.3.4" data-path="linear-models.html"><a href="linear-models.html#sampling-from-the-posterior."><i class="fa fa-check"></i><b>4.3.4</b> Sampling from the posterior.</a></li>
<li class="chapter" data-level="4.3.5" data-path="linear-models.html"><a href="linear-models.html#fitting-the-model-with-map-brm."><i class="fa fa-check"></i><b>4.3.5</b> Fitting the model with <del><code>map</code></del> <code>brm()</code>.</a></li>
<li class="chapter" data-level="4.3.6" data-path="linear-models.html"><a href="linear-models.html#sampling-from-a-map-brm-fit."><i class="fa fa-check"></i><b>4.3.6</b> Sampling from a <del><code>map</code></del> <code>brm()</code> fit.</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="linear-models.html"><a href="linear-models.html#adding-a-predictor"><i class="fa fa-check"></i><b>4.4</b> Adding a predictor</a><ul>
<li class="chapter" data-level="4.4.1" data-path="linear-models.html"><a href="linear-models.html#the-linear-model-strategy."><i class="fa fa-check"></i><b>4.4.1</b> The linear model strategy.</a></li>
<li class="chapter" data-level="4.4.2" data-path="linear-models.html"><a href="linear-models.html#fitting-the-model."><i class="fa fa-check"></i><b>4.4.2</b> Fitting the model.</a></li>
<li class="chapter" data-level="4.4.3" data-path="linear-models.html"><a href="linear-models.html#interpreting-the-model-fit."><i class="fa fa-check"></i><b>4.4.3</b> Interpreting the model fit.</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="linear-models.html"><a href="linear-models.html#polynomial-regression"><i class="fa fa-check"></i><b>4.5</b> Polynomial regression</a></li>
<li class="chapter" data-level="" data-path="linear-models.html"><a href="linear-models.html#session-info-3"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html"><i class="fa fa-check"></i><b>5</b> Multivariate Linear Models</a><ul>
<li class="chapter" data-level="5.1" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#spurious-associations"><i class="fa fa-check"></i><b>5.1</b> Spurious associations</a><ul>
<li class="chapter" data-level="5.1.1" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#multivariate-notation."><i class="fa fa-check"></i><b>5.1.1</b> Multivariate notation.</a></li>
<li class="chapter" data-level="5.1.2" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#fitting-the-model.-1"><i class="fa fa-check"></i><b>5.1.2</b> Fitting the model.</a></li>
<li class="chapter" data-level="5.1.3" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#plotting-multivariate-posteriors."><i class="fa fa-check"></i><b>5.1.3</b> Plotting multivariate posteriors.</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#masked-relationship"><i class="fa fa-check"></i><b>5.2</b> Masked relationship</a></li>
<li class="chapter" data-level="5.3" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#multicollinearity"><i class="fa fa-check"></i><b>5.3</b> Multicollinearity</a><ul>
<li class="chapter" data-level="5.3.1" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#multicollinear-legs."><i class="fa fa-check"></i><b>5.3.1</b> Multicollinear legs.</a></li>
<li class="chapter" data-level="5.3.2" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#multicollinear-milk."><i class="fa fa-check"></i><b>5.3.2</b> Multicollinear <code>milk</code>.</a></li>
<li class="chapter" data-level="5.3.3" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#post-treatment-bias."><i class="fa fa-check"></i><b>5.3.3</b> Post-treatment bias.</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#categorical-variables"><i class="fa fa-check"></i><b>5.4</b> Categorical variables</a><ul>
<li class="chapter" data-level="5.4.1" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#binary-categories."><i class="fa fa-check"></i><b>5.4.1</b> Binary categories.</a></li>
<li class="chapter" data-level="5.4.2" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#many-categories."><i class="fa fa-check"></i><b>5.4.2</b> Many categories.</a></li>
<li class="chapter" data-level="5.4.3" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#adding-regular-predictor-variables."><i class="fa fa-check"></i><b>5.4.3</b> Adding regular predictor variables.</a></li>
<li class="chapter" data-level="5.4.4" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#another-approach-unique-intercepts."><i class="fa fa-check"></i><b>5.4.4</b> Another approach: Unique intercepts.</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#ordinary-least-squares-and-lm"><i class="fa fa-check"></i><b>5.5</b> <del>Ordinary least squares and <code>lm()</code></del></a></li>
<li class="chapter" data-level="" data-path="multivariate-linear-models.html"><a href="multivariate-linear-models.html#session-info-4"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html"><i class="fa fa-check"></i><b>6</b> Overfitting, Regularization, and Information Criteria</a><ul>
<li class="chapter" data-level="6.1" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#the-problem-with-parameters"><i class="fa fa-check"></i><b>6.1</b> The problem with parameters</a><ul>
<li class="chapter" data-level="6.1.1" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#more-parameters-always-improve-fit."><i class="fa fa-check"></i><b>6.1.1</b> More parameters always improve fit.</a></li>
<li class="chapter" data-level="6.1.2" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#too-few-parameters-hurts-too."><i class="fa fa-check"></i><b>6.1.2</b> Too few parameters hurts, too.</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#information-theory-and-model-performance"><i class="fa fa-check"></i><b>6.2</b> Information theory and model performance</a><ul>
<li class="chapter" data-level="6.2.1" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#firing-the-weatherperson."><i class="fa fa-check"></i><b>6.2.1</b> Firing the weatherperson.</a></li>
<li class="chapter" data-level="6.2.2" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#information-and-uncertainty."><i class="fa fa-check"></i><b>6.2.2</b> Information and uncertainty.</a></li>
<li class="chapter" data-level="6.2.3" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#from-entropy-to-accuracy."><i class="fa fa-check"></i><b>6.2.3</b> From entropy to accuracy.</a></li>
<li class="chapter" data-level="6.2.4" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#from-divergence-to-deviance."><i class="fa fa-check"></i><b>6.2.4</b> From divergence to deviance.</a></li>
<li class="chapter" data-level="6.2.5" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#from-deviance-to-out-of-sample."><i class="fa fa-check"></i><b>6.2.5</b> From deviance to out-of-sample.</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#regularization"><i class="fa fa-check"></i><b>6.3</b> Regularization</a></li>
<li class="chapter" data-level="6.4" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#information-criteria"><i class="fa fa-check"></i><b>6.4</b> Information criteria</a><ul>
<li class="chapter" data-level="6.4.1" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#dic."><i class="fa fa-check"></i><b>6.4.1</b> DIC.</a></li>
<li class="chapter" data-level="6.4.2" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#waic."><i class="fa fa-check"></i><b>6.4.2</b> WAIC.</a></li>
<li class="chapter" data-level="6.4.3" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#dic-and-waic-as-estimates-of-deviance."><i class="fa fa-check"></i><b>6.4.3</b> DIC and WAIC as estimates of deviance.</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#using-information-criteria"><i class="fa fa-check"></i><b>6.5</b> Using information criteria</a><ul>
<li class="chapter" data-level="6.5.1" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#model-comparison."><i class="fa fa-check"></i><b>6.5.1</b> Model comparison.</a></li>
<li class="chapter" data-level="6.5.2" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#model-averaging."><i class="fa fa-check"></i><b>6.5.2</b> Model averaging.</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#summary-bonus-r2-talk"><i class="fa fa-check"></i><b>6.6</b> <del>Summary</del> Bonus: <span class="math inline">\(R^2\)</span> talk</a></li>
<li class="chapter" data-level="" data-path="overfitting-regularization-and-information-criteria.html"><a href="overfitting-regularization-and-information-criteria.html#session-info-5"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="interactions.html"><a href="interactions.html"><i class="fa fa-check"></i><b>7</b> Interactions</a><ul>
<li class="chapter" data-level="7.1" data-path="interactions.html"><a href="interactions.html#building-an-interaction."><i class="fa fa-check"></i><b>7.1</b> Building an interaction.</a><ul>
<li class="chapter" data-level="7.1.1" data-path="interactions.html"><a href="interactions.html#adding-a-dummy-variable-doesnt-work."><i class="fa fa-check"></i><b>7.1.1</b> Adding a dummy variable doesn’t work.</a></li>
<li class="chapter" data-level="7.1.2" data-path="interactions.html"><a href="interactions.html#adding-a-linear-interaction-does-work."><i class="fa fa-check"></i><b>7.1.2</b> Adding a linear interaction does work.</a></li>
<li class="chapter" data-level="7.1.3" data-path="interactions.html"><a href="interactions.html#plotting-the-interaction."><i class="fa fa-check"></i><b>7.1.3</b> Plotting the interaction.</a></li>
<li class="chapter" data-level="7.1.4" data-path="interactions.html"><a href="interactions.html#interpreting-an-interaction-estimate."><i class="fa fa-check"></i><b>7.1.4</b> Interpreting an interaction estimate.</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="interactions.html"><a href="interactions.html#symmetry-of-the-linear-interaction."><i class="fa fa-check"></i><b>7.2</b> Symmetry of the linear interaction.</a><ul>
<li class="chapter" data-level="7.2.1" data-path="interactions.html"><a href="interactions.html#buridans-interaction."><i class="fa fa-check"></i><b>7.2.1</b> Buridan’s interaction.</a></li>
<li class="chapter" data-level="7.2.2" data-path="interactions.html"><a href="interactions.html#africa-depends-upon-ruggedness."><i class="fa fa-check"></i><b>7.2.2</b> Africa depends upon ruggedness.</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="interactions.html"><a href="interactions.html#continuous-interactions"><i class="fa fa-check"></i><b>7.3</b> Continuous interactions</a><ul>
<li class="chapter" data-level="7.3.1" data-path="interactions.html"><a href="interactions.html#the-data.-1"><i class="fa fa-check"></i><b>7.3.1</b> The data.</a></li>
<li class="chapter" data-level="7.3.2" data-path="interactions.html"><a href="interactions.html#the-un-centered-models."><i class="fa fa-check"></i><b>7.3.2</b> The un-centered models.</a></li>
<li class="chapter" data-level="7.3.3" data-path="interactions.html"><a href="interactions.html#center-and-re-estimate."><i class="fa fa-check"></i><b>7.3.3</b> Center and re-estimate.</a></li>
<li class="chapter" data-level="7.3.4" data-path="interactions.html"><a href="interactions.html#plotting-implied-predictions."><i class="fa fa-check"></i><b>7.3.4</b> Plotting implied predictions.</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="interactions.html"><a href="interactions.html#interactions-in-design-formulas"><i class="fa fa-check"></i><b>7.4</b> Interactions in design formulas</a></li>
<li class="chapter" data-level="7.5" data-path="interactions.html"><a href="interactions.html#summary-bonus-marginal_effectsconditional_effects"><i class="fa fa-check"></i><b>7.5</b> <del>Summary</del> Bonus: <code>marginal_effects()</code>/<code>conditional_effects()</code></a></li>
<li class="chapter" data-level="" data-path="interactions.html"><a href="interactions.html#session-info-6"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html"><i class="fa fa-check"></i><b>8</b> Markov Chain Monte Carlo</a><ul>
<li class="chapter" data-level="8.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#good-king-markov-and-his-island-kingdom"><i class="fa fa-check"></i><b>8.1</b> Good King Markov and His island kingdom</a></li>
<li class="chapter" data-level="8.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#markov-chain-monte-carlo-1"><i class="fa fa-check"></i><b>8.2</b> Markov chain Monte Carlo</a><ul>
<li class="chapter" data-level="8.2.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#gibbs-sampling."><i class="fa fa-check"></i><b>8.2.1</b> Gibbs sampling.</a></li>
<li class="chapter" data-level="8.2.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#hamiltonian-monte-carlo."><i class="fa fa-check"></i><b>8.2.2</b> Hamiltonian Monte Carlo.</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#easy-hmc-map2stan-brm"><i class="fa fa-check"></i><b>8.3</b> Easy HMC: <del>map2stan</del> <code>brm()</code></a><ul>
<li class="chapter" data-level="8.3.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#preparation."><i class="fa fa-check"></i><b>8.3.1</b> Preparation.</a></li>
<li class="chapter" data-level="8.3.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#estimation."><i class="fa fa-check"></i><b>8.3.2</b> Estimation.</a></li>
<li class="chapter" data-level="8.3.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#sampling-again-in-parallel."><i class="fa fa-check"></i><b>8.3.3</b> Sampling again, in parallel.</a></li>
<li class="chapter" data-level="8.3.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#visualization."><i class="fa fa-check"></i><b>8.3.4</b> Visualization.</a></li>
<li class="chapter" data-level="8.3.5" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#using-the-samples."><i class="fa fa-check"></i><b>8.3.5</b> Using the samples.</a></li>
<li class="chapter" data-level="8.3.6" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#checking-the-chain."><i class="fa fa-check"></i><b>8.3.6</b> Checking the chain.</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#care-and-feeding-of-your-markov-chain."><i class="fa fa-check"></i><b>8.4</b> Care and feeding of your Markov chain.</a><ul>
<li class="chapter" data-level="8.4.1" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-samples-do-you-need"><i class="fa fa-check"></i><b>8.4.1</b> How many samples do you need?</a></li>
<li class="chapter" data-level="8.4.2" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#how-many-chains-do-you-need"><i class="fa fa-check"></i><b>8.4.2</b> How many chains do you need?</a></li>
<li class="chapter" data-level="8.4.3" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#taming-a-wild-chain."><i class="fa fa-check"></i><b>8.4.3</b> Taming a wild chain.</a></li>
<li class="chapter" data-level="8.4.4" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#non-identifiable-parameters."><i class="fa fa-check"></i><b>8.4.4</b> Non-identifiable parameters.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="markov-chain-monte-carlo.html"><a href="markov-chain-monte-carlo.html#session-info-7"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html"><i class="fa fa-check"></i><b>9</b> Big Entropy and the Generalized Linear Model</a><ul>
<li class="chapter" data-level="9.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#maximum-entropy"><i class="fa fa-check"></i><b>9.1</b> Maximum entropy</a><ul>
<li class="chapter" data-level="9.1.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#gaussian."><i class="fa fa-check"></i><b>9.1.1</b> Gaussian.</a></li>
<li class="chapter" data-level="9.1.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#binomial."><i class="fa fa-check"></i><b>9.1.2</b> Binomial.</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#generalized-linear-models"><i class="fa fa-check"></i><b>9.2</b> Generalized linear models</a><ul>
<li class="chapter" data-level="9.2.1" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#meet-the-family."><i class="fa fa-check"></i><b>9.2.1</b> Meet the family.</a></li>
<li class="chapter" data-level="9.2.2" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#linking-linear-models-to-distributions."><i class="fa fa-check"></i><b>9.2.2</b> Linking linear models to distributions.</a></li>
<li class="chapter" data-level="9.2.3" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#absolute-and-relative-differences."><i class="fa fa-check"></i><b>9.2.3</b> Absolute and relative differences.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="big-entropy-and-the-generalized-linear-model.html"><a href="big-entropy-and-the-generalized-linear-model.html#session-info-8"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="counting-and-classification.html"><a href="counting-and-classification.html"><i class="fa fa-check"></i><b>10</b> Counting and Classification</a><ul>
<li class="chapter" data-level="10.1" data-path="counting-and-classification.html"><a href="counting-and-classification.html#binomial-regression"><i class="fa fa-check"></i><b>10.1</b> Binomial regression</a><ul>
<li class="chapter" data-level="10.1.1" data-path="counting-and-classification.html"><a href="counting-and-classification.html#logistic-regression-prosocial-chimpanzees."><i class="fa fa-check"></i><b>10.1.1</b> Logistic regression: Prosocial chimpanzees.</a></li>
<li class="chapter" data-level="10.1.2" data-path="counting-and-classification.html"><a href="counting-and-classification.html#aggregated-binomial-chimpanzees-again-condensed."><i class="fa fa-check"></i><b>10.1.2</b> Aggregated binomial: Chimpanzees again, condensed.</a></li>
<li class="chapter" data-level="10.1.3" data-path="counting-and-classification.html"><a href="counting-and-classification.html#aggregated-binomial-graduate-school-admissions."><i class="fa fa-check"></i><b>10.1.3</b> Aggregated binomial: Graduate school admissions.</a></li>
<li class="chapter" data-level="10.1.4" data-path="counting-and-classification.html"><a href="counting-and-classification.html#fitting-binomial-regressions-with-glm."><i class="fa fa-check"></i><b>10.1.4</b> Fitting binomial regressions with <code>glm()</code>.</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="counting-and-classification.html"><a href="counting-and-classification.html#poisson-regression"><i class="fa fa-check"></i><b>10.2</b> Poisson regression</a><ul>
<li class="chapter" data-level="10.2.1" data-path="counting-and-classification.html"><a href="counting-and-classification.html#example-oceanic-tool-complexity."><i class="fa fa-check"></i><b>10.2.1</b> Example: Oceanic tool complexity.</a></li>
<li class="chapter" data-level="10.2.2" data-path="counting-and-classification.html"><a href="counting-and-classification.html#mcmc-islands."><i class="fa fa-check"></i><b>10.2.2</b> MCMC islands.</a></li>
<li class="chapter" data-level="10.2.3" data-path="counting-and-classification.html"><a href="counting-and-classification.html#example-exposure-and-the-offset."><i class="fa fa-check"></i><b>10.2.3</b> Example: Exposure and the offset.</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="counting-and-classification.html"><a href="counting-and-classification.html#other-count-regressions"><i class="fa fa-check"></i><b>10.3</b> Other count regressions</a><ul>
<li class="chapter" data-level="10.3.1" data-path="counting-and-classification.html"><a href="counting-and-classification.html#multinomial."><i class="fa fa-check"></i><b>10.3.1</b> Multinomial.</a></li>
<li class="chapter" data-level="10.3.2" data-path="counting-and-classification.html"><a href="counting-and-classification.html#geometric."><i class="fa fa-check"></i><b>10.3.2</b> Geometric.</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="counting-and-classification.html"><a href="counting-and-classification.html#summary"><i class="fa fa-check"></i><b>10.4</b> Summary</a></li>
<li class="chapter" data-level="" data-path="counting-and-classification.html"><a href="counting-and-classification.html#session-info-9"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html"><i class="fa fa-check"></i><b>11</b> Monsters and Mixtures</a><ul>
<li class="chapter" data-level="11.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#ordered-categorical-outcomes"><i class="fa fa-check"></i><b>11.1</b> Ordered categorical outcomes</a><ul>
<li class="chapter" data-level="11.1.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-moral-intuition."><i class="fa fa-check"></i><b>11.1.1</b> Example: Moral intuition.</a></li>
<li class="chapter" data-level="11.1.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#describing-an-ordered-distribution-with-intercepts."><i class="fa fa-check"></i><b>11.1.2</b> Describing an ordered distribution with intercepts.</a></li>
<li class="chapter" data-level="11.1.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#adding-predictor-variables."><i class="fa fa-check"></i><b>11.1.3</b> Adding predictor variables.</a></li>
<li class="chapter" data-level="11.1.4" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#bonus-figure-11.3-alternative."><i class="fa fa-check"></i><b>11.1.4</b> Bonus: Figure 11.3 alternative.</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#zero-inflated-outcomes"><i class="fa fa-check"></i><b>11.2</b> Zero-inflated outcomes</a><ul>
<li class="chapter" data-level="11.2.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#example-zero-inflated-poisson."><i class="fa fa-check"></i><b>11.2.1</b> Example: Zero-inflated Poisson.</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersed-outcomes"><i class="fa fa-check"></i><b>11.3</b> Over-dispersed outcomes</a><ul>
<li class="chapter" data-level="11.3.1" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#beta-binomial."><i class="fa fa-check"></i><b>11.3.1</b> Beta-binomial.</a></li>
<li class="chapter" data-level="11.3.2" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#negative-binomial-or-gamma-poisson."><i class="fa fa-check"></i><b>11.3.2</b> Negative-binomial or gamma-Poisson.</a></li>
<li class="chapter" data-level="11.3.3" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#over-dispersion-entropy-and-information-criteria."><i class="fa fa-check"></i><b>11.3.3</b> Over-dispersion, entropy, and information criteria.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="monsters-and-mixtures.html"><a href="monsters-and-mixtures.html#session-info-10"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="multilevel-models.html"><a href="multilevel-models.html"><i class="fa fa-check"></i><b>12</b> Multilevel Models</a><ul>
<li class="chapter" data-level="12.1" data-path="multilevel-models.html"><a href="multilevel-models.html#example-multilevel-tadpoles"><i class="fa fa-check"></i><b>12.1</b> Example: Multilevel tadpoles</a></li>
<li class="chapter" data-level="12.2" data-path="multilevel-models.html"><a href="multilevel-models.html#varying-effects-and-the-underfittingoverfitting-trade-off"><i class="fa fa-check"></i><b>12.2</b> Varying effects and the underfitting/overfitting trade-off</a><ul>
<li class="chapter" data-level="12.2.1" data-path="multilevel-models.html"><a href="multilevel-models.html#the-model.-1"><i class="fa fa-check"></i><b>12.2.1</b> The model.</a></li>
<li class="chapter" data-level="12.2.2" data-path="multilevel-models.html"><a href="multilevel-models.html#assign-values-to-the-parameters."><i class="fa fa-check"></i><b>12.2.2</b> Assign values to the parameters.</a></li>
<li class="chapter" data-level="12.2.3" data-path="multilevel-models.html"><a href="multilevel-models.html#sumulate-survivors."><i class="fa fa-check"></i><b>12.2.3</b> Sumulate survivors.</a></li>
<li class="chapter" data-level="12.2.4" data-path="multilevel-models.html"><a href="multilevel-models.html#compute-the-no-pooling-estimates."><i class="fa fa-check"></i><b>12.2.4</b> Compute the no-pooling estimates.</a></li>
<li class="chapter" data-level="12.2.5" data-path="multilevel-models.html"><a href="multilevel-models.html#compute-the-partial-pooling-estimates."><i class="fa fa-check"></i><b>12.2.5</b> Compute the partial-pooling estimates.</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="multilevel-models.html"><a href="multilevel-models.html#more-than-one-type-of-cluster"><i class="fa fa-check"></i><b>12.3</b> More than one type of cluster</a><ul>
<li class="chapter" data-level="12.3.1" data-path="multilevel-models.html"><a href="multilevel-models.html#multilevel-chimpanzees."><i class="fa fa-check"></i><b>12.3.1</b> Multilevel chimpanzees.</a></li>
<li class="chapter" data-level="12.3.2" data-path="multilevel-models.html"><a href="multilevel-models.html#two-types-of-cluster."><i class="fa fa-check"></i><b>12.3.2</b> Two types of cluster.</a></li>
<li class="chapter" data-level="12.3.3" data-path="multilevel-models.html"><a href="multilevel-models.html#even-more-clusters."><i class="fa fa-check"></i><b>12.3.3</b> Even more clusters.</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="multilevel-models.html"><a href="multilevel-models.html#multilevel-posterior-predictions"><i class="fa fa-check"></i><b>12.4</b> Multilevel posterior predictions</a><ul>
<li class="chapter" data-level="12.4.1" data-path="multilevel-models.html"><a href="multilevel-models.html#posterior-prediction-for-same-clusters."><i class="fa fa-check"></i><b>12.4.1</b> Posterior prediction for same clusters.</a></li>
<li class="chapter" data-level="12.4.2" data-path="multilevel-models.html"><a href="multilevel-models.html#posterior-prediction-for-new-clusters."><i class="fa fa-check"></i><b>12.4.2</b> Posterior prediction for new clusters.</a></li>
<li class="chapter" data-level="12.4.3" data-path="multilevel-models.html"><a href="multilevel-models.html#focus-and-multilevel-prediction."><i class="fa fa-check"></i><b>12.4.3</b> Focus and multilevel prediction.</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="multilevel-models.html"><a href="multilevel-models.html#summary-bonus-put-your-random-effects-to-work"><i class="fa fa-check"></i><b>12.5</b> <del>Summary</del> Bonus: Put your random effects to work</a><ul>
<li class="chapter" data-level="12.5.1" data-path="multilevel-models.html"><a href="multilevel-models.html#intercepts-only-models-with-one-or-two-grouping-variables."><i class="fa fa-check"></i><b>12.5.1</b> Intercepts-only models with one or two grouping variables.</a></li>
<li class="chapter" data-level="12.5.2" data-path="multilevel-models.html"><a href="multilevel-models.html#brmsposterior_samples."><i class="fa fa-check"></i><b>12.5.2</b> <code>brms::posterior_samples()</code>.</a></li>
<li class="chapter" data-level="12.5.3" data-path="multilevel-models.html"><a href="multilevel-models.html#brmscoef."><i class="fa fa-check"></i><b>12.5.3</b> <code>brms::coef()</code>.</a></li>
<li class="chapter" data-level="12.5.4" data-path="multilevel-models.html"><a href="multilevel-models.html#brmsfitted."><i class="fa fa-check"></i><b>12.5.4</b> <code>brms::fitted()</code>.</a></li>
<li class="chapter" data-level="12.5.5" data-path="multilevel-models.html"><a href="multilevel-models.html#tidybayesspread_draws."><i class="fa fa-check"></i><b>12.5.5</b> <code>tidybayes::spread_draws()</code>.</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="multilevel-models.html"><a href="multilevel-models.html#session-info-11"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html"><i class="fa fa-check"></i><b>13</b> Adventures in Covariance</a><ul>
<li class="chapter" data-level="13.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#varying-slopes-by-construction"><i class="fa fa-check"></i><b>13.1</b> Varying slopes by construction</a><ul>
<li class="chapter" data-level="13.1.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-the-population."><i class="fa fa-check"></i><b>13.1.1</b> Simulate the population.</a></li>
<li class="chapter" data-level="13.1.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#simulate-observations."><i class="fa fa-check"></i><b>13.1.2</b> Simulate observations.</a></li>
<li class="chapter" data-level="13.1.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#the-varying-slopes-model."><i class="fa fa-check"></i><b>13.1.3</b> The varying slopes model.</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-admission-decisions-and-gender"><i class="fa fa-check"></i><b>13.2</b> Example: Admission decisions and gender</a><ul>
<li class="chapter" data-level="13.2.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#varying-intercepts."><i class="fa fa-check"></i><b>13.2.1</b> Varying intercepts.</a></li>
<li class="chapter" data-level="13.2.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#varying-effects-of-being-male."><i class="fa fa-check"></i><b>13.2.2</b> Varying effects of being <code>male</code>.</a></li>
<li class="chapter" data-level="13.2.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#shrinkage."><i class="fa fa-check"></i><b>13.2.3</b> Shrinkage.</a></li>
<li class="chapter" data-level="13.2.4" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#model-comparison.-1"><i class="fa fa-check"></i><b>13.2.4</b> Model comparison.</a></li>
<li class="chapter" data-level="13.2.5" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#more-slopes."><i class="fa fa-check"></i><b>13.2.5</b> More slopes.</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-cross-classified-chimpanzees-with-varying-slopes"><i class="fa fa-check"></i><b>13.3</b> Example: Cross-classified <code>chimpanzees</code> with varying slopes</a></li>
<li class="chapter" data-level="13.4" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#continuous-categories-and-the-gaussian-process"><i class="fa fa-check"></i><b>13.4</b> Continuous categories and the Gaussian process</a><ul>
<li class="chapter" data-level="13.4.1" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#example-spatial-autocorrelation-in-oceanic-tools."><i class="fa fa-check"></i><b>13.4.1</b> Example: Spatial autocorrelation in Oceanic tools.</a></li>
<li class="chapter" data-level="13.4.2" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#other-kinds-of-distance."><i class="fa fa-check"></i><b>13.4.2</b> Other kinds of “distance”.</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#summary-bonus-another-berkley-admissions-data-like-example."><i class="fa fa-check"></i><b>13.5</b> <del>Summary</del> Bonus: Another Berkley-admissions-data-like example.</a></li>
<li class="chapter" data-level="" data-path="adventures-in-covariance.html"><a href="adventures-in-covariance.html#session-info-12"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html"><i class="fa fa-check"></i><b>14</b> Missing Data and Other Opportunities</a><ul>
<li class="chapter" data-level="14.1" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#measurement-error"><i class="fa fa-check"></i><b>14.1</b> Measurement error</a><ul>
<li class="chapter" data-level="14.1.1" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#error-on-the-outcome."><i class="fa fa-check"></i><b>14.1.1</b> Error on the outcome.</a></li>
<li class="chapter" data-level="14.1.2" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#error-on-both-outcome-and-predictor."><i class="fa fa-check"></i><b>14.1.2</b> Error on both outcome and predictor.</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#missing-data"><i class="fa fa-check"></i><b>14.2</b> Missing data</a><ul>
<li class="chapter" data-level="14.2.1" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#imputing-neocortex"><i class="fa fa-check"></i><b>14.2.1</b> Imputing <code>neocortex</code></a></li>
<li class="chapter" data-level="14.2.2" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#improving-the-imputation-model"><i class="fa fa-check"></i><b>14.2.2</b> Improving the imputation model</a></li>
<li class="chapter" data-level="14.2.3" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#bonus-mi-can-replace-me"><i class="fa fa-check"></i><b>14.2.3</b> Bonus: <code>mi()</code> can replace <code>me()</code></a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#summary-bonus-meta-analysis"><i class="fa fa-check"></i><b>14.3</b> <del>Summary</del> Bonus: Meta-analysis</a></li>
<li class="chapter" data-level="" data-path="missing-data-and-other-opportunities.html"><a href="missing-data-and-other-opportunities.html#session-info-13"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html"><i class="fa fa-check"></i><b>15</b> <del>Horoscopes</del> Insights</a><ul>
<li class="chapter" data-level="15.1" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#use-r-notebooks"><i class="fa fa-check"></i><b>15.1</b> Use R Notebooks</a></li>
<li class="chapter" data-level="15.2" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#save-your-model-fits"><i class="fa fa-check"></i><b>15.2</b> Save your model fits</a></li>
<li class="chapter" data-level="15.3" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#build-your-models-slowly"><i class="fa fa-check"></i><b>15.3</b> Build your models slowly</a></li>
<li class="chapter" data-level="15.4" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#look-at-your-data"><i class="fa fa-check"></i><b>15.4</b> Look at your data</a></li>
<li class="chapter" data-level="15.5" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#use-the-0-intercept-syntax"><i class="fa fa-check"></i><b>15.5</b> Use the <code>0 + Intercept</code> syntax</a></li>
<li class="chapter" data-level="15.6" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#annotate-your-workflow"><i class="fa fa-check"></i><b>15.6</b> Annotate your workflow</a></li>
<li class="chapter" data-level="15.7" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#annotate-your-code"><i class="fa fa-check"></i><b>15.7</b> Annotate your code</a></li>
<li class="chapter" data-level="15.8" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#break-up-your-workflow"><i class="fa fa-check"></i><b>15.8</b> Break up your workflow</a></li>
<li class="chapter" data-level="15.9" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#code-in-public"><i class="fa fa-check"></i><b>15.9</b> Code in public</a></li>
<li class="chapter" data-level="15.10" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#read-gelmans-blog"><i class="fa fa-check"></i><b>15.10</b> Read Gelman’s blog</a></li>
<li class="chapter" data-level="15.11" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#check-out-other-social-media-too"><i class="fa fa-check"></i><b>15.11</b> Check out other social media, too</a></li>
<li class="chapter" data-level="15.12" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#parting-wisdom"><i class="fa fa-check"></i><b>15.12</b> Parting wisdom</a></li>
<li class="chapter" data-level="" data-path="horoscopes-insights.html"><a href="horoscopes-insights.html#session-info-14"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"><em>Statistical rethinking</em> with brms, ggplot2, and the tidyverse</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="adventures-in-covariance" class="section level1">
<h1><span class="header-section-number">13</span> Adventures in Covariance</h1>
<blockquote>
<p>In this chapter, you’ll see how to… specify <strong>varying slopes</strong> in combination with the varying intercepts of the previous chapter. This will enable pooling that will improve estimates of how different units respond to or are influenced by predictor variables. It will also improve estimates of intercepts, by borrowing information across parameter types. Essentially, varying slopes models are massive interaction machines. They allow every unit in the data to have its own unique response to any treatment or exposure or event, while also improving estimates via pooling. When the variation in slopes is large, the average slope is of less interest. Sometimes, the pattern of variation in slopes provides hints about omitted variables that explain why some units respond more or less. We’ll see an example in this chapter.</p>
<p>The machinery that makes such complex varying effects possible will be used later in the chapter to extend the varying effects strategy to more subtle model types, including the use of continuous categories, using <strong>Gaussian process</strong>. <span class="citation">(McElreath, <a href="#ref-mcelreathStatisticalRethinkingBayesian2015" role="doc-biblioref">2015</a>, p. 388, <strong>emphasis</strong> in the original)</span></p>
</blockquote>
<div id="varying-slopes-by-construction" class="section level2">
<h2><span class="header-section-number">13.1</span> Varying slopes by construction</h2>
<blockquote>
<p>How should the robot pool information across intercepts and slopes? By modeling the joint population of intercepts and slopes, which means by modeling their covariance. In conventional multilevel models, the device that makes this possible is a joint multivariate Gaussian distribution for all of the varying effects, both intercepts and slopes. So instead of having two independent Gaussian distributions of intercepts and of slopes, the robot can do better by assigning a two-dimensional Gaussian distribution to both the intercepts (first dimension) and the slopes (second dimension). (p. 389)</p>
</blockquote>
<div id="rethinking-why-gaussian" class="section level4">
<h4><span class="header-section-number">13.1.0.1</span> Rethinking: Why Gaussian?</h4>
<p>McElreath discussed how researchers might use other multivariate distributions to model multiple random effects. The only one he named as an alternative to the Gaussian was the multivariate Student’s <span class="math inline">\(t\)</span>. As it turns out, brms does currently allow users to use multivariate Student’s <span class="math inline">\(t\)</span> in this way. For details, check out <a href="https://github.com/paul-buerkner/brms/issues/231">this discussion from the brms GitHub repository</a>. Bürkner’s exemplar syntax from his comment on May 13, 2018, was <code>y ~ x + (x | gr(g, dist = "student"))</code>. I haven’t experimented with this, but if you do, do consider <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse/issues">sharing how it went</a>.</p>
</div>
<div id="simulate-the-population." class="section level3">
<h3><span class="header-section-number">13.1.1</span> Simulate the population.</h3>
<p>If you follow this section closely, it’s a great template for simulating multilevel code for any of your future projects. You might think of this as an alternative to a frequentist power analysis. Vourre has done <a href="https://gitlab.com/vuorre/bayesplan">some nice work along these lines</a>, I have a <a href="https://solomonkurz.netlify.com/post/bayesian-power-analysis-part-i/">blog series</a> on Bayesian power analysis, and Kruschke covered the topic in Chapter 13 of his <span class="citation">(<a href="#ref-kruschkeDoingBayesianData2015" role="doc-biblioref">2015</a>)</span> <a href="https://sites.google.com/site/doingbayesiandataanalysis/">text</a>.</p>
<div class="sourceCode" id="cb1431"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1431-1"><a href="adventures-in-covariance.html#cb1431-1"></a>a       &lt;-<span class="st">  </span><span class="fl">3.5</span>  <span class="co"># average morning wait time</span></span>
<span id="cb1431-2"><a href="adventures-in-covariance.html#cb1431-2"></a>b       &lt;-<span class="st"> </span><span class="dv">-1</span>    <span class="co"># average difference afternoon wait time</span></span>
<span id="cb1431-3"><a href="adventures-in-covariance.html#cb1431-3"></a>sigma_a &lt;-<span class="st">  </span><span class="dv">1</span>    <span class="co"># std dev in intercepts</span></span>
<span id="cb1431-4"><a href="adventures-in-covariance.html#cb1431-4"></a>sigma_b &lt;-<span class="st">  </span><span class="fl">0.5</span>  <span class="co"># std dev in slopes</span></span>
<span id="cb1431-5"><a href="adventures-in-covariance.html#cb1431-5"></a>rho     &lt;-<span class="st"> </span><span class="fl">-.7</span>   <span class="co"># correlation between intercepts and slopes</span></span>
<span id="cb1431-6"><a href="adventures-in-covariance.html#cb1431-6"></a></span>
<span id="cb1431-7"><a href="adventures-in-covariance.html#cb1431-7"></a><span class="co"># the next three lines of code simply combine the terms, above</span></span>
<span id="cb1431-8"><a href="adventures-in-covariance.html#cb1431-8"></a>mu     &lt;-<span class="st"> </span><span class="kw">c</span>(a, b)</span>
<span id="cb1431-9"><a href="adventures-in-covariance.html#cb1431-9"></a>cov_ab &lt;-<span class="st"> </span>sigma_a <span class="op">*</span><span class="st"> </span>sigma_b <span class="op">*</span><span class="st"> </span>rho</span>
<span id="cb1431-10"><a href="adventures-in-covariance.html#cb1431-10"></a>sigma  &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(sigma_a<span class="op">^</span><span class="dv">2</span>, cov_ab, </span>
<span id="cb1431-11"><a href="adventures-in-covariance.html#cb1431-11"></a>                   cov_ab, sigma_b<span class="op">^</span><span class="dv">2</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p>If you haven’t used <code>matirx()</code> before, you might get a sense of the elements like so.</p>
<div class="sourceCode" id="cb1432"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1432-1"><a href="adventures-in-covariance.html#cb1432-1"></a><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, </span>
<span id="cb1432-2"><a href="adventures-in-covariance.html#cb1432-2"></a>         <span class="dv">3</span>, <span class="dv">4</span>), <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>##      [,1] [,2]
## [1,]    1    3
## [2,]    2    4</code></pre>
<p>This next block of code will finally yield our café data.</p>
<div class="sourceCode" id="cb1434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1434-1"><a href="adventures-in-covariance.html#cb1434-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb1434-2"><a href="adventures-in-covariance.html#cb1434-2"></a></span>
<span id="cb1434-3"><a href="adventures-in-covariance.html#cb1434-3"></a>sigmas &lt;-<span class="st"> </span><span class="kw">c</span>(sigma_a, sigma_b)          <span class="co"># standard deviations</span></span>
<span id="cb1434-4"><a href="adventures-in-covariance.html#cb1434-4"></a>rho    &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, rho,             <span class="co"># correlation matrix</span></span>
<span id="cb1434-5"><a href="adventures-in-covariance.html#cb1434-5"></a>                   rho, <span class="dv">1</span>), <span class="dt">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb1434-6"><a href="adventures-in-covariance.html#cb1434-6"></a></span>
<span id="cb1434-7"><a href="adventures-in-covariance.html#cb1434-7"></a><span class="co"># now matrix multiply to get covariance matrix</span></span>
<span id="cb1434-8"><a href="adventures-in-covariance.html#cb1434-8"></a>sigma &lt;-<span class="st"> </span><span class="kw">diag</span>(sigmas) <span class="op">%*%</span><span class="st"> </span>rho <span class="op">%*%</span><span class="st"> </span><span class="kw">diag</span>(sigmas)</span>
<span id="cb1434-9"><a href="adventures-in-covariance.html#cb1434-9"></a></span>
<span id="cb1434-10"><a href="adventures-in-covariance.html#cb1434-10"></a><span class="co"># how many cafes would you like?</span></span>
<span id="cb1434-11"><a href="adventures-in-covariance.html#cb1434-11"></a>n_cafes &lt;-<span class="st"> </span><span class="dv">20</span></span>
<span id="cb1434-12"><a href="adventures-in-covariance.html#cb1434-12"></a></span>
<span id="cb1434-13"><a href="adventures-in-covariance.html#cb1434-13"></a><span class="kw">set.seed</span>(<span class="dv">13</span>)  <span class="co"># used to replicate example</span></span>
<span id="cb1434-14"><a href="adventures-in-covariance.html#cb1434-14"></a>vary_effects &lt;-<span class="st"> </span></span>
<span id="cb1434-15"><a href="adventures-in-covariance.html#cb1434-15"></a><span class="st">  </span>MASS<span class="op">::</span><span class="kw">mvrnorm</span>(n_cafes, mu, sigma) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1434-16"><a href="adventures-in-covariance.html#cb1434-16"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1434-17"><a href="adventures-in-covariance.html#cb1434-17"></a><span class="st">  </span><span class="kw">set_names</span>(<span class="st">&quot;a_cafe&quot;</span>, <span class="st">&quot;b_cafe&quot;</span>)</span>
<span id="cb1434-18"><a href="adventures-in-covariance.html#cb1434-18"></a></span>
<span id="cb1434-19"><a href="adventures-in-covariance.html#cb1434-19"></a><span class="kw">head</span>(vary_effects)</span></code></pre></div>
<pre><code>##     a_cafe     b_cafe
## 1 2.917639 -0.8649154
## 2 3.552770 -1.6814372
## 3 1.694390 -0.4168858
## 4 3.442417 -0.6011724
## 5 2.289988 -0.7461953
## 6 3.069283 -0.8839639</code></pre>
<p>Let’s make sure we’re keeping this all straight. <code>a_cafe</code> = our café-specific intercepts; <code>b_cafe</code> = our café-specific slopes. These aren’t the actual data, yet. But at this stage, it might make sense to ask <em>What’s the distribution of <code>a_cafe</code> and <code>b_cafe</code>?</em> Our variant of Figure 13.2 contains the answer.</p>
<p>For our plots in this chapter, we’ll make our own custom ggplot2 theme. The color palette will come from the “pearl_earring” palette of the <a href="https://github.com/EdwinTh/dutchmasters">dutchmasters package</a> <span class="citation">(Thoen, <a href="#ref-R-dutchmasters" role="doc-biblioref">2019</a>)</span>. You can learn more about the original painting, Vermeer’s <span class="citation">(<a href="#ref-vermeerGirlPearlEarring1665" role="doc-biblioref">1665</a>)</span> <em>Girl with a Pearl Earring</em>, <a href="https://en.wikipedia.org/wiki/Girl_with_a_Pearl_Earring">here</a>.</p>
<div class="sourceCode" id="cb1436"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1436-1"><a href="adventures-in-covariance.html#cb1436-1"></a><span class="co"># devtools::install_github(&quot;EdwinTh/dutchmasters&quot;)</span></span>
<span id="cb1436-2"><a href="adventures-in-covariance.html#cb1436-2"></a><span class="kw">library</span>(dutchmasters)</span>
<span id="cb1436-3"><a href="adventures-in-covariance.html#cb1436-3"></a></span>
<span id="cb1436-4"><a href="adventures-in-covariance.html#cb1436-4"></a>dutchmasters<span class="op">$</span>pearl_earring</span></code></pre></div>
<pre><code>##         red(lips)              skin      blue(scarf1)      blue(scarf2)      white(colar) 
##         &quot;#A65141&quot;         &quot;#E7CDC2&quot;         &quot;#80A0C7&quot;         &quot;#394165&quot;         &quot;#FCF9F0&quot; 
##       gold(dress)      gold(dress2) black(background)      grey(scarf3)    yellow(scarf4) 
##         &quot;#B1934A&quot;         &quot;#DCA258&quot;         &quot;#100F14&quot;         &quot;#8B9DAF&quot;         &quot;#EEDA9D&quot; 
##                   
##         &quot;#E8DCCF&quot;</code></pre>
<p>We’ll name our custom theme <code>theme_pearl_earring()</code>. I cobbled together this approach to defining a custom ggplot2 theme with help from <a href="https://ggplot2-book.org/programming.html">Chapter 17</a> of Wichkam’s <span class="citation">(<a href="#ref-wickhamGgplot2ElegantGraphics2016" role="doc-biblioref">2016</a>)</span> <em>ggplot2: Elegant graphics for data analysis</em>; <a href="https://bookdown.org/rdpeng/RProgDA/building-a-new-theme.html">Section 4.6</a> of Peng, Kross, and Anderson’s <span class="citation">(<a href="#ref-pengMasteringSoftwareDevelopment2017" role="doc-biblioref">2017</a>)</span> <a href="https://bookdown.org/rdpeng/RProgDA/building-a-new-theme.html"><em>Mastering Software Development in R</em></a>; Lea Waniek’s blog post, <a href="https://www.statworx.com/de/blog/custom-themes-in-ggplot2/"><em>Custom themes in ggplot2</em></a>, and Joey Stanley’s blog post of the same name, <a href="https://joeystanley.com/blog/custom-themes-in-ggplot2"><em>Custom themes in ggplot2</em></a>.</p>
<div class="sourceCode" id="cb1438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1438-1"><a href="adventures-in-covariance.html#cb1438-1"></a>theme_pearl_earring &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">light_color =</span> <span class="st">&quot;#E8DCCF&quot;</span>, </span>
<span id="cb1438-2"><a href="adventures-in-covariance.html#cb1438-2"></a>                                <span class="dt">dark_color =</span> <span class="st">&quot;#100F14&quot;</span>, </span>
<span id="cb1438-3"><a href="adventures-in-covariance.html#cb1438-3"></a>                                <span class="dt">my_family =</span> <span class="st">&quot;Courier&quot;</span>,</span>
<span id="cb1438-4"><a href="adventures-in-covariance.html#cb1438-4"></a>                                ...) {</span>
<span id="cb1438-5"><a href="adventures-in-covariance.html#cb1438-5"></a>  </span>
<span id="cb1438-6"><a href="adventures-in-covariance.html#cb1438-6"></a>  <span class="kw">theme</span>(<span class="dt">line =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> light_color),</span>
<span id="cb1438-7"><a href="adventures-in-covariance.html#cb1438-7"></a>        <span class="dt">text =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> light_color, <span class="dt">family =</span> my_family),</span>
<span id="cb1438-8"><a href="adventures-in-covariance.html#cb1438-8"></a>        <span class="dt">strip.text =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> light_color, <span class="dt">family =</span> my_family),</span>
<span id="cb1438-9"><a href="adventures-in-covariance.html#cb1438-9"></a>        <span class="dt">axis.text =</span> <span class="kw">element_text</span>(<span class="dt">color =</span> light_color),</span>
<span id="cb1438-10"><a href="adventures-in-covariance.html#cb1438-10"></a>        <span class="dt">axis.ticks =</span> <span class="kw">element_line</span>(<span class="dt">color =</span> light_color),</span>
<span id="cb1438-11"><a href="adventures-in-covariance.html#cb1438-11"></a>        <span class="dt">axis.line =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb1438-12"><a href="adventures-in-covariance.html#cb1438-12"></a>        <span class="dt">legend.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>),</span>
<span id="cb1438-13"><a href="adventures-in-covariance.html#cb1438-13"></a>        <span class="dt">legend.key =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>),</span>
<span id="cb1438-14"><a href="adventures-in-covariance.html#cb1438-14"></a>        <span class="dt">panel.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> light_color),</span>
<span id="cb1438-15"><a href="adventures-in-covariance.html#cb1438-15"></a>        <span class="dt">panel.grid =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb1438-16"><a href="adventures-in-covariance.html#cb1438-16"></a>        <span class="dt">plot.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> dark_color),</span>
<span id="cb1438-17"><a href="adventures-in-covariance.html#cb1438-17"></a>        <span class="dt">strip.background =</span> <span class="kw">element_rect</span>(<span class="dt">fill =</span> dark_color, <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>),</span>
<span id="cb1438-18"><a href="adventures-in-covariance.html#cb1438-18"></a>        ...)</span>
<span id="cb1438-19"><a href="adventures-in-covariance.html#cb1438-19"></a>  </span>
<span id="cb1438-20"><a href="adventures-in-covariance.html#cb1438-20"></a>}</span></code></pre></div>
<p>Note how our custom <code>theme_pearl_earing()</code> function has a few adjustable parameters. Feel free to play around with alternative settings to see how they work. If we just use the defaults as we have defined them, here is our Figure 13.2.</p>
<div class="sourceCode" id="cb1439"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1439-1"><a href="adventures-in-covariance.html#cb1439-1"></a>vary_effects <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1439-2"><a href="adventures-in-covariance.html#cb1439-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> a_cafe, <span class="dt">y =</span> b_cafe)) <span class="op">+</span></span>
<span id="cb1439-3"><a href="adventures-in-covariance.html#cb1439-3"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></span>
<span id="cb1439-4"><a href="adventures-in-covariance.html#cb1439-4"></a><span class="st">  </span><span class="kw">geom_rug</span>(<span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">7</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb1439-5"><a href="adventures-in-covariance.html#cb1439-5"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-7-1.png" width="312" /></p>
<p>Again, these are not “data.” Figure 13.2 shows a distribution of <em>parameters</em>. Here’s their Pearson’s correlation coefficient.</p>
<div class="sourceCode" id="cb1440"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1440-1"><a href="adventures-in-covariance.html#cb1440-1"></a><span class="kw">cor</span>(vary_effects<span class="op">$</span>a_cafe, vary_effects<span class="op">$</span>b_cafe)</span></code></pre></div>
<pre><code>## [1] -0.7281604</code></pre>
</div>
<div id="simulate-observations." class="section level3">
<h3><span class="header-section-number">13.1.2</span> Simulate observations.</h3>
<p>Here we put those simulated parameters to use and simulate actual data from them.</p>
<div class="sourceCode" id="cb1442"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1442-1"><a href="adventures-in-covariance.html#cb1442-1"></a>n_visits &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb1442-2"><a href="adventures-in-covariance.html#cb1442-2"></a>sigma    &lt;-<span class="st">  </span><span class="fl">0.5</span>  <span class="co"># std dev within cafes</span></span>
<span id="cb1442-3"><a href="adventures-in-covariance.html#cb1442-3"></a></span>
<span id="cb1442-4"><a href="adventures-in-covariance.html#cb1442-4"></a><span class="kw">set.seed</span>(<span class="dv">13</span>)  <span class="co"># used to replicate example</span></span>
<span id="cb1442-5"><a href="adventures-in-covariance.html#cb1442-5"></a>d &lt;-</span>
<span id="cb1442-6"><a href="adventures-in-covariance.html#cb1442-6"></a><span class="st">  </span>vary_effects <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1442-7"><a href="adventures-in-covariance.html#cb1442-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cafe =</span> <span class="dv">1</span><span class="op">:</span>n_cafes) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1442-8"><a href="adventures-in-covariance.html#cb1442-8"></a><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(cafe, a_cafe, b_cafe), <span class="dt">visit =</span> <span class="dv">1</span><span class="op">:</span>n_visits) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1442-9"><a href="adventures-in-covariance.html#cb1442-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">rep</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">times =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1442-10"><a href="adventures-in-covariance.html#cb1442-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mu =</span> a_cafe <span class="op">+</span><span class="st"> </span>b_cafe <span class="op">*</span><span class="st"> </span>afternoon) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1442-11"><a href="adventures-in-covariance.html#cb1442-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">wait =</span> <span class="kw">rnorm</span>(<span class="dt">n =</span> <span class="kw">n</span>(), <span class="dt">mean =</span> mu, <span class="dt">sd =</span> sigma))</span></code></pre></div>
<p>We might peek at the data.</p>
<div class="sourceCode" id="cb1443"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1443-1"><a href="adventures-in-covariance.html#cb1443-1"></a>d <span class="op">%&gt;%</span></span>
<span id="cb1443-2"><a href="adventures-in-covariance.html#cb1443-2"></a><span class="st">  </span><span class="kw">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 x 7
##    cafe a_cafe b_cafe visit afternoon    mu  wait
##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1   2.92 -0.865     1         0  2.92  3.19
## 2     1   2.92 -0.865     2         1  2.05  1.91
## 3     1   2.92 -0.865     3         0  2.92  3.81
## 4     1   2.92 -0.865     4         1  2.05  2.15
## 5     1   2.92 -0.865     5         0  2.92  3.49
## 6     1   2.92 -0.865     6         1  2.05  2.26</code></pre>
<p>Now we’ve finally simulated our data, we are ready to make our version of Figure 13.1, from way back on page 388.</p>
<div class="sourceCode" id="cb1445"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1445-1"><a href="adventures-in-covariance.html#cb1445-1"></a>d <span class="op">%&gt;%</span></span>
<span id="cb1445-2"><a href="adventures-in-covariance.html#cb1445-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">ifelse</span>(afternoon <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;M&quot;</span>, <span class="st">&quot;A&quot;</span>),</span>
<span id="cb1445-3"><a href="adventures-in-covariance.html#cb1445-3"></a>         <span class="dt">day       =</span> <span class="kw">rep</span>(<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">each =</span> <span class="dv">2</span>), <span class="dt">times =</span> n_cafes)) <span class="op">%&gt;%</span></span>
<span id="cb1445-4"><a href="adventures-in-covariance.html#cb1445-4"></a><span class="st">  </span><span class="kw">filter</span>(cafe <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">5</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1445-5"><a href="adventures-in-covariance.html#cb1445-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cafe =</span> <span class="kw">ifelse</span>(cafe <span class="op">==</span><span class="st"> </span><span class="dv">3</span>, <span class="st">&quot;cafe #3&quot;</span>, <span class="st">&quot;cafe #5&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1445-6"><a href="adventures-in-covariance.html#cb1445-6"></a><span class="st">  </span></span>
<span id="cb1445-7"><a href="adventures-in-covariance.html#cb1445-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> visit, <span class="dt">y =</span> wait, <span class="dt">group =</span> day)) <span class="op">+</span></span>
<span id="cb1445-8"><a href="adventures-in-covariance.html#cb1445-8"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> afternoon), <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1445-9"><a href="adventures-in-covariance.html#cb1445-9"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></span>
<span id="cb1445-10"><a href="adventures-in-covariance.html#cb1445-10"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#EEDA9D&quot;</span>)) <span class="op">+</span></span>
<span id="cb1445-11"><a href="adventures-in-covariance.html#cb1445-11"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,</span>
<span id="cb1445-12"><a href="adventures-in-covariance.html#cb1445-12"></a>                     <span class="dt">labels =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;M&quot;</span>, <span class="st">&quot;A&quot;</span>), <span class="dt">times =</span> <span class="dv">5</span>)) <span class="op">+</span></span>
<span id="cb1445-13"><a href="adventures-in-covariance.html#cb1445-13"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;wait time in minutes&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">4</span>)) <span class="op">+</span></span>
<span id="cb1445-14"><a href="adventures-in-covariance.html#cb1445-14"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.ticks.x =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb1445-15"><a href="adventures-in-covariance.html#cb1445-15"></a>                      <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></span>
<span id="cb1445-16"><a href="adventures-in-covariance.html#cb1445-16"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>cafe, <span class="dt">ncol =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-11-1.png" width="336" /></p>
</div>
<div id="the-varying-slopes-model." class="section level3">
<h3><span class="header-section-number">13.1.3</span> The varying slopes model.</h3>
<p>The statistical formula for our varying-slopes model follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{wait}_i &amp; \sim \operatorname{Normal}(\mu_i, \sigma) \\
\mu_i         &amp; = \alpha_{\text{cafe}_i} + \beta_{\text{cafe}_i} \text{afternoon}_i \\
\begin{bmatrix} \alpha_\text{cafe} \\ \beta_\text{cafe} \end{bmatrix} &amp; \sim \text{MVNormal} \left (\begin{bmatrix} \alpha \\ \beta \end{bmatrix}, \mathbf{S}  \right ) \\
\mathbf S     &amp; = \begin{bmatrix} \sigma_\alpha &amp; 0 \\ 0 &amp; \sigma_\beta \end{bmatrix} \mathbf R \begin{bmatrix} \sigma_\alpha &amp; 0 \\ 0 &amp; \sigma_\beta \end{bmatrix} \\
\alpha        &amp; \sim \operatorname{Normal}(0, 10) \\
\beta         &amp; \sim \operatorname{Normal}(0, 10) \\
\sigma        &amp; \sim \operatorname{HalfCauchy}(0, 1) \\
\sigma_\alpha &amp; \sim \operatorname{HalfCauchy}(0, 1) \\
\sigma_\beta  &amp; \sim \operatorname{HalfCauchy}(0, 1) \\
\mathbf R     &amp; \sim \operatorname{LKJcorr}(2),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\mathbf S\)</span> is the covariance matrix and <span class="math inline">\(\mathbf R\)</span> is the corresponding correlation matrix, which we might more fully express as</p>
<p><span class="math display">\[\begin{bmatrix} 1 &amp; \rho \\ \rho &amp; 1 \end{bmatrix}.\]</span></p>
<p>And according to our prior, <span class="math inline">\(\mathbf R\)</span> is distributed as <span class="math inline">\(\operatorname{LKJcorr}(2)\)</span>. We’ll use <code>rethinking::rlkjcorr()</code> to get a better sense of what that even is.</p>
<div class="sourceCode" id="cb1446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1446-1"><a href="adventures-in-covariance.html#cb1446-1"></a><span class="kw">library</span>(rethinking)</span>
<span id="cb1446-2"><a href="adventures-in-covariance.html#cb1446-2"></a></span>
<span id="cb1446-3"><a href="adventures-in-covariance.html#cb1446-3"></a>n_sim &lt;-<span class="st"> </span><span class="fl">1e5</span></span>
<span id="cb1446-4"><a href="adventures-in-covariance.html#cb1446-4"></a></span>
<span id="cb1446-5"><a href="adventures-in-covariance.html#cb1446-5"></a><span class="kw">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb1446-6"><a href="adventures-in-covariance.html#cb1446-6"></a>r_<span class="dv">1</span> &lt;-<span class="st"> </span></span>
<span id="cb1446-7"><a href="adventures-in-covariance.html#cb1446-7"></a><span class="st">  </span><span class="kw">rlkjcorr</span>(n_sim, <span class="dt">K =</span> <span class="dv">2</span>, <span class="dt">eta =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb1446-8"><a href="adventures-in-covariance.html#cb1446-8"></a><span class="st">  </span><span class="kw">as_tibble</span>()</span>
<span id="cb1446-9"><a href="adventures-in-covariance.html#cb1446-9"></a></span>
<span id="cb1446-10"><a href="adventures-in-covariance.html#cb1446-10"></a><span class="kw">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb1446-11"><a href="adventures-in-covariance.html#cb1446-11"></a>r_<span class="dv">2</span> &lt;-<span class="st"> </span></span>
<span id="cb1446-12"><a href="adventures-in-covariance.html#cb1446-12"></a><span class="st">  </span><span class="kw">rlkjcorr</span>(n_sim, <span class="dt">K =</span> <span class="dv">2</span>, <span class="dt">eta =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span></span>
<span id="cb1446-13"><a href="adventures-in-covariance.html#cb1446-13"></a><span class="st">  </span><span class="kw">as_tibble</span>()</span>
<span id="cb1446-14"><a href="adventures-in-covariance.html#cb1446-14"></a></span>
<span id="cb1446-15"><a href="adventures-in-covariance.html#cb1446-15"></a><span class="kw">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb1446-16"><a href="adventures-in-covariance.html#cb1446-16"></a>r_<span class="dv">4</span> &lt;-<span class="st"> </span></span>
<span id="cb1446-17"><a href="adventures-in-covariance.html#cb1446-17"></a><span class="st">  </span><span class="kw">rlkjcorr</span>(n_sim, <span class="dt">K =</span> <span class="dv">2</span>, <span class="dt">eta =</span> <span class="dv">4</span>) <span class="op">%&gt;%</span></span>
<span id="cb1446-18"><a href="adventures-in-covariance.html#cb1446-18"></a><span class="st">  </span><span class="kw">as_tibble</span>()</span></code></pre></div>
<p>Here are the <span class="math inline">\(\operatorname{LKJcorr}\)</span> distributions of Figure 13.3.</p>
<div class="sourceCode" id="cb1447"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1447-1"><a href="adventures-in-covariance.html#cb1447-1"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> r_<span class="dv">1</span>, <span class="kw">aes</span>(<span class="dt">x =</span> V2)) <span class="op">+</span></span>
<span id="cb1447-2"><a href="adventures-in-covariance.html#cb1447-2"></a><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#DCA258&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></span>
<span id="cb1447-3"><a href="adventures-in-covariance.html#cb1447-3"></a><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">data =</span> r_<span class="dv">2</span>,</span>
<span id="cb1447-4"><a href="adventures-in-covariance.html#cb1447-4"></a>               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></span>
<span id="cb1447-5"><a href="adventures-in-covariance.html#cb1447-5"></a><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">data =</span> r_<span class="dv">4</span>,</span>
<span id="cb1447-6"><a href="adventures-in-covariance.html#cb1447-6"></a>               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></span>
<span id="cb1447-7"><a href="adventures-in-covariance.html#cb1447-7"></a><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">tibble</span>(<span class="dt">x     =</span> <span class="kw">c</span>(.<span class="dv">83</span>, <span class="fl">.62</span>, <span class="fl">.46</span>),</span>
<span id="cb1447-8"><a href="adventures-in-covariance.html#cb1447-8"></a>                          <span class="dt">y     =</span> <span class="kw">c</span>(.<span class="dv">54</span>, <span class="fl">.74</span>, <span class="dv">1</span>),</span>
<span id="cb1447-9"><a href="adventures-in-covariance.html#cb1447-9"></a>                          <span class="dt">label =</span> <span class="kw">c</span>(<span class="st">&quot;eta = 1&quot;</span>, <span class="st">&quot;eta = 2&quot;</span>, <span class="st">&quot;eta = 4&quot;</span>)),</span>
<span id="cb1447-10"><a href="adventures-in-covariance.html#cb1447-10"></a>            <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> label),</span>
<span id="cb1447-11"><a href="adventures-in-covariance.html#cb1447-11"></a>            <span class="dt">color =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></span>
<span id="cb1447-12"><a href="adventures-in-covariance.html#cb1447-12"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1447-13"><a href="adventures-in-covariance.html#cb1447-13"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;correlation&quot;</span>) <span class="op">+</span></span>
<span id="cb1447-14"><a href="adventures-in-covariance.html#cb1447-14"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-13-1.png" width="288" /></p>
<p>As it turns out, the shape of the LKJ is sensitive to both <span class="math inline">\(\eta\)</span> and the <span class="math inline">\(K\)</span> dimensions of the correlation matrix. Our simulations only considered the shapes for when <span class="math inline">\(K = 2\)</span>. We can use a combination of the <code>parse_dist()</code> and <code>stat_dist_halfeye()</code> functions from the tidybayes package to derive analytic solutions for different combinations of <span class="math inline">\(\eta\)</span> and <span class="math inline">\(K\)</span>.</p>
<div class="sourceCode" id="cb1448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1448-1"><a href="adventures-in-covariance.html#cb1448-1"></a><span class="kw">library</span>(tidybayes)</span>
<span id="cb1448-2"><a href="adventures-in-covariance.html#cb1448-2"></a></span>
<span id="cb1448-3"><a href="adventures-in-covariance.html#cb1448-3"></a><span class="kw">crossing</span>(<span class="dt">k   =</span> <span class="dv">2</span><span class="op">:</span><span class="dv">5</span>,</span>
<span id="cb1448-4"><a href="adventures-in-covariance.html#cb1448-4"></a>         <span class="dt">eta =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1448-5"><a href="adventures-in-covariance.html#cb1448-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">prior =</span> <span class="kw">str_c</span>(<span class="st">&quot;lkjcorr_marginal(&quot;</span>, k, <span class="st">&quot;, &quot;</span>, eta, <span class="st">&quot;)&quot;</span>),</span>
<span id="cb1448-6"><a href="adventures-in-covariance.html#cb1448-6"></a>         <span class="dt">strip =</span> <span class="kw">str_c</span>(<span class="st">&quot;K==&quot;</span>, k)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1448-7"><a href="adventures-in-covariance.html#cb1448-7"></a><span class="st">  </span><span class="kw">parse_dist</span>(prior) <span class="op">%&gt;%</span></span>
<span id="cb1448-8"><a href="adventures-in-covariance.html#cb1448-8"></a><span class="st">  </span></span>
<span id="cb1448-9"><a href="adventures-in-covariance.html#cb1448-9"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> eta, <span class="dt">dist =</span> .dist, <span class="dt">args =</span> .args)) <span class="op">+</span></span>
<span id="cb1448-10"><a href="adventures-in-covariance.html#cb1448-10"></a><span class="st">  </span><span class="kw">stat_dist_halfeye</span>(<span class="dt">.width =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.95</span>),</span>
<span id="cb1448-11"><a href="adventures-in-covariance.html#cb1448-11"></a>                    <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#A65141&quot;</span>) <span class="op">+</span></span>
<span id="cb1448-12"><a href="adventures-in-covariance.html#cb1448-12"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="kw">expression</span>(rho), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>),</span>
<span id="cb1448-13"><a href="adventures-in-covariance.html#cb1448-13"></a>                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="fl">-.5</span>, <span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>), <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;-1&quot;</span>, <span class="st">&quot;-.5&quot;</span>, <span class="st">&quot;0&quot;</span>, <span class="st">&quot;.5&quot;</span>, <span class="st">&quot;1&quot;</span>)) <span class="op">+</span></span>
<span id="cb1448-14"><a href="adventures-in-covariance.html#cb1448-14"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="kw">expression</span>(eta), <span class="dt">breaks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb1448-15"><a href="adventures-in-covariance.html#cb1448-15"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="kw">expression</span>(<span class="st">&quot;Marginal correlation for the LKJ prior relative to K and &quot;</span><span class="op">*</span>eta)) <span class="op">+</span></span>
<span id="cb1448-16"><a href="adventures-in-covariance.html#cb1448-16"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>() <span class="op">+</span></span>
<span id="cb1448-17"><a href="adventures-in-covariance.html#cb1448-17"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>strip, <span class="dt">labeller =</span> label_parsed, <span class="dt">ncol =</span> <span class="dv">4</span>)</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-14-1.png" width="768" /></p>
<p>To learn more about this method, check out Kay’s <span class="citation">(<a href="#ref-kayMarginalDistributionSingle2020" role="doc-biblioref">2020</a><a href="#ref-kayMarginalDistributionSingle2020" role="doc-biblioref">a</a>)</span> <a href="https://mjskay.github.io/ggdist/reference/lkjcorr_marginal.html"><em>Marginal distribution of a single correlation from an LKJ distribution</em></a>.</p>
<p>Okay, let’s get ready to model and switch out rethinking for brms.</p>
<div class="sourceCode" id="cb1449"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1449-1"><a href="adventures-in-covariance.html#cb1449-1"></a><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</span>
<span id="cb1449-2"><a href="adventures-in-covariance.html#cb1449-2"></a><span class="kw">library</span>(brms)</span></code></pre></div>
<p>As defined above, our first model has both varying intercepts and <code>afternoon</code> slopes. I should point out that the <code>(1 + afternoon | cafe)</code> syntax specifies that we’d like <code>brm()</code> to fit the random effects for <code>1</code> (i.e., the intercept) and the <code>afternoon</code> slope as correlated. Had we wanted to fit a model in which they were orthogonal, we’d have coded <code>(1 + afternoon || cafe)</code>.</p>
<div class="sourceCode" id="cb1450"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1450-1"><a href="adventures-in-covariance.html#cb1450-1"></a> b13<span class="fl">.1</span> &lt;-<span class="st"> </span></span>
<span id="cb1450-2"><a href="adventures-in-covariance.html#cb1450-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </span>
<span id="cb1450-3"><a href="adventures-in-covariance.html#cb1450-3"></a>      <span class="dt">family =</span> gaussian,</span>
<span id="cb1450-4"><a href="adventures-in-covariance.html#cb1450-4"></a>      wait <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>afternoon <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>afternoon <span class="op">|</span><span class="st"> </span>cafe),</span>
<span id="cb1450-5"><a href="adventures-in-covariance.html#cb1450-5"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1450-6"><a href="adventures-in-covariance.html#cb1450-6"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> b),</span>
<span id="cb1450-7"><a href="adventures-in-covariance.html#cb1450-7"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">class =</span> sd),</span>
<span id="cb1450-8"><a href="adventures-in-covariance.html#cb1450-8"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">class =</span> sigma),</span>
<span id="cb1450-9"><a href="adventures-in-covariance.html#cb1450-9"></a>                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor)),</span>
<span id="cb1450-10"><a href="adventures-in-covariance.html#cb1450-10"></a>      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">2000</span>, <span class="dt">chains =</span> <span class="dv">2</span>, <span class="dt">cores =</span> <span class="dv">2</span>,</span>
<span id="cb1450-11"><a href="adventures-in-covariance.html#cb1450-11"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1450-12"><a href="adventures-in-covariance.html#cb1450-12"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.01&quot;</span>)</span></code></pre></div>
<p>With Figure 13.4, we assess how the posterior for the correlation of the random effects compares to its prior.</p>
<div class="sourceCode" id="cb1451"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1451-1"><a href="adventures-in-covariance.html#cb1451-1"></a>post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.1</span>)</span>
<span id="cb1451-2"><a href="adventures-in-covariance.html#cb1451-2"></a></span>
<span id="cb1451-3"><a href="adventures-in-covariance.html#cb1451-3"></a>post <span class="op">%&gt;%</span></span>
<span id="cb1451-4"><a href="adventures-in-covariance.html#cb1451-4"></a><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb1451-5"><a href="adventures-in-covariance.html#cb1451-5"></a><span class="st">  </span><span class="kw">geom_density</span>(<span class="dt">data =</span> r_<span class="dv">2</span>, <span class="kw">aes</span>(<span class="dt">x =</span> V2),</span>
<span id="cb1451-6"><a href="adventures-in-covariance.html#cb1451-6"></a>               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">alpha =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb1451-7"><a href="adventures-in-covariance.html#cb1451-7"></a><span class="st">  </span><span class="kw">geom_density</span>(<span class="kw">aes</span>(<span class="dt">x =</span> cor_cafe__Intercept__afternoon),</span>
<span id="cb1451-8"><a href="adventures-in-covariance.html#cb1451-8"></a>               <span class="dt">color =</span> <span class="st">&quot;transparent&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">alpha =</span> <span class="dv">9</span><span class="op">/</span><span class="dv">10</span>) <span class="op">+</span></span>
<span id="cb1451-9"><a href="adventures-in-covariance.html#cb1451-9"></a><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="fl">-0.35</span>, <span class="dt">y =</span> <span class="fl">2.2</span>, </span>
<span id="cb1451-10"><a href="adventures-in-covariance.html#cb1451-10"></a>           <span class="dt">label =</span> <span class="st">&quot;posterior&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></span>
<span id="cb1451-11"><a href="adventures-in-covariance.html#cb1451-11"></a><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="dv">0</span>, <span class="dt">y =</span> <span class="fl">0.9</span>, </span>
<span id="cb1451-12"><a href="adventures-in-covariance.html#cb1451-12"></a>           <span class="dt">label =</span> <span class="st">&quot;prior&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>) <span class="op">+</span></span>
<span id="cb1451-13"><a href="adventures-in-covariance.html#cb1451-13"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1451-14"><a href="adventures-in-covariance.html#cb1451-14"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;correlation&quot;</span>) <span class="op">+</span></span>
<span id="cb1451-15"><a href="adventures-in-covariance.html#cb1451-15"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-16-1.png" width="288" /></p>
<p>McElreath then depicted multidimensional shrinkage by plotting the posterior mean of the varying effects compared to their raw, unpooled estimated. With brms, we can get the <code>cafe</code>-specific intercepts and <code>afternoon</code> slopes with <code>coef()</code>, which returns a three-dimensional list.</p>
<div class="sourceCode" id="cb1452"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1452-1"><a href="adventures-in-covariance.html#cb1452-1"></a><span class="co"># coef(b13.1) %&gt;% glimpse()</span></span>
<span id="cb1452-2"><a href="adventures-in-covariance.html#cb1452-2"></a></span>
<span id="cb1452-3"><a href="adventures-in-covariance.html#cb1452-3"></a><span class="kw">coef</span>(b13<span class="fl">.1</span>)</span></code></pre></div>
<pre><code>## $cafe
## , , Intercept
## 
##    Estimate Est.Error     Q2.5    Q97.5
## 1  3.261267 0.2022317 2.865871 3.662413
## 2  3.170057 0.2075438 2.766656 3.586014
## 3  1.618229 0.2070828 1.221038 2.034602
## 4  3.328640 0.2023725 2.926096 3.724404
## 5  2.297725 0.2045031 1.891664 2.694051
## 6  3.143399 0.1966858 2.761031 3.536481
## 7  2.649010 0.2015274 2.253432 3.039283
## 8  3.643403 0.1988298 3.257141 4.033826
## 9  4.121512 0.2002260 3.726466 4.515171
## 10 2.322686 0.2059556 1.917322 2.724238
## 11 4.441408 0.2031371 4.035036 4.836295
## 12 2.834332 0.1961840 2.452077 3.216335
## 13 4.651916 0.2092051 4.238595 5.064820
## 14 5.531339 0.2162129 5.108766 5.950957
## 15 3.560576 0.2004535 3.166033 3.956131
## 16 3.482447 0.1999182 3.086673 3.862612
## 17 2.339014 0.2028317 1.943782 2.747155
## 18 3.961005 0.1998326 3.563676 4.355762
## 19 3.498035 0.2001685 3.100816 3.892309
## 20 3.169314 0.2015073 2.772622 3.562937
## 
## , , afternoon
## 
##      Estimate Est.Error       Q2.5       Q97.5
## 1  -0.9141569 0.2135083 -1.3613888 -0.52166658
## 2  -1.0543017 0.2450597 -1.5864095 -0.64468885
## 3  -0.4286595 0.2284660 -0.8812659  0.02410714
## 4  -0.7326046 0.2130340 -1.1363527 -0.28165649
## 5  -0.5472980 0.2153189 -0.9629481 -0.10759467
## 6  -0.7879084 0.2021296 -1.1951170 -0.38301159
## 7  -0.4873838 0.2314690 -0.8963769  0.00356575
## 8  -0.8198660 0.2116039 -1.2144291 -0.37473801
## 9  -1.0802543 0.2141687 -1.5283726 -0.68263368
## 10 -0.4236096 0.2296177 -0.8421629  0.05385124
## 11 -1.0918343 0.2180331 -1.5277214 -0.66107151
## 12 -0.7594460 0.2035779 -1.1697757 -0.36540080
## 13 -1.2096516 0.2255022 -1.6758372 -0.77675216
## 14 -1.5313511 0.2648532 -2.0627304 -1.03225890
## 15 -0.9264938 0.2061081 -1.3530878 -0.53402106
## 16 -0.7277956 0.2112849 -1.1145536 -0.27877265
## 17 -0.5682683 0.2180761 -1.0039895 -0.13034591
## 18 -1.0100810 0.2049816 -1.4256395 -0.61325887
## 19 -0.7428671 0.2163567 -1.1453873 -0.29111977
## 20 -0.7285455 0.2110083 -1.1334523 -0.29874852</code></pre>
<p>Here’s the code to extract the relevant elements from the <code>coef()</code> list, convert them to a tibble, and add the <code>cafe</code> index.</p>
<div class="sourceCode" id="cb1454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1454-1"><a href="adventures-in-covariance.html#cb1454-1"></a>partially_pooled_params &lt;-</span>
<span id="cb1454-2"><a href="adventures-in-covariance.html#cb1454-2"></a><span class="st">  </span><span class="co"># with this line we select each of the 20 cafe&#39;s posterior mean (i.e., Estimate)</span></span>
<span id="cb1454-3"><a href="adventures-in-covariance.html#cb1454-3"></a><span class="st">  </span><span class="co"># for both `Intercept` and `afternoon`</span></span>
<span id="cb1454-4"><a href="adventures-in-covariance.html#cb1454-4"></a><span class="st">  </span><span class="kw">coef</span>(b13<span class="fl">.1</span>)<span class="op">$</span>cafe[ , <span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] <span class="op">%&gt;%</span></span>
<span id="cb1454-5"><a href="adventures-in-covariance.html#cb1454-5"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st">               </span><span class="co"># convert the two vectors to a tibble</span></span>
<span id="cb1454-6"><a href="adventures-in-covariance.html#cb1454-6"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Slope =</span> afternoon) <span class="op">%&gt;%</span></span>
<span id="cb1454-7"><a href="adventures-in-covariance.html#cb1454-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cafe =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># add the `cafe` index</span></span>
<span id="cb1454-8"><a href="adventures-in-covariance.html#cb1454-8"></a><span class="st">  </span><span class="kw">select</span>(cafe, <span class="kw">everything</span>())    <span class="co"># simply moving `cafe` to the leftmost position</span></span></code></pre></div>
<p>Like McElreath, we’ll compute the unpooled estimates directly from the data.</p>
<div class="sourceCode" id="cb1455"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1455-1"><a href="adventures-in-covariance.html#cb1455-1"></a><span class="co"># compute unpooled estimates directly from data</span></span>
<span id="cb1455-2"><a href="adventures-in-covariance.html#cb1455-2"></a>un_pooled_params &lt;-</span>
<span id="cb1455-3"><a href="adventures-in-covariance.html#cb1455-3"></a><span class="st">  </span>d <span class="op">%&gt;%</span></span>
<span id="cb1455-4"><a href="adventures-in-covariance.html#cb1455-4"></a><span class="st">  </span><span class="co"># with these two lines, we compute the mean value for each cafe&#39;s wait time </span></span>
<span id="cb1455-5"><a href="adventures-in-covariance.html#cb1455-5"></a><span class="st">  </span><span class="co"># in the morning and then the afternoon</span></span>
<span id="cb1455-6"><a href="adventures-in-covariance.html#cb1455-6"></a><span class="st">  </span><span class="kw">group_by</span>(afternoon, cafe) <span class="op">%&gt;%</span></span>
<span id="cb1455-7"><a href="adventures-in-covariance.html#cb1455-7"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(wait)) <span class="op">%&gt;%</span></span>
<span id="cb1455-8"><a href="adventures-in-covariance.html#cb1455-8"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># ungrouping allows us to alter afternoon, one of the grouping variables</span></span>
<span id="cb1455-9"><a href="adventures-in-covariance.html#cb1455-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">ifelse</span>(afternoon <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;Intercept&quot;</span>, <span class="st">&quot;Slope&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1455-10"><a href="adventures-in-covariance.html#cb1455-10"></a><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> afternoon, <span class="dt">value =</span> mean) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># use `spread()` just as in the previous block</span></span>
<span id="cb1455-11"><a href="adventures-in-covariance.html#cb1455-11"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Slope =</span> Slope <span class="op">-</span><span class="st"> </span>Intercept)          <span class="co"># finally, here&#39;s our slope!</span></span>
<span id="cb1455-12"><a href="adventures-in-covariance.html#cb1455-12"></a></span>
<span id="cb1455-13"><a href="adventures-in-covariance.html#cb1455-13"></a><span class="co"># here we combine the partially-pooled and unpooled means into a single data object, </span></span>
<span id="cb1455-14"><a href="adventures-in-covariance.html#cb1455-14"></a><span class="co"># which will make plotting easier.</span></span>
<span id="cb1455-15"><a href="adventures-in-covariance.html#cb1455-15"></a>params &lt;-</span>
<span id="cb1455-16"><a href="adventures-in-covariance.html#cb1455-16"></a><span class="st">  </span><span class="co"># `bind_rows()` will stack the second tibble below the first</span></span>
<span id="cb1455-17"><a href="adventures-in-covariance.html#cb1455-17"></a><span class="st">  </span><span class="kw">bind_rows</span>(partially_pooled_params, un_pooled_params) <span class="op">%&gt;%</span></span>
<span id="cb1455-18"><a href="adventures-in-covariance.html#cb1455-18"></a><span class="st">  </span><span class="co"># index whether the estimates are pooled</span></span>
<span id="cb1455-19"><a href="adventures-in-covariance.html#cb1455-19"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pooled =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;partially&quot;</span>, <span class="st">&quot;not&quot;</span>), <span class="dt">each =</span> <span class="kw">nrow</span>(.)<span class="op">/</span><span class="dv">2</span>)) </span>
<span id="cb1455-20"><a href="adventures-in-covariance.html#cb1455-20"></a></span>
<span id="cb1455-21"><a href="adventures-in-covariance.html#cb1455-21"></a><span class="co"># here&#39;s a glimpse at what we&#39;ve been working for</span></span>
<span id="cb1455-22"><a href="adventures-in-covariance.html#cb1455-22"></a>params <span class="op">%&gt;%</span></span>
<span id="cb1455-23"><a href="adventures-in-covariance.html#cb1455-23"></a><span class="st">  </span><span class="kw">slice</span>(<span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dv">36</span><span class="op">:</span><span class="dv">40</span>))</span></code></pre></div>
<pre><code>## # A tibble: 10 x 4
##     cafe Intercept  Slope pooled   
##    &lt;int&gt;     &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;    
##  1     1      3.26 -0.914 partially
##  2     2      3.17 -1.05  partially
##  3     3      1.62 -0.429 partially
##  4     4      3.33 -0.733 partially
##  5     5      2.30 -0.547 partially
##  6    16      3.38 -0.465 not      
##  7    17      2.29 -0.531 not      
##  8    18      4.01 -1.07  not      
##  9    19      3.39 -0.484 not      
## 10    20      3.12 -0.617 not</code></pre>
<p>Finally, here’s our code for Figure 13.5.a, showing shrinkage in two dimensions.</p>
<div class="sourceCode" id="cb1457"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1457-1"><a href="adventures-in-covariance.html#cb1457-1"></a>p1 &lt;-</span>
<span id="cb1457-2"><a href="adventures-in-covariance.html#cb1457-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data =</span> params, <span class="kw">aes</span>(<span class="dt">x =</span> Intercept, <span class="dt">y =</span> Slope)) <span class="op">+</span></span>
<span id="cb1457-3"><a href="adventures-in-covariance.html#cb1457-3"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-4"><a href="adventures-in-covariance.html#cb1457-4"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-5"><a href="adventures-in-covariance.html#cb1457-5"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-6"><a href="adventures-in-covariance.html#cb1457-6"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">4</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-7"><a href="adventures-in-covariance.html#cb1457-7"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">5</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-8"><a href="adventures-in-covariance.html#cb1457-8"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">6</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-9"><a href="adventures-in-covariance.html#cb1457-9"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">7</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-10"><a href="adventures-in-covariance.html#cb1457-10"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">8</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-11"><a href="adventures-in-covariance.html#cb1457-11"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="dv">9</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-12"><a href="adventures-in-covariance.html#cb1457-12"></a><span class="st">  </span><span class="kw">stat_ellipse</span>(<span class="dt">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="dt">level =</span> <span class="fl">.99</span>,  <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>) <span class="op">+</span></span>
<span id="cb1457-13"><a href="adventures-in-covariance.html#cb1457-13"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe, <span class="dt">color =</span> pooled)) <span class="op">+</span></span>
<span id="cb1457-14"><a href="adventures-in-covariance.html#cb1457-14"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe), <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb1457-15"><a href="adventures-in-covariance.html#cb1457-15"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="st">&quot;Pooled?&quot;</span>,</span>
<span id="cb1457-16"><a href="adventures-in-covariance.html#cb1457-16"></a>                     <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></span>
<span id="cb1457-17"><a href="adventures-in-covariance.html#cb1457-17"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(params<span class="op">$</span>Intercept),</span>
<span id="cb1457-18"><a href="adventures-in-covariance.html#cb1457-18"></a>                  <span class="dt">ylim =</span> <span class="kw">range</span>(params<span class="op">$</span>Slope)) <span class="op">+</span></span>
<span id="cb1457-19"><a href="adventures-in-covariance.html#cb1457-19"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span>
<span id="cb1457-20"><a href="adventures-in-covariance.html#cb1457-20"></a></span>
<span id="cb1457-21"><a href="adventures-in-covariance.html#cb1457-21"></a>p1</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-20-1.png" width="480" /></p>
<p>Learn more about <code>stat_ellipse()</code>, <a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">here</a>. Let’s prep for Figure 13.5.b.</p>
<div class="sourceCode" id="cb1458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1458-1"><a href="adventures-in-covariance.html#cb1458-1"></a><span class="co"># retrieve the partially-pooled estimates with `coef()`</span></span>
<span id="cb1458-2"><a href="adventures-in-covariance.html#cb1458-2"></a>partially_pooled_estimates &lt;-</span>
<span id="cb1458-3"><a href="adventures-in-covariance.html#cb1458-3"></a><span class="st">  </span><span class="kw">coef</span>(b13<span class="fl">.1</span>)<span class="op">$</span>cafe[ , <span class="dv">1</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] <span class="op">%&gt;%</span></span>
<span id="cb1458-4"><a href="adventures-in-covariance.html#cb1458-4"></a><span class="st">  </span><span class="co"># convert the two vectors to a tibble</span></span>
<span id="cb1458-5"><a href="adventures-in-covariance.html#cb1458-5"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></span>
<span id="cb1458-6"><a href="adventures-in-covariance.html#cb1458-6"></a><span class="st">  </span><span class="co"># the Intercept is the wait time for morning (i.e., `afternoon == 0`)</span></span>
<span id="cb1458-7"><a href="adventures-in-covariance.html#cb1458-7"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">morning =</span> Intercept) <span class="op">%&gt;%</span></span>
<span id="cb1458-8"><a href="adventures-in-covariance.html#cb1458-8"></a><span class="st">  </span><span class="co"># `afternoon` wait time is the `morning` wait time plus the afternoon slope</span></span>
<span id="cb1458-9"><a href="adventures-in-covariance.html#cb1458-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> morning <span class="op">+</span><span class="st"> </span>afternoon,</span>
<span id="cb1458-10"><a href="adventures-in-covariance.html#cb1458-10"></a>         <span class="dt">cafe      =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># add the `cafe` index</span></span>
<span id="cb1458-11"><a href="adventures-in-covariance.html#cb1458-11"></a><span class="st">  </span><span class="kw">select</span>(cafe, <span class="kw">everything</span>()) </span>
<span id="cb1458-12"><a href="adventures-in-covariance.html#cb1458-12"></a></span>
<span id="cb1458-13"><a href="adventures-in-covariance.html#cb1458-13"></a><span class="co"># compute unpooled estimates directly from data</span></span>
<span id="cb1458-14"><a href="adventures-in-covariance.html#cb1458-14"></a>un_pooled_estimates &lt;-</span>
<span id="cb1458-15"><a href="adventures-in-covariance.html#cb1458-15"></a><span class="st">  </span>d <span class="op">%&gt;%</span></span>
<span id="cb1458-16"><a href="adventures-in-covariance.html#cb1458-16"></a><span class="st">  </span><span class="co"># as above, with these two lines, we compute each cafe&#39;s mean wait value by time of day</span></span>
<span id="cb1458-17"><a href="adventures-in-covariance.html#cb1458-17"></a><span class="st">  </span><span class="kw">group_by</span>(afternoon, cafe) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1458-18"><a href="adventures-in-covariance.html#cb1458-18"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(wait)) <span class="op">%&gt;%</span></span>
<span id="cb1458-19"><a href="adventures-in-covariance.html#cb1458-19"></a><span class="st">  </span><span class="co"># ungrouping allows us to alter the grouping variable, afternoon</span></span>
<span id="cb1458-20"><a href="adventures-in-covariance.html#cb1458-20"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1458-21"><a href="adventures-in-covariance.html#cb1458-21"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">afternoon =</span> <span class="kw">ifelse</span>(afternoon <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;morning&quot;</span>, <span class="st">&quot;afternoon&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1458-22"><a href="adventures-in-covariance.html#cb1458-22"></a><span class="st">  </span><span class="co"># this seperates out the values into morning and afternoon columns</span></span>
<span id="cb1458-23"><a href="adventures-in-covariance.html#cb1458-23"></a><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key =</span> afternoon, <span class="dt">value =</span> mean)</span>
<span id="cb1458-24"><a href="adventures-in-covariance.html#cb1458-24"></a></span>
<span id="cb1458-25"><a href="adventures-in-covariance.html#cb1458-25"></a>estimates &lt;-</span>
<span id="cb1458-26"><a href="adventures-in-covariance.html#cb1458-26"></a><span class="st">  </span><span class="kw">bind_rows</span>(partially_pooled_estimates, un_pooled_estimates) <span class="op">%&gt;%</span></span>
<span id="cb1458-27"><a href="adventures-in-covariance.html#cb1458-27"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pooled =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;partially&quot;</span>, <span class="st">&quot;not&quot;</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>))</span></code></pre></div>
<p>The code for Figure 13.5.b.</p>
<div class="sourceCode" id="cb1459"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1459-1"><a href="adventures-in-covariance.html#cb1459-1"></a>p2 &lt;-</span>
<span id="cb1459-2"><a href="adventures-in-covariance.html#cb1459-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data =</span> estimates, <span class="kw">aes</span>(<span class="dt">x =</span> morning, <span class="dt">y =</span> afternoon)) <span class="op">+</span></span>
<span id="cb1459-3"><a href="adventures-in-covariance.html#cb1459-3"></a><span class="st">  </span><span class="co"># nesting `stat_ellipse()` within `mapply()` is a less redundant way to produce the </span></span>
<span id="cb1459-4"><a href="adventures-in-covariance.html#cb1459-4"></a><span class="st">  </span><span class="co"># ten-layered semitransparent ellipses we did with ten lines of `stat_ellipse()` </span></span>
<span id="cb1459-5"><a href="adventures-in-covariance.html#cb1459-5"></a><span class="st">  </span><span class="co"># functions in the previous plot</span></span>
<span id="cb1459-6"><a href="adventures-in-covariance.html#cb1459-6"></a><span class="st">  </span><span class="kw">mapply</span>(<span class="cf">function</span>(level) {</span>
<span id="cb1459-7"><a href="adventures-in-covariance.html#cb1459-7"></a>    <span class="kw">stat_ellipse</span>(<span class="dt">geom  =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>,</span>
<span id="cb1459-8"><a href="adventures-in-covariance.html#cb1459-8"></a>                 <span class="dt">size  =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>,</span>
<span id="cb1459-9"><a href="adventures-in-covariance.html#cb1459-9"></a>                 <span class="dt">level =</span> level)</span>
<span id="cb1459-10"><a href="adventures-in-covariance.html#cb1459-10"></a>    }, </span>
<span id="cb1459-11"><a href="adventures-in-covariance.html#cb1459-11"></a>    <span class="co"># enter the levels here</span></span>
<span id="cb1459-12"><a href="adventures-in-covariance.html#cb1459-12"></a>    <span class="dt">level =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">to =</span> <span class="dv">9</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">by =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="fl">.99</span>)) <span class="op">+</span></span>
<span id="cb1459-13"><a href="adventures-in-covariance.html#cb1459-13"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe, <span class="dt">color =</span> pooled)) <span class="op">+</span></span>
<span id="cb1459-14"><a href="adventures-in-covariance.html#cb1459-14"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> cafe), <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb1459-15"><a href="adventures-in-covariance.html#cb1459-15"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="st">&quot;Pooled?&quot;</span>, <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></span>
<span id="cb1459-16"><a href="adventures-in-covariance.html#cb1459-16"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;morning wait (mins)&quot;</span>,</span>
<span id="cb1459-17"><a href="adventures-in-covariance.html#cb1459-17"></a>       <span class="dt">y =</span> <span class="st">&quot;afternoon wait (mins)&quot;</span>) <span class="op">+</span></span>
<span id="cb1459-18"><a href="adventures-in-covariance.html#cb1459-18"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(estimates<span class="op">$</span>morning),</span>
<span id="cb1459-19"><a href="adventures-in-covariance.html#cb1459-19"></a>                  <span class="dt">ylim =</span> <span class="kw">range</span>(estimates<span class="op">$</span>afternoon)) <span class="op">+</span></span>
<span id="cb1459-20"><a href="adventures-in-covariance.html#cb1459-20"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p>Here we bind the two subplots together with patchwork syntax.</p>
<div class="sourceCode" id="cb1460"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1460-1"><a href="adventures-in-covariance.html#cb1460-1"></a><span class="kw">library</span>(patchwork)</span>
<span id="cb1460-2"><a href="adventures-in-covariance.html#cb1460-2"></a></span>
<span id="cb1460-3"><a href="adventures-in-covariance.html#cb1460-3"></a>(p1 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb1460-4"><a href="adventures-in-covariance.html#cb1460-4"></a><span class="st">  </span>p2 <span class="op">+</span><span class="st"> </span></span>
<span id="cb1460-5"><a href="adventures-in-covariance.html#cb1460-5"></a><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">title =</span> <span class="st">&quot;Shrinkage in two dimensions&quot;</span>,</span>
<span id="cb1460-6"><a href="adventures-in-covariance.html#cb1460-6"></a>                  <span class="dt">theme =</span> <span class="kw">theme_pearl_earring</span>())</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-23-1.png" width="768" /></p>
</div>
</div>
<div id="example-admission-decisions-and-gender" class="section level2">
<h2><span class="header-section-number">13.2</span> Example: Admission decisions and gender</h2>
<p>Let’s revisit the infamous UCB admissions data.</p>
<div class="sourceCode" id="cb1461"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1461-1"><a href="adventures-in-covariance.html#cb1461-1"></a><span class="kw">library</span>(rethinking)</span>
<span id="cb1461-2"><a href="adventures-in-covariance.html#cb1461-2"></a><span class="kw">data</span>(UCBadmit)</span>
<span id="cb1461-3"><a href="adventures-in-covariance.html#cb1461-3"></a>d &lt;-<span class="st"> </span>UCBadmit</span></code></pre></div>
<p>Here we detach rethinking, reload brms, and augment the data a bit.</p>
<div class="sourceCode" id="cb1462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1462-1"><a href="adventures-in-covariance.html#cb1462-1"></a><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</span>
<span id="cb1462-2"><a href="adventures-in-covariance.html#cb1462-2"></a><span class="kw">library</span>(brms)</span>
<span id="cb1462-3"><a href="adventures-in-covariance.html#cb1462-3"></a><span class="kw">rm</span>(UCBadmit)</span>
<span id="cb1462-4"><a href="adventures-in-covariance.html#cb1462-4"></a></span>
<span id="cb1462-5"><a href="adventures-in-covariance.html#cb1462-5"></a>d &lt;-<span class="st"> </span></span>
<span id="cb1462-6"><a href="adventures-in-covariance.html#cb1462-6"></a><span class="st">  </span>d <span class="op">%&gt;%</span></span>
<span id="cb1462-7"><a href="adventures-in-covariance.html#cb1462-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">male    =</span> <span class="kw">ifelse</span>(applicant.gender <span class="op">==</span><span class="st"> &quot;male&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb1462-8"><a href="adventures-in-covariance.html#cb1462-8"></a>         <span class="dt">dept_id =</span> <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="dt">each =</span> <span class="dv">2</span>))</span></code></pre></div>
<div id="varying-intercepts." class="section level3">
<h3><span class="header-section-number">13.2.1</span> Varying intercepts.</h3>
<p>The statistical formula for our varying-intercepts logistic regression model follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{admit}_i         &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\operatorname{logit}(p_i)           &amp; = \color{blue}{\alpha_{\text{dept_id}_i}} + \beta \text{male}_i \\
\color{blue}{\alpha_\text{dept_id}} &amp; \color{blue}\sim \color{blue}{\operatorname{Normal}(\alpha, \sigma)} \\
\alpha                 &amp; \sim \operatorname{Normal}(0, 10) \\
\beta                  &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma                 &amp; \sim \operatorname{HalfCauchy}(0, 2). \\
\end{align*}\]</span></p>
<p>Since there’s only one left-hand term in our <code>(1 | dept_id)</code> code, there’s only one random effect.</p>
<div class="sourceCode" id="cb1463"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1463-1"><a href="adventures-in-covariance.html#cb1463-1"></a>b13<span class="fl">.2</span> &lt;-<span class="st"> </span></span>
<span id="cb1463-2"><a href="adventures-in-covariance.html#cb1463-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </span>
<span id="cb1463-3"><a href="adventures-in-covariance.html#cb1463-3"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1463-4"><a href="adventures-in-covariance.html#cb1463-4"></a>      admit <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>male <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>dept_id),</span>
<span id="cb1463-5"><a href="adventures-in-covariance.html#cb1463-5"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1463-6"><a href="adventures-in-covariance.html#cb1463-6"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</span>
<span id="cb1463-7"><a href="adventures-in-covariance.html#cb1463-7"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">class =</span> sd)),</span>
<span id="cb1463-8"><a href="adventures-in-covariance.html#cb1463-8"></a>      <span class="dt">iter =</span> <span class="dv">4500</span>, <span class="dt">warmup =</span> <span class="dv">500</span>, <span class="dt">chains =</span> <span class="dv">3</span>, <span class="dt">cores =</span> <span class="dv">3</span>,</span>
<span id="cb1463-9"><a href="adventures-in-covariance.html#cb1463-9"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1463-10"><a href="adventures-in-covariance.html#cb1463-10"></a>      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.99</span>),</span>
<span id="cb1463-11"><a href="adventures-in-covariance.html#cb1463-11"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.02&quot;</span>)</span></code></pre></div>
<p>Since we don’t have a <code>depth=2</code> argument in <code>brms::summary()</code>, we’ll have to get creative. One way to look at the parameters is by executing <code>b13.2$fit</code>.</p>
<div class="sourceCode" id="cb1464"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1464-1"><a href="adventures-in-covariance.html#cb1464-1"></a>b13<span class="fl">.2</span><span class="op">$</span>fit</span></code></pre></div>
<pre><code>## Inference for Stan model: c2a74aec3874a99b352cc3f41a14c01a.
## 3 chains, each with iter=4500; warmup=500; thin=1; 
## post-warmup draws per chain=4000, total post-warmup draws=12000.
## 
##                          mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
## b_Intercept             -0.59    0.02 0.65  -1.93  -0.96  -0.58  -0.22   0.77  1810    1
## b_male                  -0.09    0.00 0.08  -0.25  -0.15  -0.09  -0.04   0.06  4911    1
## sd_dept_id__Intercept    1.46    0.01 0.57   0.77   1.07   1.33   1.69   2.88  1834    1
## r_dept_id[1,Intercept]   1.26    0.02 0.65  -0.08   0.89   1.25   1.63   2.59  1831    1
## r_dept_id[2,Intercept]   1.22    0.02 0.65  -0.11   0.85   1.21   1.59   2.56  1843    1
## r_dept_id[3,Intercept]   0.00    0.02 0.65  -1.33  -0.36   0.00   0.37   1.35  1820    1
## r_dept_id[4,Intercept]  -0.03    0.02 0.65  -1.37  -0.39  -0.04   0.34   1.30  1817    1
## r_dept_id[5,Intercept]  -0.47    0.02 0.65  -1.82  -0.84  -0.48  -0.10   0.86  1840    1
## r_dept_id[6,Intercept]  -2.02    0.02 0.66  -3.37  -2.40  -2.03  -1.64  -0.69  1843    1
## lp__                   -61.89    0.05 2.54 -67.75 -63.33 -61.57 -60.04 -57.94  2452    1
## 
## Samples were drawn using NUTS(diag_e) at Thu Oct  8 21:29:05 2020.
## For each parameter, n_eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor on split chains (at 
## convergence, Rhat=1).</code></pre>
<p>However, notice that the group-specific parameters don’t match up with those in the text. Though our <code>r_dept_id[1,Intercept]</code> had a posterior mean of 1.25, the number for <code>a_dept[1]</code> in the text is 0.67. This is because the brms package presented the random effects in the <strong>non-centered</strong> metric. The rethinking package, in contrast, presented the random effects in the <strong>centered</strong> metric. On page 399, McElreath wrote:</p>
<blockquote>
<p>Remember, the values above are the <span class="math inline">\(\alpha_\text{DEPT}\)</span> estimates, and so they are deviations from the global mean <span class="math inline">\(\alpha\)</span>, which in this case has posterior mean -0.58. So department A, “[1]” in the table, has the highest average admission rate. Department F, “[6]” in the table, has the lowest.</p>
</blockquote>
<p>Here’s another fun fact:</p>
<div class="sourceCode" id="cb1466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1466-1"><a href="adventures-in-covariance.html#cb1466-1"></a><span class="co"># numbers taken from the mean column on page 399 in the text</span></span>
<span id="cb1466-2"><a href="adventures-in-covariance.html#cb1466-2"></a><span class="kw">c</span>(<span class="fl">0.67</span>, <span class="fl">0.63</span>, <span class="fl">-0.59</span>, <span class="fl">-0.62</span>, <span class="fl">-1.06</span>, <span class="fl">-2.61</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mean</span>()</span></code></pre></div>
<pre><code>## [1] -0.5966667</code></pre>
<p>The average of the rethinking-based <strong>centered</strong> random effects is within rounding error of the global mean, -0.58. If you want the random effects in the <strong>centered</strong> metric from brms, you can use the <code>coef()</code> function.</p>
<div class="sourceCode" id="cb1468"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1468-1"><a href="adventures-in-covariance.html#cb1468-1"></a><span class="kw">coef</span>(b13<span class="fl">.2</span>)</span></code></pre></div>
<pre><code>## $dept_id
## , , Intercept
## 
##     Estimate  Est.Error       Q2.5      Q97.5
## 1  0.6716769 0.09784683  0.4809545  0.8635279
## 2  0.6275563 0.11404528  0.4043847  0.8494950
## 3 -0.5844492 0.07432988 -0.7308926 -0.4403034
## 4 -0.6166920 0.08562290 -0.7842952 -0.4503644
## 5 -1.0604176 0.09815365 -1.2545652 -0.8696588
## 6 -2.6098733 0.15748859 -2.9273409 -2.3138709
## 
## , , male
## 
##      Estimate  Est.Error       Q2.5     Q97.5
## 1 -0.09263497 0.07916318 -0.2464227 0.0628672
## 2 -0.09263497 0.07916318 -0.2464227 0.0628672
## 3 -0.09263497 0.07916318 -0.2464227 0.0628672
## 4 -0.09263497 0.07916318 -0.2464227 0.0628672
## 5 -0.09263497 0.07916318 -0.2464227 0.0628672
## 6 -0.09263497 0.07916318 -0.2464227 0.0628672</code></pre>
<p>And just to confirm, the average of the posterior means of the <code>Intercept</code> random effects with <code>brms::coef()</code> is also the global mean within rounding error.</p>
<div class="sourceCode" id="cb1470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1470-1"><a href="adventures-in-covariance.html#cb1470-1"></a><span class="kw">mean</span>(<span class="kw">coef</span>(b13<span class="fl">.2</span>)<span class="op">$</span>dept_id[ , <span class="st">&quot;Estimate&quot;</span>, <span class="st">&quot;Intercept&quot;</span>])</span></code></pre></div>
<pre><code>## [1] -0.5953665</code></pre>
<p>Note how <code>coef()</code> returned a three-dimensional list.</p>
<div class="sourceCode" id="cb1472"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1472-1"><a href="adventures-in-covariance.html#cb1472-1"></a><span class="kw">coef</span>(b13<span class="fl">.2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>## List of 1
##  $ dept_id: num [1:6, 1:4, 1:2] 0.672 0.628 -0.584 -0.617 -1.06 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 3
##   .. ..$ : chr [1:6] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##   .. ..$ : chr [1:4] &quot;Estimate&quot; &quot;Est.Error&quot; &quot;Q2.5&quot; &quot;Q97.5&quot;
##   .. ..$ : chr [1:2] &quot;Intercept&quot; &quot;male&quot;</code></pre>
<p>If you just want the parameter summaries for the random intercepts, you have to use three-dimensional indexing.</p>
<div class="sourceCode" id="cb1474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1474-1"><a href="adventures-in-covariance.html#cb1474-1"></a><span class="kw">coef</span>(b13<span class="fl">.2</span>)<span class="op">$</span>dept_id[ , , <span class="st">&quot;Intercept&quot;</span>]  <span class="co"># this also works: coef(b13.2)$dept_id[ , , 1]</span></span></code></pre></div>
<pre><code>##     Estimate  Est.Error       Q2.5      Q97.5
## 1  0.6716769 0.09784683  0.4809545  0.8635279
## 2  0.6275563 0.11404528  0.4043847  0.8494950
## 3 -0.5844492 0.07432988 -0.7308926 -0.4403034
## 4 -0.6166920 0.08562290 -0.7842952 -0.4503644
## 5 -1.0604176 0.09815365 -1.2545652 -0.8696588
## 6 -2.6098733 0.15748859 -2.9273409 -2.3138709</code></pre>
<p>So to get our brms summaries in a similar format to those in the text, we’ll have to combine <code>coef()</code> with <code>fixef()</code> and <code>VarCorr()</code>.</p>
<div class="sourceCode" id="cb1476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1476-1"><a href="adventures-in-covariance.html#cb1476-1"></a><span class="kw">rbind</span>(<span class="kw">coef</span>(b13<span class="fl">.2</span>)<span class="op">$</span>dept_id[, , <span class="st">&quot;Intercept&quot;</span>],</span>
<span id="cb1476-2"><a href="adventures-in-covariance.html#cb1476-2"></a>      <span class="kw">fixef</span>(b13<span class="fl">.2</span>),</span>
<span id="cb1476-3"><a href="adventures-in-covariance.html#cb1476-3"></a>      <span class="kw">VarCorr</span>(b13<span class="fl">.2</span>)<span class="op">$</span>dept_id<span class="op">$</span>sd)</span></code></pre></div>
<pre><code>##              Estimate  Est.Error       Q2.5      Q97.5
## 1          0.67167686 0.09784683  0.4809545  0.8635279
## 2          0.62755628 0.11404528  0.4043847  0.8494950
## 3         -0.58444921 0.07432988 -0.7308926 -0.4403034
## 4         -0.61669196 0.08562290 -0.7842952 -0.4503644
## 5         -1.06041764 0.09815365 -1.2545652 -0.8696588
## 6         -2.60987334 0.15748859 -2.9273409 -2.3138709
## Intercept -0.58841555 0.65219079 -1.9314981  0.7670679
## male      -0.09263497 0.07916318 -0.2464227  0.0628672
## Intercept  1.45907953 0.56635501  0.7680166  2.8785984</code></pre>
<p>A little more data wrangling will make the summaries easier to read.</p>
<div class="sourceCode" id="cb1478"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1478-1"><a href="adventures-in-covariance.html#cb1478-1"></a><span class="kw">rbind</span>(<span class="kw">coef</span>(b13<span class="fl">.2</span>)<span class="op">$</span>dept_id[, , <span class="st">&quot;Intercept&quot;</span>],</span>
<span id="cb1478-2"><a href="adventures-in-covariance.html#cb1478-2"></a>      <span class="kw">fixef</span>(b13<span class="fl">.2</span>),</span>
<span id="cb1478-3"><a href="adventures-in-covariance.html#cb1478-3"></a>      <span class="kw">VarCorr</span>(b13<span class="fl">.2</span>)<span class="op">$</span>dept_id<span class="op">$</span>sd) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1478-4"><a href="adventures-in-covariance.html#cb1478-4"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1478-5"><a href="adventures-in-covariance.html#cb1478-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">parameter =</span> <span class="kw">c</span>(<span class="kw">str_c</span>(<span class="st">&quot;Intercept[&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>, <span class="st">&quot;]&quot;</span>), </span>
<span id="cb1478-6"><a href="adventures-in-covariance.html#cb1478-6"></a>                       <span class="st">&quot;Intercept&quot;</span>, <span class="st">&quot;male&quot;</span>, <span class="st">&quot;sigma&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1478-7"><a href="adventures-in-covariance.html#cb1478-7"></a><span class="st">  </span><span class="kw">select</span>(parameter, <span class="kw">everything</span>()) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1478-8"><a href="adventures-in-covariance.html#cb1478-8"></a><span class="st">  </span><span class="kw">mutate_if</span>(is_double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## # A tibble: 9 x 5
##   parameter    Estimate Est.Error  Q2.5 Q97.5
##   &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 Intercept[1]    0.67      0.1    0.48  0.86
## 2 Intercept[2]    0.63      0.11   0.4   0.85
## 3 Intercept[3]   -0.580     0.07  -0.73 -0.44
## 4 Intercept[4]   -0.62      0.09  -0.78 -0.45
## 5 Intercept[5]   -1.06      0.1   -1.25 -0.87
## 6 Intercept[6]   -2.61      0.16  -2.93 -2.31
## 7 Intercept      -0.59      0.65  -1.93  0.77
## 8 male           -0.09      0.08  -0.25  0.06
## 9 sigma           1.46      0.570  0.77  2.88</code></pre>
<p>If you’d like the <span class="math inline">\(\widehat R\)</span> and effective sample size summaries for those parameters, you’ll have to use the <code>posterior::summarise_draws()</code> trick from last chapter.</p>
<div class="sourceCode" id="cb1480"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1480-1"><a href="adventures-in-covariance.html#cb1480-1"></a><span class="kw">library</span>(posterior)</span>
<span id="cb1480-2"><a href="adventures-in-covariance.html#cb1480-2"></a></span>
<span id="cb1480-3"><a href="adventures-in-covariance.html#cb1480-3"></a><span class="kw">posterior_samples</span>(b13<span class="fl">.2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1480-4"><a href="adventures-in-covariance.html#cb1480-4"></a><span class="st">  </span><span class="kw">summarise_draws</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1480-5"><a href="adventures-in-covariance.html#cb1480-5"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## # A tibble: 10 x 10
##    variable                 mean  median    sd   mad     q5     q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;                   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 b_Intercept             -0.59  -0.580 0.65   0.55  -1.63   0.46      1    1872.    2431.
##  2 b_male                  -0.09  -0.09  0.08   0.08  -0.22   0.04      1    4922.    5261.
##  3 sd_dept_id__Intercept    1.46   1.33  0.570  0.44   0.83   2.55      1    1951.    2382.
##  4 r_dept_id[1,Intercept]   1.26   1.25  0.65   0.55   0.21   2.31      1    1895.    2394.
##  5 r_dept_id[2,Intercept]   1.22   1.21  0.65   0.55   0.17   2.27      1    1910.    2473.
##  6 r_dept_id[3,Intercept]   0      0     0.65   0.55  -1.04   1.06      1    1888.    2412.
##  7 r_dept_id[4,Intercept]  -0.03  -0.04  0.65   0.54  -1.08   1.02      1    1886.    2402.
##  8 r_dept_id[5,Intercept]  -0.47  -0.48  0.65   0.55  -1.53   0.580     1    1902.    2409.
##  9 r_dept_id[6,Intercept]  -2.02  -2.03  0.66   0.56  -3.11  -0.97      1    1915.    2324.
## 10 lp__                   -61.9  -61.6   2.54   2.43 -66.6  -58.4       1    2435.    4307.</code></pre>
<p>One last thing. The <a href="https://cran.r-project.org/package=broom">broom package</a> offers a very handy way to get those brms random effects. Just throw the model <code>brm()</code> fit into the <code>tidy()</code> function.</p>
<div class="sourceCode" id="cb1482"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1482-1"><a href="adventures-in-covariance.html#cb1482-1"></a><span class="kw">library</span>(broom)</span>
<span id="cb1482-2"><a href="adventures-in-covariance.html#cb1482-2"></a></span>
<span id="cb1482-3"><a href="adventures-in-covariance.html#cb1482-3"></a><span class="kw">tidy</span>(b13<span class="fl">.2</span>) <span class="op">%&gt;%</span></span>
<span id="cb1482-4"><a href="adventures-in-covariance.html#cb1482-4"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.numeric, round, <span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>##                      term estimate std.error  lower  upper
## 1             b_Intercept    -0.59      0.65  -1.63   0.46
## 2                  b_male    -0.09      0.08  -0.22   0.04
## 3   sd_dept_id__Intercept     1.46      0.57   0.83   2.55
## 4  r_dept_id[1,Intercept]     1.26      0.65   0.21   2.31
## 5  r_dept_id[2,Intercept]     1.22      0.65   0.17   2.27
## 6  r_dept_id[3,Intercept]     0.00      0.65  -1.04   1.06
## 7  r_dept_id[4,Intercept]    -0.03      0.65  -1.08   1.02
## 8  r_dept_id[5,Intercept]    -0.47      0.65  -1.53   0.58
## 9  r_dept_id[6,Intercept]    -2.02      0.66  -3.11  -0.97
## 10                   lp__   -61.89      2.54 -66.58 -58.37</code></pre>
<p>But note how, just as with <code>b13.2$fit</code>, this approach summarizes the posterior with the <strong>non-centered</strong> parameterization. Which is a fine parameterization. It’s just a little different from what you’ll get when using <code>precis( m13.2 , depth=2 )</code>, as in the text.</p>
</div>
<div id="varying-effects-of-being-male." class="section level3">
<h3><span class="header-section-number">13.2.2</span> Varying effects of being <code>male</code>.</h3>
<p>Now we’re ready to allow our <code>male</code> dummy to varies, too, the statistical model follows the form</p>
<p><span class="math display">\[\begin{align*}
\text{admit}_i     &amp; \sim \operatorname{Binomial}(n_i, p_i) \\
\text{logit} (p_i) &amp; = \color{blue}{\alpha_{\text{dept_id}_i}} + \color{blue}{\beta_{\text{dept_id}_i}} \text{male}_i \\
\color{blue}{\begin{bmatrix} \alpha_\text{dept_id} \\ \beta_\text{dept_id} \end{bmatrix}} &amp; \color{blue}\sim \color{blue}{\text{MVNormal} \left (\begin{bmatrix} \alpha \\ \beta \end{bmatrix}, \mathbf{S}  \right )} \\
\mathbf S &amp; = \begin{bmatrix} \sigma_\alpha &amp; 0 \\ 0 &amp; \sigma_\beta \end{bmatrix} \mathbf R \begin{bmatrix} \sigma_\alpha &amp; 0 \\ 0 &amp; \sigma_\beta \end{bmatrix} \\
\alpha                      &amp; \sim \operatorname{Normal}(0, 10) \\
\beta                       &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma_\alpha, \sigma_\beta &amp; \sim \operatorname{HalfCauchy}(0, 2) \\
\mathbf R                   &amp; \sim \operatorname{LKJcorr}(2).
\end{align*}\]</span></p>
<p>Fit the model.</p>
<div class="sourceCode" id="cb1484"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1484-1"><a href="adventures-in-covariance.html#cb1484-1"></a>b13<span class="fl">.3</span> &lt;-<span class="st"> </span></span>
<span id="cb1484-2"><a href="adventures-in-covariance.html#cb1484-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </span>
<span id="cb1484-3"><a href="adventures-in-covariance.html#cb1484-3"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1484-4"><a href="adventures-in-covariance.html#cb1484-4"></a>      admit <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>male <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>male <span class="op">|</span><span class="st"> </span>dept_id),</span>
<span id="cb1484-5"><a href="adventures-in-covariance.html#cb1484-5"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1484-6"><a href="adventures-in-covariance.html#cb1484-6"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</span>
<span id="cb1484-7"><a href="adventures-in-covariance.html#cb1484-7"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">class =</span> sd),</span>
<span id="cb1484-8"><a href="adventures-in-covariance.html#cb1484-8"></a>                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">2</span>), <span class="dt">class =</span> cor)),</span>
<span id="cb1484-9"><a href="adventures-in-covariance.html#cb1484-9"></a>      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</span>
<span id="cb1484-10"><a href="adventures-in-covariance.html#cb1484-10"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1484-11"><a href="adventures-in-covariance.html#cb1484-11"></a>      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.99</span>,</span>
<span id="cb1484-12"><a href="adventures-in-covariance.html#cb1484-12"></a>                     <span class="dt">max_treedepth =</span> <span class="dv">12</span>),</span>
<span id="cb1484-13"><a href="adventures-in-covariance.html#cb1484-13"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.03&quot;</span>)</span></code></pre></div>
<p>McElreath encouraged us to make sure the chains look good. Instead of relying on convenience functions, let’s do it by hand.</p>
<div class="sourceCode" id="cb1485"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1485-1"><a href="adventures-in-covariance.html#cb1485-1"></a>post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.3</span>, <span class="dt">add_chain =</span> T)</span>
<span id="cb1485-2"><a href="adventures-in-covariance.html#cb1485-2"></a></span>
<span id="cb1485-3"><a href="adventures-in-covariance.html#cb1485-3"></a>post <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1485-4"><a href="adventures-in-covariance.html#cb1485-4"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>lp__) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1485-5"><a href="adventures-in-covariance.html#cb1485-5"></a><span class="st">  </span><span class="kw">gather</span>(key, value, <span class="op">-</span>chain, <span class="op">-</span>iter) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1485-6"><a href="adventures-in-covariance.html#cb1485-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">chain =</span> <span class="kw">as.character</span>(chain)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1485-7"><a href="adventures-in-covariance.html#cb1485-7"></a></span>
<span id="cb1485-8"><a href="adventures-in-covariance.html#cb1485-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> iter, <span class="dt">y =</span> value, <span class="dt">group =</span> chain, <span class="dt">color =</span> chain)) <span class="op">+</span></span>
<span id="cb1485-9"><a href="adventures-in-covariance.html#cb1485-9"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">15</span>) <span class="op">+</span></span>
<span id="cb1485-10"><a href="adventures-in-covariance.html#cb1485-10"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#B1934A&quot;</span>, <span class="st">&quot;#A65141&quot;</span>, <span class="st">&quot;#EEDA9D&quot;</span>)) <span class="op">+</span></span>
<span id="cb1485-11"><a href="adventures-in-covariance.html#cb1485-11"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">1001</span>, <span class="dv">5000</span>)) <span class="op">+</span></span>
<span id="cb1485-12"><a href="adventures-in-covariance.html#cb1485-12"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1485-13"><a href="adventures-in-covariance.html#cb1485-13"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(.<span class="dv">825</span>, <span class="fl">.06</span>),</span>
<span id="cb1485-14"><a href="adventures-in-covariance.html#cb1485-14"></a>                      <span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>) <span class="op">+</span></span>
<span id="cb1485-15"><a href="adventures-in-covariance.html#cb1485-15"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>key, <span class="dt">ncol =</span> <span class="dv">3</span>, <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>)</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-36-1.png" width="768" /></p>
<p>Our chains look great. While we’re at it, let’s examine the <span class="math inline">\(\widehat R\)</span> vales in a handmade plot, too.</p>
<div class="sourceCode" id="cb1486"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1486-1"><a href="adventures-in-covariance.html#cb1486-1"></a>brms<span class="op">::</span><span class="kw">rhat</span>(b13<span class="fl">.3</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1486-2"><a href="adventures-in-covariance.html#cb1486-2"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1486-3"><a href="adventures-in-covariance.html#cb1486-3"></a><span class="st">  </span><span class="kw">rownames_to_column</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1486-4"><a href="adventures-in-covariance.html#cb1486-4"></a><span class="st">  </span><span class="kw">set_names</span>(<span class="st">&quot;parameter&quot;</span>, <span class="st">&quot;rhat&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1486-5"><a href="adventures-in-covariance.html#cb1486-5"></a><span class="st">  </span><span class="kw">filter</span>(parameter <span class="op">!=</span><span class="st"> &quot;lp__&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1486-6"><a href="adventures-in-covariance.html#cb1486-6"></a><span class="st">  </span></span>
<span id="cb1486-7"><a href="adventures-in-covariance.html#cb1486-7"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> rhat, <span class="dt">y =</span> <span class="kw">reorder</span>(parameter, rhat))) <span class="op">+</span><span class="st"> </span></span>
<span id="cb1486-8"><a href="adventures-in-covariance.html#cb1486-8"></a><span class="st">  </span><span class="kw">geom_segment</span>(<span class="kw">aes</span>(<span class="dt">xend =</span> <span class="dv">1</span>, <span class="dt">yend =</span> parameter),</span>
<span id="cb1486-9"><a href="adventures-in-covariance.html#cb1486-9"></a>               <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></span>
<span id="cb1486-10"><a href="adventures-in-covariance.html#cb1486-10"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">color =</span> rhat <span class="op">&gt;</span><span class="st"> </span><span class="dv">1</span>), </span>
<span id="cb1486-11"><a href="adventures-in-covariance.html#cb1486-11"></a>             <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1486-12"><a href="adventures-in-covariance.html#cb1486-12"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></span>
<span id="cb1486-13"><a href="adventures-in-covariance.html#cb1486-13"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1486-14"><a href="adventures-in-covariance.html#cb1486-14"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb1486-15"><a href="adventures-in-covariance.html#cb1486-15"></a>                      <span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb1486-16"><a href="adventures-in-covariance.html#cb1486-16"></a>                      <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-37-1.png" width="768" /></p>
<p>Them are some respectable <span class="math inline">\(\widehat R\)</span> values. The plot accentuates their differences, but they’re all basically 1 (e.g., see what happens if you set <code>coord_cartesian(xlim = c(0.99, 1.01))</code>). Here are the random effects in the <strong>centered</strong> metric.</p>
<div class="sourceCode" id="cb1487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1487-1"><a href="adventures-in-covariance.html#cb1487-1"></a><span class="kw">coef</span>(b13<span class="fl">.3</span>)</span></code></pre></div>
<pre><code>## $dept_id
## , , Intercept
## 
##     Estimate  Est.Error        Q2.5      Q97.5
## 1  1.3057992 0.25211661  0.81577063  1.8090057
## 2  0.7406968 0.33040707  0.09460153  1.4017626
## 3 -0.6479022 0.08554789 -0.81714957 -0.4835139
## 4 -0.6187186 0.10494188 -0.82761448 -0.4142650
## 5 -1.1348169 0.11496109 -1.36131022 -0.9127530
## 6 -2.6025090 0.20203070 -3.01085755 -2.2199090
## 
## , , male
## 
##      Estimate Est.Error       Q2.5      Q97.5
## 1 -0.79351604 0.2645523 -1.3168182 -0.2696213
## 2 -0.20966913 0.3304663 -0.8719098  0.4421178
## 3  0.08340448 0.1401331 -0.1867136  0.3618156
## 4 -0.09044680 0.1397284 -0.3625209  0.1831231
## 5  0.12324915 0.1870468 -0.2329093  0.4956381
## 6 -0.12281950 0.2684655 -0.6570583  0.3918036</code></pre>
<p>We may as well keep our doing-things-by-hand kick going. Instead relying on <code>bayesplog::mcmc_intervals()</code> or <code>tidybayes::pointinterval()</code> to make our coefficient plot, we’ll use <code>geom_pointrange()</code>. But we will need to wrangle a bit to get those brms-based <strong>centered</strong> random effects into a usefully-formatted tidy tibble.</p>
<div class="sourceCode" id="cb1489"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1489-1"><a href="adventures-in-covariance.html#cb1489-1"></a><span class="co"># as far as I can tell, because `coef()` yields a list, you have to take out the two </span></span>
<span id="cb1489-2"><a href="adventures-in-covariance.html#cb1489-2"></a><span class="co"># random effects one at a time and then bind them together to get them ready for a tibble</span></span>
<span id="cb1489-3"><a href="adventures-in-covariance.html#cb1489-3"></a><span class="kw">rbind</span>(<span class="kw">coef</span>(b13<span class="fl">.3</span>)<span class="op">$</span>dept_id[, , <span class="dv">1</span>],</span>
<span id="cb1489-4"><a href="adventures-in-covariance.html#cb1489-4"></a>      <span class="kw">coef</span>(b13<span class="fl">.3</span>)<span class="op">$</span>dept_id[, , <span class="dv">2</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1489-5"><a href="adventures-in-covariance.html#cb1489-5"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1489-6"><a href="adventures-in-covariance.html#cb1489-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">param   =</span> <span class="kw">c</span>(<span class="kw">str_c</span>(<span class="st">&quot;Intercept &quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>), <span class="kw">str_c</span>(<span class="st">&quot;male &quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">6</span>)),</span>
<span id="cb1489-7"><a href="adventures-in-covariance.html#cb1489-7"></a>         <span class="dt">reorder =</span> <span class="kw">c</span>(<span class="dv">6</span><span class="op">:</span><span class="dv">1</span>, <span class="dv">12</span><span class="op">:</span><span class="dv">7</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1489-8"><a href="adventures-in-covariance.html#cb1489-8"></a></span>
<span id="cb1489-9"><a href="adventures-in-covariance.html#cb1489-9"></a><span class="st">  </span><span class="co"># plot</span></span>
<span id="cb1489-10"><a href="adventures-in-covariance.html#cb1489-10"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> <span class="kw">reorder</span>(param, reorder))) <span class="op">+</span></span>
<span id="cb1489-11"><a href="adventures-in-covariance.html#cb1489-11"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">linetype =</span> <span class="dv">3</span>, <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></span>
<span id="cb1489-12"><a href="adventures-in-covariance.html#cb1489-12"></a><span class="st">  </span><span class="kw">geom_pointrange</span>(<span class="kw">aes</span>(<span class="dt">xmin =</span> Q2<span class="fl">.5</span>, <span class="dt">xmax =</span> Q97<span class="fl">.5</span>, <span class="dt">x =</span> Estimate, <span class="dt">color =</span> reorder <span class="op">&lt;</span><span class="st"> </span><span class="dv">7</span>),</span>
<span id="cb1489-13"><a href="adventures-in-covariance.html#cb1489-13"></a>                  <span class="dt">shape =</span> <span class="dv">20</span>, <span class="dt">size =</span> <span class="dv">3</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb1489-14"><a href="adventures-in-covariance.html#cb1489-14"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#394165&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></span>
<span id="cb1489-15"><a href="adventures-in-covariance.html#cb1489-15"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1489-16"><a href="adventures-in-covariance.html#cb1489-16"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</span>
<span id="cb1489-17"><a href="adventures-in-covariance.html#cb1489-17"></a>                      <span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb1489-18"><a href="adventures-in-covariance.html#cb1489-18"></a>                      <span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-39-1.png" width="624" /></p>
<p>Just like in the text, our <code>male</code> slopes are much less dispersed than our intercepts.</p>
</div>
<div id="shrinkage." class="section level3">
<h3><span class="header-section-number">13.2.3</span> Shrinkage.</h3>
<p>Figure 13.6.a depicts the correlation between the full UCB model’s varying intercepts and slopes.</p>
<div class="sourceCode" id="cb1490"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1490-1"><a href="adventures-in-covariance.html#cb1490-1"></a>post &lt;-<span class="st"> </span><span class="kw">posterior_samples</span>(b13<span class="fl">.3</span>)</span>
<span id="cb1490-2"><a href="adventures-in-covariance.html#cb1490-2"></a></span>
<span id="cb1490-3"><a href="adventures-in-covariance.html#cb1490-3"></a>post <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1490-4"><a href="adventures-in-covariance.html#cb1490-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> cor_dept_id__Intercept__male, <span class="dt">y =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1490-5"><a href="adventures-in-covariance.html#cb1490-5"></a><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">point_interval =</span> median_qi, <span class="dt">.width =</span> <span class="fl">.95</span>, </span>
<span id="cb1490-6"><a href="adventures-in-covariance.html#cb1490-6"></a>               <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></span>
<span id="cb1490-7"><a href="adventures-in-covariance.html#cb1490-7"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="kw">median</span>(post<span class="op">$</span>cor_dept_id__Intercept__male), <span class="dv">1</span>),</span>
<span id="cb1490-8"><a href="adventures-in-covariance.html#cb1490-8"></a>                     <span class="dt">labels =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="st">&quot;-.35&quot;</span>, <span class="dv">1</span>), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb1490-9"><a href="adventures-in-covariance.html#cb1490-9"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1490-10"><a href="adventures-in-covariance.html#cb1490-10"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;The dot is at the median; the</span><span class="ch">\n</span><span class="st">horizontal bar is the 95% CI.&quot;</span>,</span>
<span id="cb1490-11"><a href="adventures-in-covariance.html#cb1490-11"></a>       <span class="dt">x =</span> <span class="st">&quot;correlation&quot;</span>) <span class="op">+</span></span>
<span id="cb1490-12"><a href="adventures-in-covariance.html#cb1490-12"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-40-1.png" width="288" /></p>
<p>Much like for Figure 13.5.b, above, it’ll take a little data processing before we’re ready to reproduce Figure 13.6.b.</p>
<div class="sourceCode" id="cb1491"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1491-1"><a href="adventures-in-covariance.html#cb1491-1"></a><span class="co"># here we put the partially-pooled estimate summaries in a tibble</span></span>
<span id="cb1491-2"><a href="adventures-in-covariance.html#cb1491-2"></a>partially_pooled_params &lt;-</span>
<span id="cb1491-3"><a href="adventures-in-covariance.html#cb1491-3"></a><span class="st">  </span><span class="kw">coef</span>(b13<span class="fl">.3</span>)<span class="op">$</span>dept_id[ , <span class="dv">1</span>, ] <span class="op">%&gt;%</span></span>
<span id="cb1491-4"><a href="adventures-in-covariance.html#cb1491-4"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></span>
<span id="cb1491-5"><a href="adventures-in-covariance.html#cb1491-5"></a><span class="st">  </span><span class="kw">set_names</span>(<span class="st">&quot;intercept&quot;</span>, <span class="st">&quot;slope&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1491-6"><a href="adventures-in-covariance.html#cb1491-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dept =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span></span>
<span id="cb1491-7"><a href="adventures-in-covariance.html#cb1491-7"></a><span class="st">  </span><span class="kw">select</span>(dept, <span class="kw">everything</span>())</span>
<span id="cb1491-8"><a href="adventures-in-covariance.html#cb1491-8"></a></span>
<span id="cb1491-9"><a href="adventures-in-covariance.html#cb1491-9"></a><span class="co"># in order to calculate the unpooled estimates from the data, we&#39;ll need a function that </span></span>
<span id="cb1491-10"><a href="adventures-in-covariance.html#cb1491-10"></a><span class="co"># can convert probabilities into the logit metric. if you do the algebra, this is just</span></span>
<span id="cb1491-11"><a href="adventures-in-covariance.html#cb1491-11"></a><span class="co"># a transformation of the `inv_logit_scaled()` function.</span></span>
<span id="cb1491-12"><a href="adventures-in-covariance.html#cb1491-12"></a>prob_to_logit &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</span>
<span id="cb1491-13"><a href="adventures-in-covariance.html#cb1491-13"></a>  <span class="op">-</span><span class="kw">log</span>((<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>x) <span class="dv">-1</span>)</span>
<span id="cb1491-14"><a href="adventures-in-covariance.html#cb1491-14"></a>}</span>
<span id="cb1491-15"><a href="adventures-in-covariance.html#cb1491-15"></a></span>
<span id="cb1491-16"><a href="adventures-in-covariance.html#cb1491-16"></a><span class="co"># compute unpooled estimates directly from data</span></span>
<span id="cb1491-17"><a href="adventures-in-covariance.html#cb1491-17"></a>un_pooled_params &lt;-</span>
<span id="cb1491-18"><a href="adventures-in-covariance.html#cb1491-18"></a><span class="st">  </span>d <span class="op">%&gt;%</span></span>
<span id="cb1491-19"><a href="adventures-in-covariance.html#cb1491-19"></a><span class="st">  </span><span class="kw">group_by</span>(male, dept_id) <span class="op">%&gt;%</span></span>
<span id="cb1491-20"><a href="adventures-in-covariance.html#cb1491-20"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">prob_admit =</span> <span class="kw">mean</span>(admit <span class="op">/</span><span class="st"> </span>applications)) <span class="op">%&gt;%</span></span>
<span id="cb1491-21"><a href="adventures-in-covariance.html#cb1491-21"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb1491-22"><a href="adventures-in-covariance.html#cb1491-22"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">male =</span> <span class="kw">ifelse</span>(male <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;intercept&quot;</span>, <span class="st">&quot;slope&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1491-23"><a href="adventures-in-covariance.html#cb1491-23"></a><span class="st">  </span><span class="kw">spread</span>(<span class="dt">key  =</span> male, <span class="dt">value =</span> prob_admit) <span class="op">%&gt;%</span></span>
<span id="cb1491-24"><a href="adventures-in-covariance.html#cb1491-24"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">dept =</span> dept_id) <span class="op">%&gt;%</span></span>
<span id="cb1491-25"><a href="adventures-in-covariance.html#cb1491-25"></a><span class="st">  </span><span class="co"># here we put our `prob_to_logit()` function to work</span></span>
<span id="cb1491-26"><a href="adventures-in-covariance.html#cb1491-26"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">intercept =</span> <span class="kw">prob_to_logit</span>(intercept),</span>
<span id="cb1491-27"><a href="adventures-in-covariance.html#cb1491-27"></a>         <span class="dt">slope     =</span> <span class="kw">prob_to_logit</span>(slope)) <span class="op">%&gt;%</span></span>
<span id="cb1491-28"><a href="adventures-in-covariance.html#cb1491-28"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">slope =</span> slope <span class="op">-</span><span class="st"> </span>intercept)</span>
<span id="cb1491-29"><a href="adventures-in-covariance.html#cb1491-29"></a></span>
<span id="cb1491-30"><a href="adventures-in-covariance.html#cb1491-30"></a><span class="co"># here we combine the partially-pooled and unpooled means into a single data object</span></span>
<span id="cb1491-31"><a href="adventures-in-covariance.html#cb1491-31"></a>params &lt;-</span>
<span id="cb1491-32"><a href="adventures-in-covariance.html#cb1491-32"></a><span class="st">  </span><span class="kw">bind_rows</span>(partially_pooled_params, un_pooled_params) <span class="op">%&gt;%</span></span>
<span id="cb1491-33"><a href="adventures-in-covariance.html#cb1491-33"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pooled =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;partially&quot;</span>, <span class="st">&quot;not&quot;</span>), <span class="dt">each =</span> <span class="kw">n</span>() <span class="op">/</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1491-34"><a href="adventures-in-covariance.html#cb1491-34"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">dept_letter =</span> <span class="kw">rep</span>(LETTERS[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>], <span class="dt">times =</span> <span class="dv">2</span>))  <span class="co"># this will help with plotting</span></span>
<span id="cb1491-35"><a href="adventures-in-covariance.html#cb1491-35"></a></span>
<span id="cb1491-36"><a href="adventures-in-covariance.html#cb1491-36"></a>params</span></code></pre></div>
<pre><code>## # A tibble: 12 x 5
##     dept intercept   slope pooled    dept_letter
##    &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;      
##  1     1     1.31  -0.794  partially A          
##  2     2     0.741 -0.210  partially B          
##  3     3    -0.648  0.0834 partially C          
##  4     4    -0.619 -0.0904 partially D          
##  5     5    -1.13   0.123  partially E          
##  6     6    -2.60  -0.123  partially F          
##  7     1     1.54  -1.05   not       A          
##  8     2     0.754 -0.220  not       B          
##  9     3    -0.660  0.125  not       C          
## 10     4    -0.622 -0.0820 not       D          
## 11     5    -1.16   0.200  not       E          
## 12     6    -2.58  -0.189  not       F</code></pre>
<p>Here’s our version of Figure 13.6.b, depicting two-dimensional shrinkage for the partially-pooled multilevel estimates (posterior means) relative to the unpooled coefficients, calculated from the data. The <code>ggrepel::geom_text_repel()</code> function will help us with the in-plot labels.</p>
<div class="sourceCode" id="cb1493"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1493-1"><a href="adventures-in-covariance.html#cb1493-1"></a><span class="kw">library</span>(ggrepel)</span>
<span id="cb1493-2"><a href="adventures-in-covariance.html#cb1493-2"></a></span>
<span id="cb1493-3"><a href="adventures-in-covariance.html#cb1493-3"></a><span class="kw">ggplot</span>(<span class="dt">data =</span> params, <span class="kw">aes</span>(<span class="dt">x =</span> intercept, <span class="dt">y =</span> slope)) <span class="op">+</span></span>
<span id="cb1493-4"><a href="adventures-in-covariance.html#cb1493-4"></a><span class="st">  </span><span class="kw">mapply</span>(<span class="cf">function</span>(level) {</span>
<span id="cb1493-5"><a href="adventures-in-covariance.html#cb1493-5"></a>    <span class="kw">stat_ellipse</span>(<span class="dt">geom  =</span> <span class="st">&quot;polygon&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;norm&quot;</span>,</span>
<span id="cb1493-6"><a href="adventures-in-covariance.html#cb1493-6"></a>                 <span class="dt">size  =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">20</span>, <span class="dt">fill =</span> <span class="st">&quot;#E7CDC2&quot;</span>,</span>
<span id="cb1493-7"><a href="adventures-in-covariance.html#cb1493-7"></a>                 <span class="dt">level =</span> level)</span>
<span id="cb1493-8"><a href="adventures-in-covariance.html#cb1493-8"></a>    },  </span>
<span id="cb1493-9"><a href="adventures-in-covariance.html#cb1493-9"></a>    <span class="dt">level =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">to =</span> <span class="dv">9</span><span class="op">/</span><span class="dv">10</span>, <span class="dt">by =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">10</span>), <span class="fl">.99</span>)) <span class="op">+</span></span>
<span id="cb1493-10"><a href="adventures-in-covariance.html#cb1493-10"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">group =</span> dept, <span class="dt">color =</span> pooled)) <span class="op">+</span></span>
<span id="cb1493-11"><a href="adventures-in-covariance.html#cb1493-11"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> dept), <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>) <span class="op">+</span></span>
<span id="cb1493-12"><a href="adventures-in-covariance.html#cb1493-12"></a><span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="st">&quot;Pooled?&quot;</span>,</span>
<span id="cb1493-13"><a href="adventures-in-covariance.html#cb1493-13"></a>                     <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#80A0C7&quot;</span>, <span class="st">&quot;#A65141&quot;</span>)) <span class="op">+</span></span>
<span id="cb1493-14"><a href="adventures-in-covariance.html#cb1493-14"></a><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> params <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(pooled <span class="op">==</span><span class="st"> &quot;partially&quot;</span>),</span>
<span id="cb1493-15"><a href="adventures-in-covariance.html#cb1493-15"></a>                  <span class="kw">aes</span>(<span class="dt">label =</span> dept_letter),</span>
<span id="cb1493-16"><a href="adventures-in-covariance.html#cb1493-16"></a>                  <span class="dt">color =</span> <span class="st">&quot;#E8DCCF&quot;</span>, <span class="dt">size =</span> <span class="dv">4</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">seed =</span> <span class="fl">13.6</span>) <span class="op">+</span></span>
<span id="cb1493-17"><a href="adventures-in-covariance.html#cb1493-17"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="kw">expression</span>(<span class="st">&quot;intercept (&quot;</span><span class="op">*</span>alpha[dept_id]<span class="op">*</span><span class="st">&quot;)&quot;</span>),</span>
<span id="cb1493-18"><a href="adventures-in-covariance.html#cb1493-18"></a>       <span class="dt">y =</span> <span class="kw">expression</span>(<span class="st">&quot;slope (&quot;</span><span class="op">*</span>beta[dept_id]<span class="op">*</span><span class="st">&quot;)&quot;</span>)) <span class="op">+</span></span>
<span id="cb1493-19"><a href="adventures-in-covariance.html#cb1493-19"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(params<span class="op">$</span>intercept),</span>
<span id="cb1493-20"><a href="adventures-in-covariance.html#cb1493-20"></a>                  <span class="dt">ylim =</span> <span class="kw">range</span>(params<span class="op">$</span>slope)) <span class="op">+</span></span>
<span id="cb1493-21"><a href="adventures-in-covariance.html#cb1493-21"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-42-1.png" width="480" /></p>
</div>
<div id="model-comparison.-1" class="section level3">
<h3><span class="header-section-number">13.2.4</span> Model comparison.</h3>
<p>Fit the no-gender model.</p>
<div class="sourceCode" id="cb1494"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1494-1"><a href="adventures-in-covariance.html#cb1494-1"></a>b13<span class="fl">.4</span> &lt;-<span class="st"> </span></span>
<span id="cb1494-2"><a href="adventures-in-covariance.html#cb1494-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </span>
<span id="cb1494-3"><a href="adventures-in-covariance.html#cb1494-3"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1494-4"><a href="adventures-in-covariance.html#cb1494-4"></a>      admit <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>dept_id),</span>
<span id="cb1494-5"><a href="adventures-in-covariance.html#cb1494-5"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1494-6"><a href="adventures-in-covariance.html#cb1494-6"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">class =</span> sd)),</span>
<span id="cb1494-7"><a href="adventures-in-covariance.html#cb1494-7"></a>      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</span>
<span id="cb1494-8"><a href="adventures-in-covariance.html#cb1494-8"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1494-9"><a href="adventures-in-covariance.html#cb1494-9"></a>      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.99</span>,</span>
<span id="cb1494-10"><a href="adventures-in-covariance.html#cb1494-10"></a>                     <span class="dt">max_treedepth =</span> <span class="dv">12</span>),</span>
<span id="cb1494-11"><a href="adventures-in-covariance.html#cb1494-11"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.04&quot;</span>)</span></code></pre></div>
<p>Compare the three models by the WAIC.</p>
<div class="sourceCode" id="cb1495"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1495-1"><a href="adventures-in-covariance.html#cb1495-1"></a>b13<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.2</span>, <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1495-2"><a href="adventures-in-covariance.html#cb1495-2"></a>b13<span class="fl">.3</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.3</span>, <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1495-3"><a href="adventures-in-covariance.html#cb1495-3"></a>b13<span class="fl">.4</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.4</span>, <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1495-4"><a href="adventures-in-covariance.html#cb1495-4"></a></span>
<span id="cb1495-5"><a href="adventures-in-covariance.html#cb1495-5"></a><span class="kw">loo_compare</span>(b13<span class="fl">.2</span>, b13<span class="fl">.3</span>, b13<span class="fl">.4</span>, <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1495-6"><a href="adventures-in-covariance.html#cb1495-6"></a><span class="st">  </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</span></code></pre></div>
<pre><code>##       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic  se_waic
## b13.3   0.0       0.0   -45.5       2.3          6.8    1.4      91.1   4.7  
## b13.4  -7.1       7.6   -52.6       9.0          6.6    2.3     105.3  18.0  
## b13.2  -8.5       6.7   -54.0       8.2          9.2    2.9     108.1  16.5</code></pre>
<p>In terms of the WAIC estimates and <span class="math inline">\(\text{elpd}\)</span> differences, the models are similar. The story changes when we look at the WAIC weights.</p>
<div class="sourceCode" id="cb1497"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1497-1"><a href="adventures-in-covariance.html#cb1497-1"></a><span class="kw">model_weights</span>(b13<span class="fl">.2</span>, b13<span class="fl">.3</span>, b13<span class="fl">.4</span>, <span class="dt">weights =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1497-2"><a href="adventures-in-covariance.html#cb1497-2"></a><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## b13.2 b13.3 b13.4 
## 0.000 0.999 0.001</code></pre>
<blockquote>
<p>The varying slopes model, [<code>b13.3</code>], dominates [the other two]. This is despite the fact that the <em>average</em> slope in [<code>b13.3</code>] is nearly zero. The average isn’t what matters, however. It is the individual slopes, one for each department, that matter. If we wish to generalize to new departments, the variation in slopes suggest that it’ll be worth paying attention to gender, even if the average slope is nearly zero in the population. (pp. 402–403, <em>emphasis</em> in the original)</p>
</blockquote>
</div>
<div id="more-slopes." class="section level3">
<h3><span class="header-section-number">13.2.5</span> More slopes.</h3>
<blockquote>
<p>The varying slopes strategy generalizes to as many slopes as you like, within practical limits. All that happens is that each new predictor you want to construct varying slopes for adds one more dimension to the covariance matrix of the varying effects prior. So this means one more standard deviation parameter and one more dimension to the correlation matrix. (p. 403)</p>
</blockquote>
</div>
</div>
<div id="example-cross-classified-chimpanzees-with-varying-slopes" class="section level2">
<h2><span class="header-section-number">13.3</span> Example: Cross-classified <code>chimpanzees</code> with varying slopes</h2>
<p>Retrieve the <code>chimpanzees</code> data.</p>
<div class="sourceCode" id="cb1499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1499-1"><a href="adventures-in-covariance.html#cb1499-1"></a><span class="kw">library</span>(rethinking)</span>
<span id="cb1499-2"><a href="adventures-in-covariance.html#cb1499-2"></a><span class="kw">data</span>(chimpanzees)</span>
<span id="cb1499-3"><a href="adventures-in-covariance.html#cb1499-3"></a>d &lt;-<span class="st"> </span>chimpanzees</span></code></pre></div>
<div class="sourceCode" id="cb1500"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1500-1"><a href="adventures-in-covariance.html#cb1500-1"></a><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</span>
<span id="cb1500-2"><a href="adventures-in-covariance.html#cb1500-2"></a><span class="kw">library</span>(brms)</span>
<span id="cb1500-3"><a href="adventures-in-covariance.html#cb1500-3"></a><span class="kw">rm</span>(chimpanzees)</span>
<span id="cb1500-4"><a href="adventures-in-covariance.html#cb1500-4"></a></span>
<span id="cb1500-5"><a href="adventures-in-covariance.html#cb1500-5"></a>d &lt;-</span>
<span id="cb1500-6"><a href="adventures-in-covariance.html#cb1500-6"></a><span class="st">  </span>d <span class="op">%&gt;%</span></span>
<span id="cb1500-7"><a href="adventures-in-covariance.html#cb1500-7"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>recipient) <span class="op">%&gt;%</span></span>
<span id="cb1500-8"><a href="adventures-in-covariance.html#cb1500-8"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">block_id =</span> block)</span></code></pre></div>
<p>My maths aren’t the best. But if I’m following along correctly, here’s a fuller statistical expression of our cross-classified model.</p>
<p><span class="math display">\[\begin{align*}
\text{pulled_left}_i      &amp; \sim \operatorname{Binomial}(n = 1, p_i) \\
\operatorname{logit}(p_i) &amp; = \alpha_i + (\beta_{1i} + \beta_{2i} \text{condition}_i) \text{prosoc_left}_i  \\
\alpha_i                  &amp; = \alpha + \alpha_{\text{actor}_i} + \alpha_{\text{block_id}_i} \\
\beta_{1i}                &amp; = \beta_1 + \beta_{1, \text{actor}_i} + \beta_{1, \text{block_id}_i} \\
\beta_{2i}                &amp; = \beta_2 + \beta_{2, \text{actor}_i} + \beta_{2, \text{block_id}_i} \\
\begin{bmatrix} \alpha_\text{actor} \\ \beta_{1, \text{actor}} \\ \beta_{2, \text{actor}} \end{bmatrix} &amp; \sim \operatorname{MVNormal} \left ( \begin{bmatrix}0 \\ 0 \\ 0 \end{bmatrix} , \mathbf{S}_\text{actor} \right ) \\
\begin{bmatrix} \alpha_\text{block_id} \\ \beta_{1, \text{block_id}} \\ \beta_{2, \text{block_id}} \end{bmatrix} &amp; \sim \operatorname{MVNormal} \left ( \begin{bmatrix}0 \\ 0 \\ 0 \end{bmatrix} , \mathbf{S}_\text{block_id} \right ) \\

\mathbf S_\text{actor}    &amp; = \begin{bmatrix} \sigma_{\alpha_\text{actor}} &amp; 0 &amp; 0 \\ 0 &amp; \sigma_{\beta_{1_\text{actor}}} &amp; 0 \\ 0 &amp; 0 &amp; \sigma_{\beta_{2_\text{actor}}} \end{bmatrix} 
\mathbf R_\text{actor} \begin{bmatrix} \sigma_{\alpha_\text{actor}} &amp; 0 &amp; 0 \\ 0 &amp; \sigma_{\beta_{1_\text{actor}}} &amp; 0 \\ 0 &amp; 0 &amp; \sigma_{\beta_{2_\text{actor}}} \end{bmatrix} \\
\mathbf S_\text{block_id} &amp; = \begin{bmatrix} \sigma_{\alpha_\text{block_id}} &amp; 0 &amp; 0 \\ 0 &amp; \sigma_{\beta_{1_\text{block_id}}} &amp; 0 \\ 0 &amp; 0 &amp; \sigma_{\beta_{2_\text{block_id}}} \end{bmatrix} 
\mathbf R_\text{block_id} \begin{bmatrix} \sigma_{\alpha_\text{block_id}} &amp; 0 &amp; 0 \\ 0 &amp; \sigma_{\beta_{1_\text{block_id}}} &amp; 0 \\ 0 &amp; 0 &amp; \sigma_{\beta_{2_\text{block_id}}} \end{bmatrix} \\

\alpha                    &amp; \sim \operatorname{Normal}(0, 1) \\
\beta_1                   &amp; \sim \operatorname{Normal}(0, 1) \\
\beta_2                   &amp; \sim \operatorname{Normal}(0, 1) \\
\sigma_{\alpha_\text{actor}}, \sigma_{\beta_{1_\text{actor}}}, \sigma_{\beta_{2_\text{actor}}} &amp; \sim \operatorname{HalfCauchy}(0, 2) \\
\sigma_{\alpha_\text{block_id}}, \sigma_{\beta_{1_\text{block_id}}}, \sigma_{\beta_{2_\text{block_id}}} &amp; \sim \operatorname{HalfCauchy}(0, 2) \\
\mathbf R_\text{actor}    &amp; \sim \operatorname{LKJcorr}(4) \\
\mathbf R_\text{block_id} &amp; \sim \operatorname{LKJcorr}(4),
\end{align*}\]</span></p>
<p>where each <span class="math inline">\(\mathbf R\)</span> is a <span class="math inline">\(3 \times 3\)</span> correlation matrix.</p>
<p>Let’s fit this beast.</p>
<div class="sourceCode" id="cb1501"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1501-1"><a href="adventures-in-covariance.html#cb1501-1"></a>b13<span class="fl">.6</span> &lt;-<span class="st"> </span></span>
<span id="cb1501-2"><a href="adventures-in-covariance.html#cb1501-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </span>
<span id="cb1501-3"><a href="adventures-in-covariance.html#cb1501-3"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1501-4"><a href="adventures-in-covariance.html#cb1501-4"></a>      pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>prosoc_left <span class="op">+</span><span class="st"> </span>condition<span class="op">:</span>prosoc_left <span class="op">+</span></span>
<span id="cb1501-5"><a href="adventures-in-covariance.html#cb1501-5"></a><span class="st">        </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>prosoc_left <span class="op">+</span><span class="st"> </span>condition<span class="op">:</span>prosoc_left <span class="op">|</span><span class="st"> </span>actor) <span class="op">+</span></span>
<span id="cb1501-6"><a href="adventures-in-covariance.html#cb1501-6"></a><span class="st">        </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>prosoc_left <span class="op">+</span><span class="st"> </span>condition<span class="op">:</span>prosoc_left <span class="op">|</span><span class="st"> </span>block_id),</span>
<span id="cb1501-7"><a href="adventures-in-covariance.html#cb1501-7"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1501-8"><a href="adventures-in-covariance.html#cb1501-8"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b),</span>
<span id="cb1501-9"><a href="adventures-in-covariance.html#cb1501-9"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="dt">class =</span> sd),</span>
<span id="cb1501-10"><a href="adventures-in-covariance.html#cb1501-10"></a>                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">4</span>), <span class="dt">class =</span> cor)),</span>
<span id="cb1501-11"><a href="adventures-in-covariance.html#cb1501-11"></a>      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">3</span>, <span class="dt">cores =</span> <span class="dv">3</span>,</span>
<span id="cb1501-12"><a href="adventures-in-covariance.html#cb1501-12"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1501-13"><a href="adventures-in-covariance.html#cb1501-13"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.06&quot;</span>)</span></code></pre></div>
<p>Even though it’s not apparent in the syntax, our model <code>b13.6</code> was already fit using the <a href="https://github.com/paul-buerkner/brms/issues/211">non-centered parameterization. Behind the scenes, Bürkner has brms do this automatically</a>. It’s been that way all along.</p>
<p>Our Figure 13.7 will differ from McElreath’s in two important ways. Since we only fit the model using the non-centered parameterization, we won’t have a boxplot corresponding to the one McElreath made for <code>m13.6</code>. With brms, it’s all non-centered all the time. But since brms now returns two measures of effective sample size, bulk and tail, we’ll need two box plots which which to display them.</p>
<div class="sourceCode" id="cb1502"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1502-1"><a href="adventures-in-covariance.html#cb1502-1"></a><span class="kw">library</span>(ggbeeswarm)</span>
<span id="cb1502-2"><a href="adventures-in-covariance.html#cb1502-2"></a></span>
<span id="cb1502-3"><a href="adventures-in-covariance.html#cb1502-3"></a><span class="kw">posterior_samples</span>(b13<span class="fl">.6</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1502-4"><a href="adventures-in-covariance.html#cb1502-4"></a><span class="st">  </span><span class="kw">summarise_draws</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1502-5"><a href="adventures-in-covariance.html#cb1502-5"></a><span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;ess&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1502-6"><a href="adventures-in-covariance.html#cb1502-6"></a><span class="st">  </span><span class="kw">gather</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1502-7"><a href="adventures-in-covariance.html#cb1502-7"></a><span class="st">  </span></span>
<span id="cb1502-8"><a href="adventures-in-covariance.html#cb1502-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> key, <span class="dt">y =</span> value)) <span class="op">+</span></span>
<span id="cb1502-9"><a href="adventures-in-covariance.html#cb1502-9"></a><span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#8B9DAF&quot;</span>) <span class="op">+</span></span>
<span id="cb1502-10"><a href="adventures-in-covariance.html#cb1502-10"></a><span class="st">  </span><span class="kw">geom_quasirandom</span>(<span class="dt">method =</span> <span class="st">&quot;tukeyDense&quot;</span>,</span>
<span id="cb1502-11"><a href="adventures-in-covariance.html#cb1502-11"></a>                   <span class="dt">size =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">alpha =</span> <span class="dv">2</span><span class="op">/</span><span class="dv">3</span>) <span class="op">+</span></span>
<span id="cb1502-12"><a href="adventures-in-covariance.html#cb1502-12"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="ot">NA</span>)) <span class="op">+</span></span>
<span id="cb1502-13"><a href="adventures-in-covariance.html#cb1502-13"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;The non-centered parameterization</span><span class="ch">\n</span><span class="st">is the brms default. No fancy</span><span class="ch">\n</span><span class="st">coding required.&quot;</span>,</span>
<span id="cb1502-14"><a href="adventures-in-covariance.html#cb1502-14"></a>       <span class="dt">x =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1502-15"><a href="adventures-in-covariance.html#cb1502-15"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-47-1.png" width="384" /></p>
<p>Did you notice those sweet-looking jittered dots? They came form the handy <a href="https://cran.r-project.org/package=ggbeeswarm">ggbeeswarm package</a> <span class="citation">(Clarke &amp; Sherrill-Mix, <a href="#ref-R-ggbeeswarm" role="doc-biblioref">2017</a>)</span> and its <code>geom_quasirandom()</code>.</p>
<p>McElreath reported this model only has about 18 parameters. Let’s compute the WAIC and check the <code>p_waic</code>.</p>
<div class="sourceCode" id="cb1503"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1503-1"><a href="adventures-in-covariance.html#cb1503-1"></a>b13<span class="fl">.6</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.6</span>, <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1503-2"><a href="adventures-in-covariance.html#cb1503-2"></a></span>
<span id="cb1503-3"><a href="adventures-in-covariance.html#cb1503-3"></a>b13<span class="fl">.6</span><span class="op">$</span>criteria<span class="op">$</span>waic</span></code></pre></div>
<pre><code>## 
## Computed from 12000 by 504 log-likelihood matrix
## 
##           Estimate   SE
## elpd_waic   -267.4 10.0
## p_waic        18.4  0.9
## waic         534.9 19.9</code></pre>
<p>Yep, only about 18. Here are our standard deviation parameters.</p>
<div class="sourceCode" id="cb1505"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1505-1"><a href="adventures-in-covariance.html#cb1505-1"></a><span class="kw">tidy</span>(b13<span class="fl">.6</span>) <span class="op">%&gt;%</span></span>
<span id="cb1505-2"><a href="adventures-in-covariance.html#cb1505-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term , <span class="st">&quot;sd_&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1505-3"><a href="adventures-in-covariance.html#cb1505-3"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.numeric, round, <span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>##                                 term estimate std.error lower upper
## 1                sd_actor__Intercept     2.35      0.91  1.31  4.04
## 2              sd_actor__prosoc_left     0.46      0.38  0.04  1.14
## 3    sd_actor__prosoc_left:condition     0.51      0.48  0.04  1.40
## 4             sd_block_id__Intercept     0.22      0.20  0.02  0.61
## 5           sd_block_id__prosoc_left     0.57      0.41  0.06  1.31
## 6 sd_block_id__prosoc_left:condition     0.52      0.42  0.04  1.30</code></pre>
<p>McElreath discussed <code>rethinking::link()</code> in the middle of page 407. He showed how his <code>link(m13.6NC)</code> code returned a list of four matrices, of which the <code>p</code> matrix was of primary interest. The <code>brms::fitted()</code> function doesn’t work quite the same way, here.</p>
<div class="sourceCode" id="cb1507"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1507-1"><a href="adventures-in-covariance.html#cb1507-1"></a><span class="kw">fitted</span>(b13<span class="fl">.6</span>,</span>
<span id="cb1507-2"><a href="adventures-in-covariance.html#cb1507-2"></a>       <span class="dt">summary =</span> F,</span>
<span id="cb1507-3"><a href="adventures-in-covariance.html#cb1507-3"></a>       <span class="dt">nsamples =</span> <span class="dv">1000</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1507-4"><a href="adventures-in-covariance.html#cb1507-4"></a><span class="st">  </span><span class="kw">str</span>()</span></code></pre></div>
<pre><code>##  num [1:1000, 1:504] 0.394 0.326 0.205 0.275 0.338 ...</code></pre>
<p>First off, recall that <code>fitted()</code> returns summary values, by default. If we want individual values, set <code>summary = FALSE</code>. It’s also the <code>fitted()</code> default to use all posterior iterations, which is 12,000 in this case. To match the text, we need to set <code>nsamples = 1000</code>. But those are just details. The main point is that <code>fitted()</code> only returns one matrix, which is the analogue to the <code>p</code> matrix in the text.</p>
<p>Moving forward, before we can follow along with McElreath’s R code 13.27, we need to refit the simpler model from way back in <a href="multilevel-models.html#two-types-of-cluster.">Chapter 12</a>.</p>
<div class="sourceCode" id="cb1509"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1509-1"><a href="adventures-in-covariance.html#cb1509-1"></a>b12<span class="fl">.5</span> &lt;-<span class="st"> </span></span>
<span id="cb1509-2"><a href="adventures-in-covariance.html#cb1509-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </span>
<span id="cb1509-3"><a href="adventures-in-covariance.html#cb1509-3"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1509-4"><a href="adventures-in-covariance.html#cb1509-4"></a>      pulled_left <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(<span class="dv">1</span>) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>prosoc_left <span class="op">+</span><span class="st"> </span>prosoc_left<span class="op">:</span>condition <span class="op">+</span><span class="st"> </span></span>
<span id="cb1509-5"><a href="adventures-in-covariance.html#cb1509-5"></a><span class="st">           </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>actor) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>block),</span>
<span id="cb1509-6"><a href="adventures-in-covariance.html#cb1509-6"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1509-7"><a href="adventures-in-covariance.html#cb1509-7"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> b),</span>
<span id="cb1509-8"><a href="adventures-in-covariance.html#cb1509-8"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> sd)),</span>
<span id="cb1509-9"><a href="adventures-in-covariance.html#cb1509-9"></a>      <span class="dt">iter =</span> <span class="dv">6000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>, </span>
<span id="cb1509-10"><a href="adventures-in-covariance.html#cb1509-10"></a>      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">0.99</span>),</span>
<span id="cb1509-11"><a href="adventures-in-covariance.html#cb1509-11"></a>      <span class="dt">seed =</span> <span class="dv">12</span>,</span>
<span id="cb1509-12"><a href="adventures-in-covariance.html#cb1509-12"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b12.05&quot;</span>)</span></code></pre></div>
<p>Now we can compare them by the WAIC.</p>
<div class="sourceCode" id="cb1510"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1510-1"><a href="adventures-in-covariance.html#cb1510-1"></a>b12<span class="fl">.5</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b12<span class="fl">.5</span>, <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1510-2"><a href="adventures-in-covariance.html#cb1510-2"></a></span>
<span id="cb1510-3"><a href="adventures-in-covariance.html#cb1510-3"></a><span class="kw">loo_compare</span>(b13<span class="fl">.6</span>, b12<span class="fl">.5</span>, <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1510-4"><a href="adventures-in-covariance.html#cb1510-4"></a><span class="st">  </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</span></code></pre></div>
<pre><code>##       elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic   se_waic
## b12.5    0.0       0.0  -266.3       9.8         10.4    0.5     532.7   19.7 
## b13.6   -1.1       2.0  -267.4      10.0         18.4    0.9     534.9   19.9</code></pre>
<p>Here are the WAIC weights.</p>
<div class="sourceCode" id="cb1512"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1512-1"><a href="adventures-in-covariance.html#cb1512-1"></a><span class="kw">model_weights</span>(b13<span class="fl">.6</span>, b12<span class="fl">.5</span>, <span class="dt">weights =</span> <span class="st">&quot;waic&quot;</span>)</span></code></pre></div>
<pre><code>##     b13.6     b12.5 
## 0.2528014 0.7471986</code></pre>
<blockquote>
<p>In this example, no matter which varying effect structure you use, you’ll find that actors vary a lot in their baseline preference for the left-hand lever. Everything else is much less important. But using the most complex model, [<code>b13.6</code>], tells the correct story. Because the varying slopes are adaptively regularized, the model hasn’t overfit much, relative to the simpler model that contains only the important intercept variation. (p. 408)</p>
</blockquote>
</div>
<div id="continuous-categories-and-the-gaussian-process" class="section level2">
<h2><span class="header-section-number">13.4</span> Continuous categories and the Gaussian process</h2>
<blockquote>
<p>There is a way to apply the varying effects approach to continuous categories… The general approach is known as <strong>Gaussian process regression</strong>. This name is unfortunately wholly uninformative about what it is for and how it works.</p>
<p>We’ll proceed to work through a basic example that demonstrates both what it is for and how it works. The general purpose is to define some dimension along which cases differ. This might be individual differences in age. Or it could be differences in location. Then we measure the distance between each pair of cases. What the model then does is estimate a function for the covariance between pairs of cases at different distances. This covariance function provides one continuous category generalization of the varying effects approach. (p. 410, <strong>emphasis</strong> in the original)</p>
</blockquote>
<div id="example-spatial-autocorrelation-in-oceanic-tools." class="section level3">
<h3><span class="header-section-number">13.4.1</span> Example: Spatial autocorrelation in Oceanic tools.</h3>
<p>We start by loading the matrix of geographic distances.</p>
<div class="sourceCode" id="cb1514"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1514-1"><a href="adventures-in-covariance.html#cb1514-1"></a><span class="co"># load the distance matrix</span></span>
<span id="cb1514-2"><a href="adventures-in-covariance.html#cb1514-2"></a><span class="kw">library</span>(rethinking)</span>
<span id="cb1514-3"><a href="adventures-in-covariance.html#cb1514-3"></a><span class="kw">data</span>(islandsDistMatrix)</span>
<span id="cb1514-4"><a href="adventures-in-covariance.html#cb1514-4"></a></span>
<span id="cb1514-5"><a href="adventures-in-covariance.html#cb1514-5"></a><span class="co"># display short column names, so fits on screen</span></span>
<span id="cb1514-6"><a href="adventures-in-covariance.html#cb1514-6"></a>d_mat &lt;-<span class="st"> </span>islandsDistMatrix</span>
<span id="cb1514-7"><a href="adventures-in-covariance.html#cb1514-7"></a><span class="kw">colnames</span>(d_mat) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ml&quot;</span>, <span class="st">&quot;Ti&quot;</span>, <span class="st">&quot;SC&quot;</span>, <span class="st">&quot;Ya&quot;</span>, <span class="st">&quot;Fi&quot;</span>, </span>
<span id="cb1514-8"><a href="adventures-in-covariance.html#cb1514-8"></a>                     <span class="st">&quot;Tr&quot;</span>, <span class="st">&quot;Ch&quot;</span>, <span class="st">&quot;Mn&quot;</span>, <span class="st">&quot;To&quot;</span>, <span class="st">&quot;Ha&quot;</span>)</span>
<span id="cb1514-9"><a href="adventures-in-covariance.html#cb1514-9"></a><span class="kw">round</span>(d_mat, <span class="dv">1</span>)</span></code></pre></div>
<pre><code>##             Ml  Ti  SC  Ya  Fi  Tr  Ch  Mn  To  Ha
## Malekula   0.0 0.5 0.6 4.4 1.2 2.0 3.2 2.8 1.9 5.7
## Tikopia    0.5 0.0 0.3 4.2 1.2 2.0 2.9 2.7 2.0 5.3
## Santa Cruz 0.6 0.3 0.0 3.9 1.6 1.7 2.6 2.4 2.3 5.4
## Yap        4.4 4.2 3.9 0.0 5.4 2.5 1.6 1.6 6.1 7.2
## Lau Fiji   1.2 1.2 1.6 5.4 0.0 3.2 4.0 3.9 0.8 4.9
## Trobriand  2.0 2.0 1.7 2.5 3.2 0.0 1.8 0.8 3.9 6.7
## Chuuk      3.2 2.9 2.6 1.6 4.0 1.8 0.0 1.2 4.8 5.8
## Manus      2.8 2.7 2.4 1.6 3.9 0.8 1.2 0.0 4.6 6.7
## Tonga      1.9 2.0 2.3 6.1 0.8 3.9 4.8 4.6 0.0 5.0
## Hawaii     5.7 5.3 5.4 7.2 4.9 6.7 5.8 6.7 5.0 0.0</code></pre>
<p>If you wanted to use color to more effectively visualize the values in the matrix, you might do something like this.</p>
<div class="sourceCode" id="cb1516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1516-1"><a href="adventures-in-covariance.html#cb1516-1"></a>d_mat <span class="op">%&gt;%</span></span>
<span id="cb1516-2"><a href="adventures-in-covariance.html#cb1516-2"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1516-3"><a href="adventures-in-covariance.html#cb1516-3"></a><span class="st">  </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;row&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1516-4"><a href="adventures-in-covariance.html#cb1516-4"></a><span class="st">  </span><span class="kw">gather</span>(column, distance, <span class="op">-</span>row) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1516-5"><a href="adventures-in-covariance.html#cb1516-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">column =</span> <span class="kw">factor</span>(column, <span class="dt">levels =</span> <span class="kw">colnames</span>(d_mat)),</span>
<span id="cb1516-6"><a href="adventures-in-covariance.html#cb1516-6"></a>         <span class="dt">row    =</span> <span class="kw">factor</span>(row,    <span class="dt">levels =</span> <span class="kw">rownames</span>(d_mat)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fct_rev</span>(),</span>
<span id="cb1516-7"><a href="adventures-in-covariance.html#cb1516-7"></a>         <span class="dt">label  =</span> <span class="kw">if_else</span>(distance <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="st">&quot;0&quot;</span>, <span class="kw">formatC</span>(distance, <span class="dt">format =</span> <span class="st">&#39;f&#39;</span>, <span class="dt">digits =</span> <span class="dv">1</span>))) <span class="op">%&gt;%</span></span>
<span id="cb1516-8"><a href="adventures-in-covariance.html#cb1516-8"></a></span>
<span id="cb1516-9"><a href="adventures-in-covariance.html#cb1516-9"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> column, <span class="dt">y =</span> row, <span class="dt">fill =</span> distance, <span class="dt">label =</span> label)) <span class="op">+</span></span>
<span id="cb1516-10"><a href="adventures-in-covariance.html#cb1516-10"></a><span class="st">  </span><span class="kw">geom_raster</span>() <span class="op">+</span></span>
<span id="cb1516-11"><a href="adventures-in-covariance.html#cb1516-11"></a><span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>) <span class="op">+</span></span>
<span id="cb1516-12"><a href="adventures-in-covariance.html#cb1516-12"></a><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="dt">low =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>) <span class="op">+</span></span>
<span id="cb1516-13"><a href="adventures-in-covariance.html#cb1516-13"></a><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1516-14"><a href="adventures-in-covariance.html#cb1516-14"></a><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1516-15"><a href="adventures-in-covariance.html#cb1516-15"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1516-16"><a href="adventures-in-covariance.html#cb1516-16"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-54-1.png" width="528" /></p>
<p>Figure 13.8 shows the “shape of the function relating distance to the covariance <span class="math inline">\(\mathbf K_{ij}\)</span>.”</p>
<div class="sourceCode" id="cb1517"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1517-1"><a href="adventures-in-covariance.html#cb1517-1"></a><span class="kw">tibble</span>(<span class="dt">x       =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">4</span>, <span class="dt">by =</span> <span class="fl">.01</span>),</span>
<span id="cb1517-2"><a href="adventures-in-covariance.html#cb1517-2"></a>       <span class="dt">linear  =</span> <span class="kw">exp</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x),</span>
<span id="cb1517-3"><a href="adventures-in-covariance.html#cb1517-3"></a>       <span class="dt">squared =</span> <span class="kw">exp</span>(<span class="op">-</span><span class="dv">1</span> <span class="op">*</span><span class="st"> </span>x<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1517-4"><a href="adventures-in-covariance.html#cb1517-4"></a><span class="st">  </span></span>
<span id="cb1517-5"><a href="adventures-in-covariance.html#cb1517-5"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x)) <span class="op">+</span></span>
<span id="cb1517-6"><a href="adventures-in-covariance.html#cb1517-6"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> linear),</span>
<span id="cb1517-7"><a href="adventures-in-covariance.html#cb1517-7"></a>            <span class="dt">color =</span> <span class="st">&quot;#B1934A&quot;</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1517-8"><a href="adventures-in-covariance.html#cb1517-8"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> squared),</span>
<span id="cb1517-9"><a href="adventures-in-covariance.html#cb1517-9"></a>            <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></span>
<span id="cb1517-10"><a href="adventures-in-covariance.html#cb1517-10"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;distance&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1517-11"><a href="adventures-in-covariance.html#cb1517-11"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="st">&quot;correlation&quot;</span>, </span>
<span id="cb1517-12"><a href="adventures-in-covariance.html#cb1517-12"></a>                     <span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">.5</span>, <span class="dv">1</span>),</span>
<span id="cb1517-13"><a href="adventures-in-covariance.html#cb1517-13"></a>                     <span class="dt">labels =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="st">&quot;.5&quot;</span>, <span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb1517-14"><a href="adventures-in-covariance.html#cb1517-14"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-55-1.png" width="312" /></p>
<p>Now load the primary data.</p>
<div class="sourceCode" id="cb1518"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1518-1"><a href="adventures-in-covariance.html#cb1518-1"></a><span class="kw">data</span>(Kline2) <span class="co"># load the ordinary data, now with coordinates</span></span>
<span id="cb1518-2"><a href="adventures-in-covariance.html#cb1518-2"></a></span>
<span id="cb1518-3"><a href="adventures-in-covariance.html#cb1518-3"></a>d &lt;-<span class="st"> </span></span>
<span id="cb1518-4"><a href="adventures-in-covariance.html#cb1518-4"></a><span class="st">  </span>Kline2 <span class="op">%&gt;%</span></span>
<span id="cb1518-5"><a href="adventures-in-covariance.html#cb1518-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">society =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span>
<span id="cb1518-6"><a href="adventures-in-covariance.html#cb1518-6"></a></span>
<span id="cb1518-7"><a href="adventures-in-covariance.html#cb1518-7"></a><span class="kw">rm</span>(Kline2)</span>
<span id="cb1518-8"><a href="adventures-in-covariance.html#cb1518-8"></a></span>
<span id="cb1518-9"><a href="adventures-in-covariance.html#cb1518-9"></a>d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">glimpse</span>()</span></code></pre></div>
<pre><code>## Rows: 10
## Columns: 10
## $ culture     &lt;fct&gt; Malekula, Tikopia, Santa Cruz, Yap, Lau Fiji, Trobriand, Chuuk, Manus, Tonga,…
## $ population  &lt;int&gt; 1100, 1500, 3600, 4791, 7400, 8000, 9200, 13000, 17500, 275000
## $ contact     &lt;fct&gt; low, low, low, high, high, high, high, low, high, low
## $ total_tools &lt;int&gt; 13, 22, 24, 43, 33, 19, 40, 28, 55, 71
## $ mean_TU     &lt;dbl&gt; 3.2, 4.7, 4.0, 5.0, 5.0, 4.0, 3.8, 6.6, 5.4, 6.6
## $ lat         &lt;dbl&gt; -16.3, -12.3, -10.7, 9.5, -17.7, -8.7, 7.4, -2.1, -21.2, 19.9
## $ lon         &lt;dbl&gt; 167.5, 168.8, 166.0, 138.1, 178.1, 150.9, 151.6, 146.9, -175.2, -155.6
## $ lon2        &lt;dbl&gt; -12.5, -11.2, -14.0, -41.9, -1.9, -29.1, -28.4, -33.1, 4.8, 24.4
## $ logpop      &lt;dbl&gt; 7.003065, 7.313220, 8.188689, 8.474494, 8.909235, 8.987197, 9.126959, 9.47270…
## $ society     &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10</code></pre>
<p>Switch out rethinking for brms.</p>
<div class="sourceCode" id="cb1520"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1520-1"><a href="adventures-in-covariance.html#cb1520-1"></a><span class="kw">detach</span>(package<span class="op">:</span>rethinking, <span class="dt">unload =</span> T)</span>
<span id="cb1520-2"><a href="adventures-in-covariance.html#cb1520-2"></a><span class="kw">library</span>(brms)</span></code></pre></div>
<p>👋 <strong>Heads up</strong>: The brms package is capable of handling a variety of Gaussian process models using the <code>gp()</code> function. As we will see throughout this section, this method will depart in important ways from how McElreath fits Gaussian process models with rethinking. Due in large part to these differences, this section baffled me, at first. Happily, fellow enthusiasts <a href="https://twitter.com/LBliard">Louis Bliard</a> and <a href="https://twitter.com/rtorkar">Richard Torkar</a> reached out and helped me hammer this section out behind the scenes. The method to follow is due in large part to their efforts. 🤝</p>
<p>The <code>brms::gp()</code> function takes a handful of arguments. The first and most important argument, <code>...</code>, accepts the names of one or more predictors from the data. When fitting a spatial Gaussian process of this kind, we’ll enter in the latitude and longitude data for each of levels of <code>culture</code>. This will be an important departure from the text. For his <code>m13.7</code>, McElreath directly entered in the <code>Dmat</code> distance matrix data into <code>map2stan()</code>. In so doing, he defined <span class="math inline">\(D_{ij}\)</span>, the matrix of distances between each of the societies. When using brms, we instead <em>estimate</em> the distance matrix from the latitude and longitude variables.</p>
<p>Before we practice fitting a Gaussian process with the <code>brms::gp()</code> function, we’ll first need to think a little bit about our data. McElreath’s <code>Dmat</code> measured the distances in thousands of km. However, the <code>lat</code> and <code>lon2</code> variables in the data above are in decimal degrees, which means they need to be transformed to keep our model in the same metric as McElreath’s. Turns out that <a href="https://en.wikipedia.org/wiki/Decimal_degrees#:~:text=A%20value%20in%20decimal%20degrees,1.1132%20m%20at%20the%20equator.">one decimal degree is 111.32km (at the equator)</a>. Thus, we can turn both <code>lat</code> and <code>lon2</code> into 1000 km units by multiplying each by 0.11132. Here’s the conversion.</p>
<div class="sourceCode" id="cb1521"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1521-1"><a href="adventures-in-covariance.html#cb1521-1"></a>d &lt;-</span>
<span id="cb1521-2"><a href="adventures-in-covariance.html#cb1521-2"></a><span class="st">  </span>d <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1521-3"><a href="adventures-in-covariance.html#cb1521-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lat_adj  =</span> lat  <span class="op">*</span><span class="st"> </span><span class="fl">0.11132</span>,</span>
<span id="cb1521-4"><a href="adventures-in-covariance.html#cb1521-4"></a>         <span class="dt">lon2_adj =</span> lon2 <span class="op">*</span><span class="st"> </span><span class="fl">0.11132</span>)</span>
<span id="cb1521-5"><a href="adventures-in-covariance.html#cb1521-5"></a></span>
<span id="cb1521-6"><a href="adventures-in-covariance.html#cb1521-6"></a>d <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1521-7"><a href="adventures-in-covariance.html#cb1521-7"></a><span class="st">  </span><span class="kw">select</span>(culture, lat, lon2, lat_adj<span class="op">:</span>lon2_adj)</span></code></pre></div>
<pre><code>##       culture   lat  lon2   lat_adj  lon2_adj
## 1    Malekula -16.3 -12.5 -1.814516 -1.391500
## 2     Tikopia -12.3 -11.2 -1.369236 -1.246784
## 3  Santa Cruz -10.7 -14.0 -1.191124 -1.558480
## 4         Yap   9.5 -41.9  1.057540 -4.664308
## 5    Lau Fiji -17.7  -1.9 -1.970364 -0.211508
## 6   Trobriand  -8.7 -29.1 -0.968484 -3.239412
## 7       Chuuk   7.4 -28.4  0.823768 -3.161488
## 8       Manus  -2.1 -33.1 -0.233772 -3.684692
## 9       Tonga -21.2   4.8 -2.359984  0.534336
## 10     Hawaii  19.9  24.4  2.215268  2.716208</code></pre>
<p>Note that because this conversion is valid <strong>at the equator</strong>, it is only an <em>approximation</em> for latitude and longitude coordinates for our island societies.</p>
<p>Now we’ve scaled our two spatial variables, the basic way to use them in a brms Gaussian process is including <code>gp(lat_adj, lon2_adj)</code> into the <code>formula</code> argument within the <code>brm()</code> function. Note however that one of the default <code>gp()</code> settings is <code>scale = TRUE</code>, which scales predictors so that the maximum distance between two points is 1. We don’t want this for our example, so we will set <code>scale = FALSE</code> instead. Here’s how to fit the model.</p>
<div class="sourceCode" id="cb1523"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1523-1"><a href="adventures-in-covariance.html#cb1523-1"></a>b13<span class="fl">.7</span> &lt;-</span>
<span id="cb1523-2"><a href="adventures-in-covariance.html#cb1523-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> d, </span>
<span id="cb1523-3"><a href="adventures-in-covariance.html#cb1523-3"></a>      <span class="dt">family =</span> poisson,</span>
<span id="cb1523-4"><a href="adventures-in-covariance.html#cb1523-4"></a>      <span class="co"># set scale = FALSE, (otherwise all scaled distance are between 0 and 1</span></span>
<span id="cb1523-5"><a href="adventures-in-covariance.html#cb1523-5"></a>      total_tools <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">gp</span>(lat_adj, lon2_adj, <span class="dt">scale =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span>logpop,</span>
<span id="cb1523-6"><a href="adventures-in-covariance.html#cb1523-6"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1523-7"><a href="adventures-in-covariance.html#cb1523-7"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> b, <span class="dt">coef =</span> logpop),</span>
<span id="cb1523-8"><a href="adventures-in-covariance.html#cb1523-8"></a>                <span class="kw">prior</span>(<span class="kw">inv_gamma</span>(<span class="fl">2.874624</span>, <span class="fl">2.941204</span>), <span class="dt">class =</span> lscale, <span class="dt">coef =</span> gplat_adjlon2_adj),</span>
<span id="cb1523-9"><a href="adventures-in-covariance.html#cb1523-9"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> sdgp)),</span>
<span id="cb1523-10"><a href="adventures-in-covariance.html#cb1523-10"></a>      <span class="dt">iter =</span> <span class="fl">1e4</span>, <span class="dt">warmup =</span> <span class="dv">2000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</span>
<span id="cb1523-11"><a href="adventures-in-covariance.html#cb1523-11"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1523-12"><a href="adventures-in-covariance.html#cb1523-12"></a>      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.999</span>),</span>
<span id="cb1523-13"><a href="adventures-in-covariance.html#cb1523-13"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.07&quot;</span>)</span></code></pre></div>
<p>Here’s the model summary.</p>
<div class="sourceCode" id="cb1524"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1524-1"><a href="adventures-in-covariance.html#cb1524-1"></a><span class="kw">posterior_samples</span>(b13<span class="fl">.7</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1524-2"><a href="adventures-in-covariance.html#cb1524-2"></a><span class="st">  </span><span class="kw">summarise_draws</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1524-3"><a href="adventures-in-covariance.html#cb1524-3"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1524-4"><a href="adventures-in-covariance.html#cb1524-4"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>median, <span class="op">-</span>mad)</span></code></pre></div>
<pre><code>## # A tibble: 15 x 8
##    variable                    mean    sd     q5    q95  rhat ess_bulk ess_tail
##    &lt;chr&gt;                      &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1 b_Intercept                 1.42  1.12  -0.34   3.28     1   13561.   15296.
##  2 b_logpop                    0.24  0.11   0.06   0.41     1   15631.   17886.
##  3 sdgp_gplat_adjlon2_adj      0.52  0.36   0.19   1.15     1    8414.   10717.
##  4 lscale_gplat_adjlon2_adj    1.72  0.97   0.61   3.57     1    8110.   12291.
##  5 zgp_gplat_adjlon2_adj[1]   -0.59  0.79  -1.92   0.69     1   15729.   20122.
##  6 zgp_gplat_adjlon2_adj[2]    0.45  0.85  -0.98   1.81     1   25654.   20820.
##  7 zgp_gplat_adjlon2_adj[3]   -0.62  0.71  -1.73   0.63     1   14828.   17615.
##  8 zgp_gplat_adjlon2_adj[4]    0.88  0.7   -0.24   2.05     1   17246.   20599.
##  9 zgp_gplat_adjlon2_adj[5]    0.25  0.76  -1      1.52     1   22376.   21794.
## 10 zgp_gplat_adjlon2_adj[6]   -1     0.79  -2.3    0.3      1   19318.   21631.
## 11 zgp_gplat_adjlon2_adj[7]    0.13  0.73  -1.12   1.28     1   23064.   18795.
## 12 zgp_gplat_adjlon2_adj[8]   -0.19  0.87  -1.62   1.25     1   30226.   21593.
## 13 zgp_gplat_adjlon2_adj[9]    0.41  0.91  -1.16   1.85     1   22904.   20236.
## 14 zgp_gplat_adjlon2_adj[10]  -0.32  0.83  -1.67   1.03     1   18852.   20289.
## 15 lp__                      -51.5   3.16 -57.3  -47.0      1    8548.   14145.</code></pre>
<p>Let’s start with the population parameters, first. Our intercept is just a touch high than McElreath’s <code>a</code> parameter (<span class="math inline">\(1.31, 89 \text{% HDI } [-0.57, 3.14]\)</span>). Happily, our <code>logpop</code> slope is almost dead on with McElreath’s <code>bp</code> parameter.</p>
<p>If you look at the parameter summary using <code>print()</code> or <code>summary()</code>, you’ll see those <code>sdgp_gplat_adjlon2_adj</code> and <code>lscale_gplat_adjlon2_adj</code> parameters are listed as ‘Gaussian Process Terms’. They are different in name and values from McElreath’s <code>etasq</code> and <code>rhosq</code> because brms uses a different parameterization. From the <code>gp</code> section of the <a href="https://cran.r-project.org/package=brms/brms.pdf">brms reference manual</a> <span class="citation">(Bürkner, <a href="#ref-brms2020RM" role="doc-biblioref">2020</a><a href="#ref-brms2020RM" role="doc-biblioref">b</a>)</span>, we learn the brms parameterization for the Gaussian process follows the form</p>
<p><span class="math display">\[k(x_{i},x_{j}) = sdgp^2 \exp \big (-||x_i - x_j||^2 / (2 lscale^2) \big ),\]</span></p>
<p>where <span class="math inline">\(k(x_{i},x_{j})\)</span> is the same as McElreath’s <span class="math inline">\(\mathbf K_{ij}\)</span> and <span class="math inline">\(||x_i - x_j||^2\)</span> is the Euclidean distance, the same as McElreath’s <span class="math inline">\(D_{ij}^2\)</span>. Thus we could also express the brms parameterization as</p>
<p><span class="math display">\[\mathbf K_{ij} = sdgp^2 \exp \big (-D_{ij}^2 / (2 lscale^2) \big ),\]</span></p>
<p>which is much closer to McElreath’s</p>
<p><span class="math display">\[\mathbf K_{ij} = \eta^2 \exp \big (-\rho^2 D_{ij}^2 \big ) + \delta_{ij} \sigma^2.\]</span></p>
<p>On page 412, McElreath explained that the final <span class="math inline">\(\delta_{ij} \sigma^2\)</span> term is mute with the Oceanic societies data. Thus we won’t consider it further. This reduces McElreath’s equation to</p>
<p><span class="math display">\[\mathbf K_{ij} = \eta^2 \exp \big (-\rho^2 D_{ij}^2 \big ).\]</span></p>
<p>Importantly, what McElreath called <span class="math inline">\(\eta\)</span>, Bürkner called <span class="math inline">\(sdgp\)</span>. While McElreath estimated <span class="math inline">\(\eta^2\)</span>, brms simply estimated <span class="math inline">\(sdgp\)</span>. So we’ll have to square our <code>sdgp_gplat_adjlon2_adj</code> before it’s on the same scale as <code>etasq</code> in the text. Here it is.</p>
<div class="sourceCode" id="cb1526"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1526-1"><a href="adventures-in-covariance.html#cb1526-1"></a>post &lt;-</span>
<span id="cb1526-2"><a href="adventures-in-covariance.html#cb1526-2"></a><span class="st">  </span><span class="kw">posterior_samples</span>(b13<span class="fl">.7</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1526-3"><a href="adventures-in-covariance.html#cb1526-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">etasq =</span> sdgp_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb1526-4"><a href="adventures-in-covariance.html#cb1526-4"></a></span>
<span id="cb1526-5"><a href="adventures-in-covariance.html#cb1526-5"></a>post <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1526-6"><a href="adventures-in-covariance.html#cb1526-6"></a><span class="st">  </span><span class="kw">mean_hdi</span>(etasq, <span class="dt">.width =</span> <span class="fl">.89</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1526-7"><a href="adventures-in-covariance.html#cb1526-7"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   etasq .lower .upper .width .point .interval
## 1 0.401      0  0.751   0.89   mean       hdi</code></pre>
<p>This is just a touch higher than the <code>etasq</code> summary McElreath reported in the text. In our model <code>brm()</code> code, above, we just went with the flow and kept the <code>cauchy(0, 1)</code> prior on <code>sdgp</code>. The brms default would have been <code>student_t(3, 0, 2.5)</code>.</p>
<p>Now look at the denominator of the inner part of Bürkner’s equation, <span class="math inline">\(2 lscale^2\)</span>. This appears to be the brms equivalent to McElreath’s <span class="math inline">\(\rho^2\)</span>. Or at least it’s what we’ve got. Also note that McElreath estimated <span class="math inline">\(\rho^2\)</span> directly as <code>rhosq</code>. If I’m doing the algebra correctly, we might expect</p>
<p><span class="math display">\[\begin{align*}
\rho^2 &amp; = 1/(2 \cdot lscale^2) &amp; \text{and thus} \\
lscale &amp; = \sqrt{1 / (2 \cdot \rho^2)}.
\end{align*}\]</span></p>
<p>To get a sense of this relationship, it might be helpful to plot.</p>
<div class="sourceCode" id="cb1528"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1528-1"><a href="adventures-in-covariance.html#cb1528-1"></a>p1 &lt;-</span>
<span id="cb1528-2"><a href="adventures-in-covariance.html#cb1528-2"></a><span class="st">  </span><span class="kw">tibble</span>(<span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span> =<span class="st"> </span><span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">11</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1528-3"><a href="adventures-in-covariance.html#cb1528-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lscale =</span> <span class="kw">sqrt</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> `</span><span class="dt">rho^2</span><span class="st">`</span>))) <span class="op">%&gt;%</span></span>
<span id="cb1528-4"><a href="adventures-in-covariance.html#cb1528-4"></a><span class="st">  </span></span>
<span id="cb1528-5"><a href="adventures-in-covariance.html#cb1528-5"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span>, <span class="dt">y =</span> lscale)) <span class="op">+</span></span>
<span id="cb1528-6"><a href="adventures-in-covariance.html#cb1528-6"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1528-7"><a href="adventures-in-covariance.html#cb1528-7"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1528-8"><a href="adventures-in-covariance.html#cb1528-8"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;#A65141&quot;</span>) <span class="op">+</span></span>
<span id="cb1528-9"><a href="adventures-in-covariance.html#cb1528-9"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="kw">expression</span>(rho<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span></span>
<span id="cb1528-10"><a href="adventures-in-covariance.html#cb1528-10"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb1528-11"><a href="adventures-in-covariance.html#cb1528-11"></a>                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>)) <span class="op">+</span></span>
<span id="cb1528-12"><a href="adventures-in-covariance.html#cb1528-12"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span>
<span id="cb1528-13"><a href="adventures-in-covariance.html#cb1528-13"></a></span>
<span id="cb1528-14"><a href="adventures-in-covariance.html#cb1528-14"></a>p2 &lt;-</span>
<span id="cb1528-15"><a href="adventures-in-covariance.html#cb1528-15"></a><span class="st">  </span><span class="kw">tibble</span>(<span class="dt">lscale =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">11</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1528-16"><a href="adventures-in-covariance.html#cb1528-16"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span> =<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>lscale<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1528-17"><a href="adventures-in-covariance.html#cb1528-17"></a><span class="st">  </span></span>
<span id="cb1528-18"><a href="adventures-in-covariance.html#cb1528-18"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lscale, <span class="dt">y =</span> <span class="st">`</span><span class="dt">rho^2</span><span class="st">`</span>)) <span class="op">+</span></span>
<span id="cb1528-19"><a href="adventures-in-covariance.html#cb1528-19"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1528-20"><a href="adventures-in-covariance.html#cb1528-20"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">linetype =</span> <span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1528-21"><a href="adventures-in-covariance.html#cb1528-21"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></span>
<span id="cb1528-22"><a href="adventures-in-covariance.html#cb1528-22"></a><span class="st">  </span><span class="kw">ylab</span>(<span class="kw">expression</span>(rho<span class="op">^</span><span class="dv">2</span>)) <span class="op">+</span></span>
<span id="cb1528-23"><a href="adventures-in-covariance.html#cb1528-23"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb1528-24"><a href="adventures-in-covariance.html#cb1528-24"></a>                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>)) <span class="op">+</span></span>
<span id="cb1528-25"><a href="adventures-in-covariance.html#cb1528-25"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span>
<span id="cb1528-26"><a href="adventures-in-covariance.html#cb1528-26"></a></span>
<span id="cb1528-27"><a href="adventures-in-covariance.html#cb1528-27"></a>p1 <span class="op">+</span><span class="st"> </span>p2</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-61-1.png" width="624" /></p>
<p>The two aren’t quite inverses of one another, but the overall pattern is when one is large, the other is small. Now we have a sense of how they compare and how to covert one to the other, let’s see how our posterior for <span class="math inline">\(lscale\)</span> looks when we convert it to the scale of McElreath’s <span class="math inline">\(\rho^2\)</span>.</p>
<div class="sourceCode" id="cb1529"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1529-1"><a href="adventures-in-covariance.html#cb1529-1"></a>post &lt;-</span>
<span id="cb1529-2"><a href="adventures-in-covariance.html#cb1529-2"></a><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1529-3"><a href="adventures-in-covariance.html#cb1529-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">rhosq =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>lscale_gplat_adjlon2_adj<span class="op">^</span><span class="dv">2</span>))</span>
<span id="cb1529-4"><a href="adventures-in-covariance.html#cb1529-4"></a></span>
<span id="cb1529-5"><a href="adventures-in-covariance.html#cb1529-5"></a>post <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1529-6"><a href="adventures-in-covariance.html#cb1529-6"></a><span class="st">  </span><span class="kw">mean_hdi</span>(rhosq, <span class="dt">.width =</span> <span class="fl">.89</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1529-7"><a href="adventures-in-covariance.html#cb1529-7"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.double, round, <span class="dt">digits =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   rhosq .lower .upper .width .point .interval
## 1 0.398  0.006  0.855   0.89   mean       hdi</code></pre>
<p>This is substantially smaller than the <code>rhosq</code> summary McElreath reported in the text. The plot deepens. If you look back, you’ll see we used a very different prior for <code>lscale</code>. Here it is: <code>inv_gamma(2.874624, 2.941204)</code>. Use <code>get_prior()</code> to discover where that came from.</p>
<div class="sourceCode" id="cb1531"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1531-1"><a href="adventures-in-covariance.html#cb1531-1"></a><span class="kw">get_prior</span>(<span class="dt">data =</span> d, </span>
<span id="cb1531-2"><a href="adventures-in-covariance.html#cb1531-2"></a>          <span class="dt">family =</span> poisson,</span>
<span id="cb1531-3"><a href="adventures-in-covariance.html#cb1531-3"></a>          total_tools <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">gp</span>(lat_adj, lon2_adj, <span class="dt">scale =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span>logpop)</span></code></pre></div>
<pre><code>##                           prior     class              coef group resp dpar nlpar bound
## 1                                       b                                              
## 2                                       b            logpop                            
## 3        student_t(3, 3.4, 2.5) Intercept                                              
## 4                                  lscale                                              
## 5 inv_gamma(2.874624, 2.941204)    lscale gplat_adjlon2_adj                            
## 6          student_t(3, 0, 2.5)      sdgp                                              
## 7                                    sdgp gplat_adjlon2_adj</code></pre>
<p>That is, we used the brms default prior for <span class="math inline">\(lscale\)</span>. In a <a href="https://github.com/ASKurz/Statistical_Rethinking_with_brms_ggplot2_and_the_tidyverse/issues/8">GitHub exchange</a>, Bürkner pointed out that brms uses special priors for <span class="math inline">\(lscale\)</span> parameters based on Michael Betancourt’s vignette, <a href="https://betanalpha.github.io/assets/case_studies/gp_part3/part3.html"><em>Robust Gaussian processes in Stan</em></a>. We can use the <code>dinvgamma()</code> function from the well-named <a href="https://CRAN.R-project.org/package=invgamma">invgamma package</a> <span class="citation">(Kahle &amp; Stamey, <a href="#ref-R-invgamma" role="doc-biblioref">2017</a>)</span> to get a sense of what that prior looks like.</p>
<div class="sourceCode" id="cb1533"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1533-1"><a href="adventures-in-covariance.html#cb1533-1"></a><span class="kw">tibble</span>(<span class="dt">lscale =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">9</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1533-2"><a href="adventures-in-covariance.html#cb1533-2"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">density =</span> invgamma<span class="op">::</span><span class="kw">dinvgamma</span>(lscale, <span class="fl">2.874624</span>, <span class="fl">2.941204</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1533-3"><a href="adventures-in-covariance.html#cb1533-3"></a><span class="st">  </span></span>
<span id="cb1533-4"><a href="adventures-in-covariance.html#cb1533-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lscale, <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> density)) <span class="op">+</span></span>
<span id="cb1533-5"><a href="adventures-in-covariance.html#cb1533-5"></a><span class="st">  </span><span class="kw">geom_ribbon</span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">fill =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></span>
<span id="cb1533-6"><a href="adventures-in-covariance.html#cb1533-6"></a><span class="st">  </span><span class="kw">annotate</span>(<span class="dt">geom =</span> <span class="st">&quot;text&quot;</span>, <span class="dt">x =</span> <span class="fl">4.75</span>, <span class="dt">y =</span> <span class="fl">0.75</span>,</span>
<span id="cb1533-7"><a href="adventures-in-covariance.html#cb1533-7"></a>           <span class="dt">label =</span> <span class="st">&quot;inverse gamma(2.874624, 0.393695)&quot;</span>,</span>
<span id="cb1533-8"><a href="adventures-in-covariance.html#cb1533-8"></a>           <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></span>
<span id="cb1533-9"><a href="adventures-in-covariance.html#cb1533-9"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1533-10"><a href="adventures-in-covariance.html#cb1533-10"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">8</span>)) <span class="op">+</span></span>
<span id="cb1533-11"><a href="adventures-in-covariance.html#cb1533-11"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-64-1.png" width="384" /></p>
<p>We might make our version of Figure 13.9 to get a sense of how these parameterization and summary differences might influence our results.</p>
<div class="sourceCode" id="cb1534"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1534-1"><a href="adventures-in-covariance.html#cb1534-1"></a><span class="co"># for `sample_n()`</span></span>
<span id="cb1534-2"><a href="adventures-in-covariance.html#cb1534-2"></a><span class="kw">set.seed</span>(<span class="dv">13</span>)</span>
<span id="cb1534-3"><a href="adventures-in-covariance.html#cb1534-3"></a></span>
<span id="cb1534-4"><a href="adventures-in-covariance.html#cb1534-4"></a><span class="co"># wrangle</span></span>
<span id="cb1534-5"><a href="adventures-in-covariance.html#cb1534-5"></a>post <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1534-6"><a href="adventures-in-covariance.html#cb1534-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">iter  =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1534-7"><a href="adventures-in-covariance.html#cb1534-7"></a><span class="st">  </span><span class="kw">sample_n</span>(<span class="dv">100</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1534-8"><a href="adventures-in-covariance.html#cb1534-8"></a><span class="st">  </span><span class="kw">expand</span>(<span class="kw">nesting</span>(iter, etasq, rhosq),</span>
<span id="cb1534-9"><a href="adventures-in-covariance.html#cb1534-9"></a>         <span class="dt">x =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">10</span>, <span class="dt">by =</span> <span class="fl">.05</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1534-10"><a href="adventures-in-covariance.html#cb1534-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">covariance =</span> etasq <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span>rhosq <span class="op">*</span><span class="st"> </span>x<span class="op">^</span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1534-11"><a href="adventures-in-covariance.html#cb1534-11"></a><span class="st">  </span></span>
<span id="cb1534-12"><a href="adventures-in-covariance.html#cb1534-12"></a><span class="st">  </span><span class="co"># plot</span></span>
<span id="cb1534-13"><a href="adventures-in-covariance.html#cb1534-13"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> covariance)) <span class="op">+</span></span>
<span id="cb1534-14"><a href="adventures-in-covariance.html#cb1534-14"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> iter),</span>
<span id="cb1534-15"><a href="adventures-in-covariance.html#cb1534-15"></a>            <span class="dt">size =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">4</span>, <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>) <span class="op">+</span></span>
<span id="cb1534-16"><a href="adventures-in-covariance.html#cb1534-16"></a><span class="st">  </span><span class="kw">stat_function</span>(<span class="dt">fun =</span> <span class="cf">function</span>(x) <span class="kw">median</span>(post<span class="op">$</span>etasq) <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span><span class="kw">median</span>(post<span class="op">$</span>rhosq)<span class="op">*</span>x<span class="op">^</span><span class="dv">2</span>),</span>
<span id="cb1534-17"><a href="adventures-in-covariance.html#cb1534-17"></a>                <span class="dt">color =</span> <span class="st">&quot;#EEDA9D&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb1534-18"><a href="adventures-in-covariance.html#cb1534-18"></a><span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="st">&quot;distance (thousand km)&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb1534-19"><a href="adventures-in-covariance.html#cb1534-19"></a>                     <span class="dt">breaks =</span> <span class="dv">0</span><span class="op">:</span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1534-20"><a href="adventures-in-covariance.html#cb1534-20"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb1534-21"><a href="adventures-in-covariance.html#cb1534-21"></a>                  <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb1534-22"><a href="adventures-in-covariance.html#cb1534-22"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-65-1.png" width="407.04" /></p>
<p>When you look at the posterior distribution for the spatial covariance between pairs of our ten island societies, our brms results look very similar to those McElreath reported in the text. Let’s finish this up and “push the parameters back through the function for <span class="math inline">\(\mathbf{K}\)</span>, the covariance matrix” (p. 415).</p>
<div class="sourceCode" id="cb1535"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1535-1"><a href="adventures-in-covariance.html#cb1535-1"></a><span class="co"># compute posterior median covariance among societies</span></span>
<span id="cb1535-2"><a href="adventures-in-covariance.html#cb1535-2"></a>k &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">10</span>, <span class="dt">ncol =</span> <span class="dv">10</span>)</span>
<span id="cb1535-3"><a href="adventures-in-covariance.html#cb1535-3"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span>
<span id="cb1535-4"><a href="adventures-in-covariance.html#cb1535-4"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</span>
<span id="cb1535-5"><a href="adventures-in-covariance.html#cb1535-5"></a>        k[i, j] &lt;-<span class="st"> </span><span class="kw">median</span>(post<span class="op">$</span>etasq) <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="op">-</span><span class="kw">median</span>(post<span class="op">$</span>rhosq) <span class="op">*</span><span class="st"> </span>islandsDistMatrix[i, j]<span class="op">^</span><span class="dv">2</span>)</span>
<span id="cb1535-6"><a href="adventures-in-covariance.html#cb1535-6"></a></span>
<span id="cb1535-7"><a href="adventures-in-covariance.html#cb1535-7"></a><span class="kw">diag</span>(k) &lt;-<span class="st"> </span><span class="kw">median</span>(post<span class="op">$</span>etasq) <span class="op">+</span><span class="st"> </span><span class="fl">0.01</span></span>
<span id="cb1535-8"><a href="adventures-in-covariance.html#cb1535-8"></a></span>
<span id="cb1535-9"><a href="adventures-in-covariance.html#cb1535-9"></a>k <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</span></code></pre></div>
<pre><code>##       [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
##  [1,] 0.19 0.18 0.17 0.00 0.13 0.07 0.02 0.03 0.09  0.00
##  [2,] 0.18 0.19 0.18 0.00 0.13 0.08 0.03 0.04 0.08  0.00
##  [3,] 0.17 0.18 0.19 0.01 0.11 0.10 0.04 0.05 0.06  0.00
##  [4,] 0.00 0.00 0.01 0.19 0.00 0.05 0.11 0.10 0.00  0.00
##  [5,] 0.13 0.13 0.11 0.00 0.19 0.02 0.00 0.01 0.16  0.00
##  [6,] 0.07 0.08 0.10 0.05 0.02 0.19 0.09 0.16 0.01  0.00
##  [7,] 0.02 0.03 0.04 0.11 0.00 0.09 0.19 0.13 0.00  0.00
##  [8,] 0.03 0.04 0.05 0.10 0.01 0.16 0.13 0.19 0.00  0.00
##  [9,] 0.09 0.08 0.06 0.00 0.16 0.01 0.00 0.00 0.19  0.00
## [10,] 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00  0.19</code></pre>
<p>We’ll continue to follow suit and change these to a correlation matrix.</p>
<div class="sourceCode" id="cb1537"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1537-1"><a href="adventures-in-covariance.html#cb1537-1"></a><span class="co"># convert to correlation matrix</span></span>
<span id="cb1537-2"><a href="adventures-in-covariance.html#cb1537-2"></a>rho &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">cov2cor</span>(k), <span class="dv">2</span>)</span>
<span id="cb1537-3"><a href="adventures-in-covariance.html#cb1537-3"></a></span>
<span id="cb1537-4"><a href="adventures-in-covariance.html#cb1537-4"></a><span class="co"># add row/col names for convenience</span></span>
<span id="cb1537-5"><a href="adventures-in-covariance.html#cb1537-5"></a><span class="kw">colnames</span>(rho) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ml&quot;</span>, <span class="st">&quot;Ti&quot;</span>, <span class="st">&quot;SC&quot;</span>, <span class="st">&quot;Ya&quot;</span>, <span class="st">&quot;Fi&quot;</span>, <span class="st">&quot;Tr&quot;</span>, <span class="st">&quot;Ch&quot;</span>, <span class="st">&quot;Mn&quot;</span>, <span class="st">&quot;To&quot;</span>, <span class="st">&quot;Ha&quot;</span>)</span>
<span id="cb1537-6"><a href="adventures-in-covariance.html#cb1537-6"></a><span class="kw">rownames</span>(rho) &lt;-<span class="st"> </span><span class="kw">colnames</span>(rho)</span>
<span id="cb1537-7"><a href="adventures-in-covariance.html#cb1537-7"></a></span>
<span id="cb1537-8"><a href="adventures-in-covariance.html#cb1537-8"></a>rho <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span>)</span></code></pre></div>
<pre><code>##      Ml   Ti   SC   Ya   Fi   Tr   Ch   Mn   To Ha
## Ml 1.00 0.90 0.87 0.01 0.68 0.38 0.10 0.17 0.44  0
## Ti 0.90 1.00 0.93 0.02 0.67 0.39 0.15 0.19 0.40  0
## SC 0.87 0.93 1.00 0.03 0.55 0.49 0.21 0.27 0.30  0
## Ya 0.01 0.02 0.03 1.00 0.00 0.24 0.55 0.53 0.00  0
## Fi 0.68 0.67 0.55 0.00 1.00 0.09 0.03 0.03 0.83  0
## Tr 0.38 0.39 0.49 0.24 0.09 1.00 0.46 0.81 0.03  0
## Ch 0.10 0.15 0.21 0.55 0.03 0.46 1.00 0.68 0.01  0
## Mn 0.17 0.19 0.27 0.53 0.03 0.81 0.68 1.00 0.01  0
## To 0.44 0.40 0.30 0.00 0.83 0.03 0.01 0.01 1.00  0
## Ha 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00  1</code></pre>
<p>Here are those correlations in a plot.</p>
<div class="sourceCode" id="cb1539"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1539-1"><a href="adventures-in-covariance.html#cb1539-1"></a>rho <span class="op">%&gt;%</span></span>
<span id="cb1539-2"><a href="adventures-in-covariance.html#cb1539-2"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1539-3"><a href="adventures-in-covariance.html#cb1539-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">row =</span> d<span class="op">$</span>culture) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1539-4"><a href="adventures-in-covariance.html#cb1539-4"></a><span class="st">  </span><span class="kw">gather</span>(column, distance, <span class="op">-</span>row) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1539-5"><a href="adventures-in-covariance.html#cb1539-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">column =</span> <span class="kw">factor</span>(column, <span class="dt">levels =</span> <span class="kw">colnames</span>(d_mat)),</span>
<span id="cb1539-6"><a href="adventures-in-covariance.html#cb1539-6"></a>         <span class="dt">row    =</span> <span class="kw">factor</span>(row,    <span class="dt">levels =</span> <span class="kw">rownames</span>(d_mat)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">fct_rev</span>(),</span>
<span id="cb1539-7"><a href="adventures-in-covariance.html#cb1539-7"></a>         <span class="dt">label  =</span> <span class="kw">formatC</span>(distance, <span class="dt">format =</span> <span class="st">&#39;f&#39;</span>, <span class="dt">digits =</span> <span class="dv">2</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_replace</span>(., <span class="st">&quot;0.&quot;</span>, <span class="st">&quot;.&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1539-8"><a href="adventures-in-covariance.html#cb1539-8"></a><span class="st">  </span><span class="co"># omit this line to keep the diagonal of 1&#39;s</span></span>
<span id="cb1539-9"><a href="adventures-in-covariance.html#cb1539-9"></a><span class="st">  </span><span class="kw">filter</span>(distance <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1539-10"><a href="adventures-in-covariance.html#cb1539-10"></a><span class="st">  </span></span>
<span id="cb1539-11"><a href="adventures-in-covariance.html#cb1539-11"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> column, <span class="dt">y =</span> row)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb1539-12"><a href="adventures-in-covariance.html#cb1539-12"></a><span class="st">  </span><span class="kw">geom_raster</span>(<span class="kw">aes</span>(<span class="dt">fill =</span> distance)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb1539-13"><a href="adventures-in-covariance.html#cb1539-13"></a><span class="st">  </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">label =</span> label),</span>
<span id="cb1539-14"><a href="adventures-in-covariance.html#cb1539-14"></a>            <span class="dt">size =</span> <span class="fl">2.75</span>, <span class="dt">family =</span> <span class="st">&quot;Courier&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>) <span class="op">+</span></span>
<span id="cb1539-15"><a href="adventures-in-covariance.html#cb1539-15"></a><span class="st">  </span><span class="kw">scale_fill_gradient</span>(<span class="kw">expression</span>(rho), <span class="dt">low =</span> <span class="st">&quot;#FCF9F0&quot;</span>, <span class="dt">high =</span> <span class="st">&quot;#A65141&quot;</span>, <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb1539-16"><a href="adventures-in-covariance.html#cb1539-16"></a><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="ot">NULL</span>, <span class="dt">position =</span> <span class="st">&quot;top&quot;</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1539-17"><a href="adventures-in-covariance.html#cb1539-17"></a><span class="st">  </span><span class="kw">scale_y_discrete</span>(<span class="ot">NULL</span>, <span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1539-18"><a href="adventures-in-covariance.html#cb1539-18"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1539-19"><a href="adventures-in-covariance.html#cb1539-19"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.ticks =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-68-1.png" width="456" /></p>
<p>The correlations in our <code>rho</code> matrix look a little higher than those in the text (p. 416). Before we move on to the next plot, let’s consider <code>psize</code>. If you really want to scale the points in Figure 13.10.a like McElreath did, you can make the <code>psize</code> variable in a tidyverse sort of way as follows. However, if you compare the <code>psize</code> method and the default ggplot2 method using just <code>logpop</code>, you’ll see the difference is negligible. In that light, I’m going to be lazy and just use <code>logpop</code> in my plots.</p>
<div class="sourceCode" id="cb1540"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1540-1"><a href="adventures-in-covariance.html#cb1540-1"></a>d <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1540-2"><a href="adventures-in-covariance.html#cb1540-2"></a><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">psize =</span> logpop <span class="op">/</span><span class="st"> </span><span class="kw">max</span>(logpop)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1540-3"><a href="adventures-in-covariance.html#cb1540-3"></a><span class="st">  </span><span class="kw">transmute</span>(<span class="dt">psize =</span> <span class="kw">exp</span>(psize <span class="op">*</span><span class="st"> </span><span class="fl">1.5</span>) <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)</span></code></pre></div>
<pre><code>##        psize
## 1  0.3134090
## 2  0.4009582
## 3  0.6663711
## 4  0.7592196
## 5  0.9066890
## 6  0.9339560
## 7  0.9834797
## 8  1.1096138
## 9  1.2223112
## 10 2.4816891</code></pre>
<p>As far as I can figure, you still have to get <code>rho</code> into a tidy data frame before feeding it into ggplot2. Here’s my attempt at doing so.</p>
<div class="sourceCode" id="cb1542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1542-1"><a href="adventures-in-covariance.html#cb1542-1"></a>tidy_rho &lt;-</span>
<span id="cb1542-2"><a href="adventures-in-covariance.html#cb1542-2"></a><span class="st">  </span>rho <span class="op">%&gt;%</span></span>
<span id="cb1542-3"><a href="adventures-in-covariance.html#cb1542-3"></a><span class="st">  </span><span class="kw">data.frame</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1542-4"><a href="adventures-in-covariance.html#cb1542-4"></a><span class="st">  </span><span class="kw">rownames_to_column</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1542-5"><a href="adventures-in-covariance.html#cb1542-5"></a><span class="st">  </span><span class="kw">bind_cols</span>(d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(culture, logpop, total_tools, lon2, lat)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1542-6"><a href="adventures-in-covariance.html#cb1542-6"></a><span class="st">  </span><span class="kw">gather</span>(colname, correlation, <span class="op">-</span>rowname, <span class="op">-</span>culture, <span class="op">-</span>logpop, <span class="op">-</span>total_tools, <span class="op">-</span>lon2, <span class="op">-</span>lat) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1542-7"><a href="adventures-in-covariance.html#cb1542-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> <span class="kw">str_c</span>(<span class="kw">pmin</span>(rowname, colname), <span class="kw">pmax</span>(rowname, colname))) <span class="op">%&gt;%</span></span>
<span id="cb1542-8"><a href="adventures-in-covariance.html#cb1542-8"></a><span class="st">  </span><span class="kw">select</span>(rowname, colname, group, culture, <span class="kw">everything</span>())</span>
<span id="cb1542-9"><a href="adventures-in-covariance.html#cb1542-9"></a></span>
<span id="cb1542-10"><a href="adventures-in-covariance.html#cb1542-10"></a><span class="kw">head</span>(tidy_rho)</span></code></pre></div>
<pre><code>##   rowname colname group    culture   logpop total_tools  lon2   lat correlation
## 1      Ml      Ml  MlMl   Malekula 7.003065          13 -12.5 -16.3        1.00
## 2      Ti      Ml  MlTi    Tikopia 7.313220          22 -11.2 -12.3        0.90
## 3      SC      Ml  MlSC Santa Cruz 8.188689          24 -14.0 -10.7        0.87
## 4      Ya      Ml  MlYa        Yap 8.474494          43 -41.9   9.5        0.01
## 5      Fi      Ml  FiMl   Lau Fiji 8.909235          33  -1.9 -17.7        0.68
## 6      Tr      Ml  MlTr  Trobriand 8.987197          19 -29.1  -8.7        0.38</code></pre>
<p>Okay, here’s the code for our version of Figure 13.10.a.</p>
<div class="sourceCode" id="cb1544"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1544-1"><a href="adventures-in-covariance.html#cb1544-1"></a>p1 &lt;-</span>
<span id="cb1544-2"><a href="adventures-in-covariance.html#cb1544-2"></a><span class="st">  </span>tidy_rho <span class="op">%&gt;%</span><span class="st">       </span></span>
<span id="cb1544-3"><a href="adventures-in-covariance.html#cb1544-3"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> lon2, <span class="dt">y =</span> lat)) <span class="op">+</span></span>
<span id="cb1544-4"><a href="adventures-in-covariance.html#cb1544-4"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> group, <span class="dt">alpha =</span> correlation<span class="op">^</span><span class="dv">2</span>),</span>
<span id="cb1544-5"><a href="adventures-in-covariance.html#cb1544-5"></a>            <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></span>
<span id="cb1544-6"><a href="adventures-in-covariance.html#cb1544-6"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d, </span>
<span id="cb1544-7"><a href="adventures-in-covariance.html#cb1544-7"></a>             <span class="kw">aes</span>(<span class="dt">size =</span> logpop), <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></span>
<span id="cb1544-8"><a href="adventures-in-covariance.html#cb1544-8"></a><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> d, <span class="kw">aes</span>(<span class="dt">label =</span> culture), </span>
<span id="cb1544-9"><a href="adventures-in-covariance.html#cb1544-9"></a>                  <span class="dt">seed =</span> <span class="dv">0</span>, <span class="dt">point.padding =</span> <span class="fl">.25</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span></span>
<span id="cb1544-10"><a href="adventures-in-covariance.html#cb1544-10"></a><span class="st">  </span><span class="kw">scale_alpha_continuous</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb1544-11"><a href="adventures-in-covariance.html#cb1544-11"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Among societies in geographic space</span><span class="ch">\n</span><span class="st">&quot;</span>,</span>
<span id="cb1544-12"><a href="adventures-in-covariance.html#cb1544-12"></a>       <span class="dt">x =</span> <span class="st">&quot;longitude&quot;</span>,</span>
<span id="cb1544-13"><a href="adventures-in-covariance.html#cb1544-13"></a>       <span class="dt">y =</span> <span class="st">&quot;latitude&quot;</span>) <span class="op">+</span></span>
<span id="cb1544-14"><a href="adventures-in-covariance.html#cb1544-14"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>lon2),</span>
<span id="cb1544-15"><a href="adventures-in-covariance.html#cb1544-15"></a>                  <span class="dt">ylim =</span> <span class="kw">range</span>(d<span class="op">$</span>lat)) <span class="op">+</span></span>
<span id="cb1544-16"><a href="adventures-in-covariance.html#cb1544-16"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p>Here’s our the code for our version of Figure 13.10.b.</p>
<div class="sourceCode" id="cb1545"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1545-1"><a href="adventures-in-covariance.html#cb1545-1"></a><span class="co"># compute the average posterior predictive relationship between </span></span>
<span id="cb1545-2"><a href="adventures-in-covariance.html#cb1545-2"></a><span class="co"># log population and total tools, summarized by the median and 80% interval</span></span>
<span id="cb1545-3"><a href="adventures-in-covariance.html#cb1545-3"></a>f &lt;-</span>
<span id="cb1545-4"><a href="adventures-in-covariance.html#cb1545-4"></a><span class="st">  </span>post <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1545-5"><a href="adventures-in-covariance.html#cb1545-5"></a><span class="st">  </span><span class="kw">expand</span>(<span class="dt">logpop =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="dv">6</span>, <span class="dt">to =</span> <span class="dv">14</span>, <span class="dt">length.out =</span> <span class="dv">30</span>),</span>
<span id="cb1545-6"><a href="adventures-in-covariance.html#cb1545-6"></a>         <span class="kw">nesting</span>(b_Intercept, b_logpop)) <span class="op">%&gt;%</span></span>
<span id="cb1545-7"><a href="adventures-in-covariance.html#cb1545-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">lambda =</span> <span class="kw">exp</span>(b_Intercept <span class="op">+</span><span class="st"> </span>b_logpop <span class="op">*</span><span class="st"> </span>logpop)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1545-8"><a href="adventures-in-covariance.html#cb1545-8"></a><span class="st">  </span><span class="kw">group_by</span>(logpop) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1545-9"><a href="adventures-in-covariance.html#cb1545-9"></a><span class="st">  </span><span class="kw">median_qi</span>(lambda, <span class="dt">.width =</span> <span class="fl">.8</span>)</span>
<span id="cb1545-10"><a href="adventures-in-covariance.html#cb1545-10"></a>  </span>
<span id="cb1545-11"><a href="adventures-in-covariance.html#cb1545-11"></a><span class="co"># plot</span></span>
<span id="cb1545-12"><a href="adventures-in-covariance.html#cb1545-12"></a>p2 &lt;-</span>
<span id="cb1545-13"><a href="adventures-in-covariance.html#cb1545-13"></a><span class="st">  </span>tidy_rho <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1545-14"><a href="adventures-in-covariance.html#cb1545-14"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> logpop)) <span class="op">+</span></span>
<span id="cb1545-15"><a href="adventures-in-covariance.html#cb1545-15"></a><span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">data =</span> f,</span>
<span id="cb1545-16"><a href="adventures-in-covariance.html#cb1545-16"></a>              <span class="kw">aes</span>(<span class="dt">y =</span> lambda, <span class="dt">ymin =</span> .lower, <span class="dt">ymax =</span> .upper),</span>
<span id="cb1545-17"><a href="adventures-in-covariance.html#cb1545-17"></a>              <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>,</span>
<span id="cb1545-18"><a href="adventures-in-covariance.html#cb1545-18"></a>              <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;#100F14&quot;</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>, <span class="dt">size =</span> <span class="fl">1.1</span>) <span class="op">+</span></span>
<span id="cb1545-19"><a href="adventures-in-covariance.html#cb1545-19"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">group =</span> group, <span class="dt">alpha =</span> correlation<span class="op">^</span><span class="dv">2</span>),</span>
<span id="cb1545-20"><a href="adventures-in-covariance.html#cb1545-20"></a>            <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>) <span class="op">+</span></span>
<span id="cb1545-21"><a href="adventures-in-covariance.html#cb1545-21"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> d, </span>
<span id="cb1545-22"><a href="adventures-in-covariance.html#cb1545-22"></a>             <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">size =</span> logpop), </span>
<span id="cb1545-23"><a href="adventures-in-covariance.html#cb1545-23"></a>             <span class="dt">color =</span> <span class="st">&quot;#DCA258&quot;</span>) <span class="op">+</span></span>
<span id="cb1545-24"><a href="adventures-in-covariance.html#cb1545-24"></a><span class="st">  </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> d, </span>
<span id="cb1545-25"><a href="adventures-in-covariance.html#cb1545-25"></a>                  <span class="kw">aes</span>(<span class="dt">y =</span> total_tools, <span class="dt">label =</span> culture), </span>
<span id="cb1545-26"><a href="adventures-in-covariance.html#cb1545-26"></a>                  <span class="dt">seed =</span> <span class="dv">0</span>, <span class="dt">point.padding =</span> <span class="fl">.3</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">color =</span> <span class="st">&quot;#FCF9F0&quot;</span>) <span class="op">+</span></span>
<span id="cb1545-27"><a href="adventures-in-covariance.html#cb1545-27"></a><span class="st">  </span><span class="kw">scale_alpha_continuous</span>(<span class="dt">range =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb1545-28"><a href="adventures-in-covariance.html#cb1545-28"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="st">&quot;Shown against the relation between</span><span class="ch">\n</span><span class="st">total tools and log pop&quot;</span>,</span>
<span id="cb1545-29"><a href="adventures-in-covariance.html#cb1545-29"></a>       <span class="dt">x =</span> <span class="st">&quot;log population&quot;</span>,</span>
<span id="cb1545-30"><a href="adventures-in-covariance.html#cb1545-30"></a>       <span class="dt">y =</span> <span class="st">&quot;total tools&quot;</span>) <span class="op">+</span></span>
<span id="cb1545-31"><a href="adventures-in-covariance.html#cb1545-31"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">range</span>(d<span class="op">$</span>logpop),</span>
<span id="cb1545-32"><a href="adventures-in-covariance.html#cb1545-32"></a>                  <span class="dt">ylim =</span> <span class="kw">range</span>(d<span class="op">$</span>total_tools)) <span class="op">+</span></span>
<span id="cb1545-33"><a href="adventures-in-covariance.html#cb1545-33"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">legend.position =</span> <span class="st">&quot;none&quot;</span>)</span></code></pre></div>
<p>Now we combine them to make the full version of Figure 13.10.</p>
<div class="sourceCode" id="cb1546"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1546-1"><a href="adventures-in-covariance.html#cb1546-1"></a>p1 <span class="op">+</span><span class="st"> </span>p2 <span class="op">+</span><span class="st"> </span></span>
<span id="cb1546-2"><a href="adventures-in-covariance.html#cb1546-2"></a><span class="st">  </span><span class="kw">plot_annotation</span>(<span class="dt">title =</span> <span class="st">&quot;Posterior median correlations&quot;</span>,</span>
<span id="cb1546-3"><a href="adventures-in-covariance.html#cb1546-3"></a>                  <span class="dt">theme =</span> <span class="kw">theme_pearl_earring</span>())</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-73-1.png" width="768" /></p>
<blockquote>
<p>Of course the correlations that this model describes by geographic distance may be the result of other, unmeasured commonalities between geographically close societies. For example, Manus and the Trobriands are geologically and ecologically quite different from Fiji and Tonga. So it could be availability of, for example, tool stone that explains some of the correlations. The Gaussian process regression is a grand and powerful descriptive model. As a result, its output is always compatible with many different causal explanations. (p. 418)</p>
</blockquote>
</div>
<div id="other-kinds-of-distance." class="section level3">
<h3><span class="header-section-number">13.4.2</span> Other kinds of “distance”.</h3>
<p>McElreath briefly mentioned how Gaussian processes can be used to handle covariation resulting form phylogenetic distances. We won’t cover it here, but brms is capable of fitting a variety of phylogenetic models. To learn more, check out Bürkner’s <span class="citation">(<a href="#ref-Bürkner2020Phylogenetic" role="doc-biblioref">2020</a><a href="#ref-Bürkner2020Phylogenetic" role="doc-biblioref">i</a>)</span> vignette, <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_phylogenetics.html"><em>Estimating phylogenetic multilevel models with brms</em></a>.</p>
</div>
</div>
<div id="summary-bonus-another-berkley-admissions-data-like-example." class="section level2">
<h2><span class="header-section-number">13.5</span> <del>Summary</del> Bonus: Another Berkley-admissions-data-like example.</h2>
<p><a href="https://www.youtube.com/channel/UCNJK6_DZvcMqNSzQdEkzvzA/playlists">McElreath uploaded recordings</a> of himself teaching out of his text for a graduate course during the 2017/2018 fall semester. In the beginning of <a href="https://www.youtube.com/watch?v=rSQ1XMwO_9A&amp;t">lecture 13 from week 7</a>, he discussed a <span class="citation">(<a href="#ref-vanderleeGender2015" role="doc-biblioref">2015</a>)</span> paper from van der Lee and Ellemers <a href="https://www.pnas.org/content/112/40/12349.abstract">published in PNAS</a>. Their paper suggested male researchers were more likely than female researchers to get research funding in the Netherlands. In their initial analysis (p. 12350) they provided a simple <span class="math inline">\(\chi^2\)</span> test to test the null hypothesis there was no difference in success for male versus female researchers, for which they reported <span class="math inline">\(\chi_{df = 1}^2 = 4.01, p = .045\)</span>. Happily, van der Lee and Ellemers provided their data values in their supplemental material (i.e., <a href="https://www.pnas.org/content/suppl/2015/09/16/1510159112.DCSupplemental/pnas.201510159SI.pdf">Table S1.</a>), which McElreath also displayed in his video.</p>
<p>Their data follows the same structure as the Berkeley admissions data. In his lecture, McElreath suggested their <span class="math inline">\(\chi^2\)</span> test is an example of Simpson’s paradox, just as with the Berkley data. He wasn’t the first person to raise this criticism (see Volker and SteenBeek’s <span class="citation">(<a href="#ref-volkerNoEvidenceThat2015" role="doc-biblioref">2015</a>)</span> <a href="https://www.pnas.org/content/112/51/E7036.full">critique</a>, which McElreath also pointed to in the lecture).</p>
<p>Here are the data:</p>
<div class="sourceCode" id="cb1547"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1547-1"><a href="adventures-in-covariance.html#cb1547-1"></a>funding &lt;-<span class="st"> </span></span>
<span id="cb1547-2"><a href="adventures-in-covariance.html#cb1547-2"></a><span class="st">  </span><span class="kw">tibble</span>(</span>
<span id="cb1547-3"><a href="adventures-in-covariance.html#cb1547-3"></a>    <span class="dt">discipline   =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Chemical sciences&quot;</span>, <span class="st">&quot;Physical sciences&quot;</span>, <span class="st">&quot;Physics&quot;</span>, <span class="st">&quot;Humanities&quot;</span>, </span>
<span id="cb1547-4"><a href="adventures-in-covariance.html#cb1547-4"></a>                         <span class="st">&quot;Technical sciences&quot;</span>,  <span class="st">&quot;Interdisciplinary&quot;</span>, <span class="st">&quot;Earth/life sciences&quot;</span>, </span>
<span id="cb1547-5"><a href="adventures-in-covariance.html#cb1547-5"></a>                         <span class="st">&quot;Social sciences&quot;</span>, <span class="st">&quot;Medical sciences&quot;</span>),</span>
<span id="cb1547-6"><a href="adventures-in-covariance.html#cb1547-6"></a>                     <span class="dt">each =</span> <span class="dv">2</span>),</span>
<span id="cb1547-7"><a href="adventures-in-covariance.html#cb1547-7"></a>    <span class="dt">gender       =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;m&quot;</span>, <span class="st">&quot;f&quot;</span>), <span class="dt">times =</span> <span class="dv">9</span>),</span>
<span id="cb1547-8"><a href="adventures-in-covariance.html#cb1547-8"></a>    <span class="dt">applications =</span> <span class="kw">c</span>(<span class="dv">83</span>, <span class="dv">39</span>, <span class="dv">135</span>, <span class="dv">39</span>, <span class="dv">67</span>, <span class="dv">9</span>, <span class="dv">230</span>, <span class="dv">166</span>, <span class="dv">189</span>, <span class="dv">62</span>, <span class="dv">105</span>, <span class="dv">78</span>, <span class="dv">156</span>, <span class="dv">126</span>, <span class="dv">425</span>, <span class="dv">409</span>, <span class="dv">245</span>, <span class="dv">260</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>(),</span>
<span id="cb1547-9"><a href="adventures-in-covariance.html#cb1547-9"></a>    <span class="dt">awards       =</span> <span class="kw">c</span>(<span class="dv">22</span>, <span class="dv">10</span>, <span class="dv">26</span>, <span class="dv">9</span>, <span class="dv">18</span>, <span class="dv">2</span>, <span class="dv">33</span>, <span class="dv">32</span>, <span class="dv">30</span>, <span class="dv">13</span>, <span class="dv">12</span>, <span class="dv">17</span>, <span class="dv">38</span>, <span class="dv">18</span>, <span class="dv">65</span>, <span class="dv">47</span>, <span class="dv">46</span>, <span class="dv">29</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>(),</span>
<span id="cb1547-10"><a href="adventures-in-covariance.html#cb1547-10"></a>    <span class="dt">rejects      =</span> <span class="kw">c</span>(<span class="dv">61</span>, <span class="dv">29</span>, <span class="dv">109</span>, <span class="dv">30</span>, <span class="dv">49</span>, <span class="dv">7</span>, <span class="dv">197</span>, <span class="dv">134</span>, <span class="dv">159</span>, <span class="dv">49</span>, <span class="dv">93</span>, <span class="dv">61</span>, <span class="dv">118</span>, <span class="dv">108</span>, <span class="dv">360</span>, <span class="dv">362</span>, <span class="dv">199</span>, <span class="dv">231</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>(),</span>
<span id="cb1547-11"><a href="adventures-in-covariance.html#cb1547-11"></a>    <span class="dt">male         =</span> <span class="kw">ifelse</span>(gender <span class="op">==</span><span class="st"> &quot;f&quot;</span>, <span class="dv">0</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.integer</span>()</span>
<span id="cb1547-12"><a href="adventures-in-covariance.html#cb1547-12"></a>  )</span>
<span id="cb1547-13"><a href="adventures-in-covariance.html#cb1547-13"></a></span>
<span id="cb1547-14"><a href="adventures-in-covariance.html#cb1547-14"></a>funding</span></code></pre></div>
<pre><code>## # A tibble: 18 x 6
##    discipline          gender applications awards rejects  male
##    &lt;chr&gt;               &lt;chr&gt;         &lt;int&gt;  &lt;int&gt;   &lt;int&gt; &lt;int&gt;
##  1 Chemical sciences   m                83     22      61     1
##  2 Chemical sciences   f                39     10      29     0
##  3 Physical sciences   m               135     26     109     1
##  4 Physical sciences   f                39      9      30     0
##  5 Physics             m                67     18      49     1
##  6 Physics             f                 9      2       7     0
##  7 Humanities          m               230     33     197     1
##  8 Humanities          f               166     32     134     0
##  9 Technical sciences  m               189     30     159     1
## 10 Technical sciences  f                62     13      49     0
## 11 Interdisciplinary   m               105     12      93     1
## 12 Interdisciplinary   f                78     17      61     0
## 13 Earth/life sciences m               156     38     118     1
## 14 Earth/life sciences f               126     18     108     0
## 15 Social sciences     m               425     65     360     1
## 16 Social sciences     f               409     47     362     0
## 17 Medical sciences    m               245     46     199     1
## 18 Medical sciences    f               260     29     231     0</code></pre>
<p>Let’s fit a few models.</p>
<p>First, we’ll fit an analogue to the initial van der Lee and Ellemers <span class="math inline">\(\chi^2\)</span> test. Since we’re Bayesian modelers, we’ll use a simple logistic regression, using <code>male</code> (dummy coded 0 = female, 1 = male) to predict admission (i.e., <code>awards</code>).</p>
<div class="sourceCode" id="cb1549"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1549-1"><a href="adventures-in-covariance.html#cb1549-1"></a>b13<span class="fl">.8</span> &lt;-<span class="st"> </span></span>
<span id="cb1549-2"><a href="adventures-in-covariance.html#cb1549-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> funding, </span>
<span id="cb1549-3"><a href="adventures-in-covariance.html#cb1549-3"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1549-4"><a href="adventures-in-covariance.html#cb1549-4"></a>      awards <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>male,</span>
<span id="cb1549-5"><a href="adventures-in-covariance.html#cb1549-5"></a>      <span class="co"># note our continued use of weakly-regularizing priors</span></span>
<span id="cb1549-6"><a href="adventures-in-covariance.html#cb1549-6"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1549-7"><a href="adventures-in-covariance.html#cb1549-7"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="dt">class =</span> b)),</span>
<span id="cb1549-8"><a href="adventures-in-covariance.html#cb1549-8"></a>      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</span>
<span id="cb1549-9"><a href="adventures-in-covariance.html#cb1549-9"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1549-10"><a href="adventures-in-covariance.html#cb1549-10"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.08&quot;</span>)</span></code></pre></div>
<p>If you inspect them, the chains look great. We’ll jump straight to the posterior summaries.</p>
<div class="sourceCode" id="cb1550"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1550-1"><a href="adventures-in-covariance.html#cb1550-1"></a><span class="kw">tidy</span>(b13<span class="fl">.8</span>) <span class="op">%&gt;%</span></span>
<span id="cb1550-2"><a href="adventures-in-covariance.html#cb1550-2"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">!=</span><span class="st"> &quot;lp__&quot;</span>) <span class="op">%&gt;%</span></span>
<span id="cb1550-3"><a href="adventures-in-covariance.html#cb1550-3"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.numeric, round, <span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>##          term estimate std.error lower upper
## 1 b_Intercept    -1.74      0.08 -1.88 -1.61
## 2      b_male     0.21      0.10  0.04  0.38</code></pre>
<p>Yep, the 95% intervals for <code>male</code> dummy exclude zero. If you wanted a one-sided Bayesian <span class="math inline">\(p\)</span>-value, you might do something like this.</p>
<div class="sourceCode" id="cb1552"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1552-1"><a href="adventures-in-covariance.html#cb1552-1"></a><span class="kw">posterior_samples</span>(b13<span class="fl">.8</span>) <span class="op">%&gt;%</span></span>
<span id="cb1552-2"><a href="adventures-in-covariance.html#cb1552-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">one_sided_Bayesian_p_value =</span> <span class="kw">mean</span>(b_male <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>))</span></code></pre></div>
<pre><code>##   one_sided_Bayesian_p_value
## 1                  0.0194375</code></pre>
<p>Pretty small. But recall how Simpson’s paradox helped us understand the Berkeley data. [If you need a refresher on Simpson’s paradox, <a href="https://solomonkurz.netlify.com/post/individuals-are-not-small-groups-i-simpson-s-paradox/">go here</a>.] Different departments in Berkeley had different acceptance rates AND different ratios of male and female applicants. Similarly, different academic disciplines in the Netherlands might have different <code>award</code> rates for funding AND different ratios of male and female applications.</p>
<p>Just like in section 13.2, let’s fit two more models. The first model will allow intercepts to vary by discipline. The second model will allow intercepts and the <code>male</code> dummy slopes to vary by discipline.</p>
<div class="sourceCode" id="cb1554"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1554-1"><a href="adventures-in-covariance.html#cb1554-1"></a>b13<span class="fl">.9</span> &lt;-<span class="st"> </span></span>
<span id="cb1554-2"><a href="adventures-in-covariance.html#cb1554-2"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> funding, </span>
<span id="cb1554-3"><a href="adventures-in-covariance.html#cb1554-3"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1554-4"><a href="adventures-in-covariance.html#cb1554-4"></a>      awards <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>male <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>discipline),</span>
<span id="cb1554-5"><a href="adventures-in-covariance.html#cb1554-5"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1554-6"><a href="adventures-in-covariance.html#cb1554-6"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="dt">class =</span> b),</span>
<span id="cb1554-7"><a href="adventures-in-covariance.html#cb1554-7"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> sd)),</span>
<span id="cb1554-8"><a href="adventures-in-covariance.html#cb1554-8"></a>      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</span>
<span id="cb1554-9"><a href="adventures-in-covariance.html#cb1554-9"></a>      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.99</span>),</span>
<span id="cb1554-10"><a href="adventures-in-covariance.html#cb1554-10"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1554-11"><a href="adventures-in-covariance.html#cb1554-11"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.09&quot;</span>)</span>
<span id="cb1554-12"><a href="adventures-in-covariance.html#cb1554-12"></a></span>
<span id="cb1554-13"><a href="adventures-in-covariance.html#cb1554-13"></a>b13<span class="fl">.10</span> &lt;-<span class="st"> </span></span>
<span id="cb1554-14"><a href="adventures-in-covariance.html#cb1554-14"></a><span class="st">  </span><span class="kw">brm</span>(<span class="dt">data =</span> funding, </span>
<span id="cb1554-15"><a href="adventures-in-covariance.html#cb1554-15"></a>      <span class="dt">family =</span> binomial,</span>
<span id="cb1554-16"><a href="adventures-in-covariance.html#cb1554-16"></a>      awards <span class="op">|</span><span class="st"> </span><span class="kw">trials</span>(applications) <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>male <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>male <span class="op">|</span><span class="st"> </span>discipline),</span>
<span id="cb1554-17"><a href="adventures-in-covariance.html#cb1554-17"></a>      <span class="dt">prior =</span> <span class="kw">c</span>(<span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="dt">class =</span> Intercept),</span>
<span id="cb1554-18"><a href="adventures-in-covariance.html#cb1554-18"></a>                <span class="kw">prior</span>(<span class="kw">normal</span>(<span class="dv">0</span>, <span class="dv">4</span>), <span class="dt">class =</span> b),</span>
<span id="cb1554-19"><a href="adventures-in-covariance.html#cb1554-19"></a>                <span class="kw">prior</span>(<span class="kw">cauchy</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">class =</span> sd),</span>
<span id="cb1554-20"><a href="adventures-in-covariance.html#cb1554-20"></a>                <span class="kw">prior</span>(<span class="kw">lkj</span>(<span class="dv">4</span>), <span class="dt">class =</span> cor)),</span>
<span id="cb1554-21"><a href="adventures-in-covariance.html#cb1554-21"></a>      <span class="dt">iter =</span> <span class="dv">5000</span>, <span class="dt">warmup =</span> <span class="dv">1000</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">cores =</span> <span class="dv">4</span>,</span>
<span id="cb1554-22"><a href="adventures-in-covariance.html#cb1554-22"></a>      <span class="dt">control =</span> <span class="kw">list</span>(<span class="dt">adapt_delta =</span> <span class="fl">.99</span>),</span>
<span id="cb1554-23"><a href="adventures-in-covariance.html#cb1554-23"></a>      <span class="dt">seed =</span> <span class="dv">13</span>,</span>
<span id="cb1554-24"><a href="adventures-in-covariance.html#cb1554-24"></a>      <span class="dt">file =</span> <span class="st">&quot;fits/b13.10&quot;</span>)</span></code></pre></div>
<p>We’ll compare the models with information criteria.</p>
<div class="sourceCode" id="cb1555"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1555-1"><a href="adventures-in-covariance.html#cb1555-1"></a>b13<span class="fl">.8</span>  &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.8</span>,  <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1555-2"><a href="adventures-in-covariance.html#cb1555-2"></a>b13<span class="fl">.9</span>  &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.9</span>,  <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1555-3"><a href="adventures-in-covariance.html#cb1555-3"></a>b13<span class="fl">.10</span> &lt;-<span class="st"> </span><span class="kw">add_criterion</span>(b13<span class="fl">.10</span>, <span class="st">&quot;waic&quot;</span>)</span>
<span id="cb1555-4"><a href="adventures-in-covariance.html#cb1555-4"></a></span>
<span id="cb1555-5"><a href="adventures-in-covariance.html#cb1555-5"></a><span class="kw">loo_compare</span>(b13<span class="fl">.8</span>, b13<span class="fl">.9</span>, b13<span class="fl">.10</span>,</span>
<span id="cb1555-6"><a href="adventures-in-covariance.html#cb1555-6"></a>            <span class="dt">criterion =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1555-7"><a href="adventures-in-covariance.html#cb1555-7"></a><span class="st">  </span><span class="kw">print</span>(<span class="dt">simplify =</span> F)</span></code></pre></div>
<pre><code>##        elpd_diff se_diff elpd_waic se_elpd_waic p_waic se_p_waic waic  se_waic
## b13.10   0.0       0.0   -58.2       2.8          8.7    1.0     116.3   5.6  
## b13.9   -4.6       1.4   -62.8       3.7         10.0    1.5     125.6   7.3  
## b13.8   -6.6       2.7   -64.8       4.4          4.6    1.4     129.5   8.9</code></pre>
<p>The WAIC suggests the varying intercepts/varying slopes model made the best sense of the data. The WAIC weights tell a similar story.</p>
<div class="sourceCode" id="cb1557"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1557-1"><a href="adventures-in-covariance.html#cb1557-1"></a><span class="kw">model_weights</span>(b13<span class="fl">.8</span>, b13<span class="fl">.9</span>, b13<span class="fl">.10</span>, <span class="dt">weights =</span> <span class="st">&quot;waic&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1557-2"><a href="adventures-in-covariance.html#cb1557-2"></a><span class="st">  </span><span class="kw">round</span>(<span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>##  b13.8  b13.9 b13.10 
##   0.00   0.01   0.99</code></pre>
<p>Here we’ll practice our <code>tidybayes::spread_draws()</code> skills from the <a href="multilevel-models.html#summary-bonus-put-your-random-effects-to-work">end of the last chapter</a> to see what the random intercepts from the full model look like in a coefficient plot.</p>
<div class="sourceCode" id="cb1559"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1559-1"><a href="adventures-in-covariance.html#cb1559-1"></a>b13<span class="fl">.10</span> <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1559-2"><a href="adventures-in-covariance.html#cb1559-2"></a><span class="st">  </span><span class="kw">spread_draws</span>(b_male, r_discipline[discipline,term]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1559-3"><a href="adventures-in-covariance.html#cb1559-3"></a><span class="st">  </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;male&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1559-4"><a href="adventures-in-covariance.html#cb1559-4"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1559-5"><a href="adventures-in-covariance.html#cb1559-5"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">effect     =</span> b_male <span class="op">+</span><span class="st"> </span>r_discipline,</span>
<span id="cb1559-6"><a href="adventures-in-covariance.html#cb1559-6"></a>         <span class="dt">discipline =</span> <span class="kw">str_replace</span>(discipline, <span class="st">&quot;[.]&quot;</span>, <span class="st">&quot; &quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1559-7"><a href="adventures-in-covariance.html#cb1559-7"></a><span class="st">  </span></span>
<span id="cb1559-8"><a href="adventures-in-covariance.html#cb1559-8"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> effect, <span class="dt">y =</span> <span class="kw">reorder</span>(discipline, effect))) <span class="op">+</span></span>
<span id="cb1559-9"><a href="adventures-in-covariance.html#cb1559-9"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#E8DCCF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1559-10"><a href="adventures-in-covariance.html#cb1559-10"></a><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">.width =</span> <span class="fl">.95</span>, <span class="dt">size =</span> <span class="fl">.9</span>, <span class="dt">scale =</span> <span class="fl">.9</span>,</span>
<span id="cb1559-11"><a href="adventures-in-covariance.html#cb1559-11"></a>               <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>) <span class="op">+</span></span>
<span id="cb1559-12"><a href="adventures-in-covariance.html#cb1559-12"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;Random slopes for the male dummy&quot;</span>,</span>
<span id="cb1559-13"><a href="adventures-in-covariance.html#cb1559-13"></a>       <span class="dt">subtitle =</span> <span class="st">&quot;The dots and horizontal lines are the posterior means and percentile-based</span><span class="ch">\n</span><span class="st">95% intervals, respectively. The values are on the log scale.&quot;</span>,</span>
<span id="cb1559-14"><a href="adventures-in-covariance.html#cb1559-14"></a>       <span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1559-15"><a href="adventures-in-covariance.html#cb1559-15"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>)) <span class="op">+</span></span>
<span id="cb1559-16"><a href="adventures-in-covariance.html#cb1559-16"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb1559-17"><a href="adventures-in-covariance.html#cb1559-17"></a>                      <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>())</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-79-1.png" width="864" /></p>
<p>Note how the 95% intervals for all the random <code>male</code> slopes contain zero within their bounds. Here are the fixed effects.</p>
<div class="sourceCode" id="cb1560"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1560-1"><a href="adventures-in-covariance.html#cb1560-1"></a><span class="kw">tidy</span>(b13<span class="fl">.10</span>) <span class="op">%&gt;%</span></span>
<span id="cb1560-2"><a href="adventures-in-covariance.html#cb1560-2"></a><span class="st">  </span><span class="kw">filter</span>(<span class="kw">str_detect</span>(term , <span class="st">&quot;b_&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb1560-3"><a href="adventures-in-covariance.html#cb1560-3"></a><span class="st">  </span><span class="kw">mutate_if</span>(is.numeric, round, <span class="dt">digits =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>##          term estimate std.error lower upper
## 1 b_Intercept    -1.63      0.15 -1.85 -1.37
## 2      b_male     0.15      0.18 -0.14  0.43</code></pre>
<p>And if you wanted a one-sided Bayesian <span class="math inline">\(p\)</span>-value for the <code>male</code> dummy for the full model, you execute something like this.</p>
<div class="sourceCode" id="cb1562"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1562-1"><a href="adventures-in-covariance.html#cb1562-1"></a><span class="kw">posterior_samples</span>(b13<span class="fl">.10</span>) <span class="op">%&gt;%</span></span>
<span id="cb1562-2"><a href="adventures-in-covariance.html#cb1562-2"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">one_sided_Bayesian_p_value =</span> <span class="kw">mean</span>(b_male <span class="op">&lt;=</span><span class="st"> </span><span class="dv">0</span>))</span></code></pre></div>
<pre><code>##   one_sided_Bayesian_p_value
## 1                   0.186375</code></pre>
<p>Here’s a fuller look at the posterior.</p>
<div class="sourceCode" id="cb1564"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1564-1"><a href="adventures-in-covariance.html#cb1564-1"></a><span class="kw">posterior_samples</span>(b13<span class="fl">.10</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb1564-2"><a href="adventures-in-covariance.html#cb1564-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> b_male, <span class="dt">y =</span> <span class="dv">0</span>)) <span class="op">+</span></span>
<span id="cb1564-3"><a href="adventures-in-covariance.html#cb1564-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">&quot;#E8DCCF&quot;</span>, <span class="dt">alpha =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb1564-4"><a href="adventures-in-covariance.html#cb1564-4"></a><span class="st">  </span><span class="kw">stat_halfeye</span>(<span class="dt">.width =</span> <span class="kw">c</span>(.<span class="dv">5</span>, <span class="fl">.95</span>),</span>
<span id="cb1564-5"><a href="adventures-in-covariance.html#cb1564-5"></a>               <span class="dt">color =</span> <span class="st">&quot;#80A0C7&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#394165&quot;</span>) <span class="op">+</span></span>
<span id="cb1564-6"><a href="adventures-in-covariance.html#cb1564-6"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="ot">NULL</span>, <span class="dt">breaks =</span> <span class="ot">NULL</span>) <span class="op">+</span></span>
<span id="cb1564-7"><a href="adventures-in-covariance.html#cb1564-7"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;b_male (i.e., the population estimate for gender bias)&quot;</span>) <span class="op">+</span></span>
<span id="cb1564-8"><a href="adventures-in-covariance.html#cb1564-8"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>)) <span class="op">+</span></span>
<span id="cb1564-9"><a href="adventures-in-covariance.html#cb1564-9"></a><span class="st">  </span><span class="kw">theme_pearl_earring</span>()</span></code></pre></div>
<p><img src="13_files/figure-gfm/unnamed-chunk-82-1.png" width="576" /></p>
<p>So, the estimate of the gender bias is small and consistent with the null hypothesis. Which is good! We want gender equality for things like funding success.</p>
</div>
<div id="session-info-12" class="section level2 unnumbered">
<h2>Session info</h2>
<div class="sourceCode" id="cb1565"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1565-1"><a href="adventures-in-covariance.html#cb1565-1"></a><span class="kw">sessionInfo</span>()</span></code></pre></div>
<pre><code>## R version 3.6.3 (2020-02-29)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15.3
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
## [1] parallel  stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] ggbeeswarm_0.6.0     ggrepel_0.8.2        broom_0.5.5          posterior_0.1.0     
##  [5] patchwork_1.0.1.9000 brms_2.13.5          Rcpp_1.0.5           tidybayes_2.1.1     
##  [9] dagitty_0.2-2        rstan_2.19.3         StanHeaders_2.21.0-1 dutchmasters_0.1.0  
## [13] forcats_0.5.0        stringr_1.4.0        dplyr_1.0.1          purrr_0.3.4         
## [17] readr_1.3.1          tidyr_1.1.1          tibble_3.0.3         ggplot2_3.3.2       
## [21] tidyverse_1.3.0     
## 
## loaded via a namespace (and not attached):
##   [1] readxl_1.3.1         backports_1.1.9      plyr_1.8.6           igraph_1.2.5        
##   [5] splines_3.6.3        svUnit_1.0.3         crosstalk_1.1.0.1    TH.data_1.0-10      
##   [9] rstantools_2.1.1     inline_0.3.15        digest_0.6.25        invgamma_1.1        
##  [13] htmltools_0.5.0      rsconnect_0.8.16     fansi_0.4.1          magrittr_1.5        
##  [17] checkmate_2.0.0      modelr_0.1.6         matrixStats_0.56.0   xts_0.12-0          
##  [21] sandwich_2.5-1       prettyunits_1.1.1    colorspace_1.4-1     rvest_0.3.5         
##  [25] ggdist_2.1.1         haven_2.2.0          xfun_0.13            callr_3.4.4         
##  [29] crayon_1.3.4         jsonlite_1.7.0       survival_3.1-12      zoo_1.8-7           
##  [33] glue_1.4.2           gtable_0.3.0         emmeans_1.4.5        V8_3.0.2            
##  [37] pkgbuild_1.1.0       shape_1.4.4          abind_1.4-5          scales_1.1.1        
##  [41] mvtnorm_1.1-0        emo_0.0.0.9000       DBI_1.1.0            miniUI_0.1.1.1      
##  [45] xtable_1.8-4         HDInterval_0.2.0     stats4_3.6.3         DT_0.13             
##  [49] htmlwidgets_1.5.1    httr_1.4.1           threejs_0.3.3        arrayhelpers_1.1-0  
##  [53] ellipsis_0.3.1       pkgconfig_2.0.3      loo_2.3.1            farver_2.0.3        
##  [57] dbplyr_1.4.2         utf8_1.1.4           tidyselect_1.1.0     labeling_0.3        
##  [61] rlang_0.4.7          reshape2_1.4.4       later_1.1.0.1        munsell_0.5.0       
##  [65] cellranger_1.1.0     tools_3.6.3          cli_2.0.2            generics_0.0.2      
##  [69] ggridges_0.5.2       evaluate_0.14        fastmap_1.0.1        yaml_2.2.1          
##  [73] processx_3.4.4       knitr_1.28           fs_1.4.1             nlme_3.1-144        
##  [77] mime_0.9             xml2_1.3.1           compiler_3.6.3       bayesplot_1.7.1     
##  [81] shinythemes_1.1.2    rstudioapi_0.11      beeswarm_0.2.3       curl_4.3            
##  [85] reprex_0.3.0         stringi_1.4.6        ps_1.3.4             Brobdingnag_1.2-6   
##  [89] lattice_0.20-38      Matrix_1.2-18        markdown_1.1         shinyjs_1.1         
##  [93] vctrs_0.3.4          pillar_1.4.6         lifecycle_0.2.0      bridgesampling_1.0-0
##  [97] estimability_1.3     httpuv_1.5.4         R6_2.4.1             bookdown_0.18       
## [101] promises_1.1.1       gridExtra_2.3        nleqslv_3.3.2        vipor_0.4.5         
## [105] codetools_0.2-16     boot_1.3-24          colourpicker_1.0     MASS_7.3-51.5       
## [109] gtools_3.8.2         assertthat_0.2.1     withr_2.2.0          shinystan_2.5.0     
## [113] multcomp_1.4-13      hms_0.5.3            grid_3.6.3           coda_0.19-3         
## [117] rmarkdown_2.1        shiny_1.5.0          lubridate_1.7.8      base64enc_0.1-3     
## [121] dygraphs_1.1.1.6</code></pre>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-brms2020RM">
<p>Bürkner, P.-C. (2020b). <em>brms reference manual, Version 2.13.5</em>. <a href="https://CRAN.R-project.org/package=brms/brms.pdf">https://CRAN.R-project.org/package=brms/brms.pdf</a></p>
</div>
<div id="ref-Bürkner2020Phylogenetic">
<p>Bürkner, P.-C. (2020i). <em>Estimating phylogenetic multilevel models with brms</em>. <a href="https://CRAN.R-project.org/package=brms/vignettes/brms_phylogenetics.html">https://CRAN.R-project.org/package=brms/vignettes/brms_phylogenetics.html</a></p>
</div>
<div id="ref-R-ggbeeswarm">
<p>Clarke, E., &amp; Sherrill-Mix, S. (2017). <em>ggbeeswarm: Categorical scatter (violin point) plots</em> [Manual]. <a href="https://CRAN.R-project.org/package=ggbeeswarm">https://CRAN.R-project.org/package=ggbeeswarm</a></p>
</div>
<div id="ref-R-invgamma">
<p>Kahle, D., &amp; Stamey, J. (2017). <em>invgamma: The inverse gamma distribution</em> [Manual]. <a href="https://CRAN.R-project.org/package=invgamma">https://CRAN.R-project.org/package=invgamma</a></p>
</div>
<div id="ref-kayMarginalDistributionSingle2020">
<p>Kay, M. (2020a). <em>Marginal distribution of a single correlation from an LKJ distribution</em>. <a href="https://mjskay.github.io/ggdist/reference/lkjcorr_marginal.html">https://mjskay.github.io/ggdist/reference/lkjcorr_marginal.html</a></p>
</div>
<div id="ref-kruschkeDoingBayesianData2015">
<p>Kruschke, J. K. (2015). <em>Doing Bayesian data analysis: A tutorial with R, JAGS, and Stan</em>. Academic Press. <a href="https://sites.google.com/site/doingbayesiandataanalysis/">https://sites.google.com/site/doingbayesiandataanalysis/</a></p>
</div>
<div id="ref-mcelreathStatisticalRethinkingBayesian2015">
<p>McElreath, R. (2015). <em>Statistical rethinking: A Bayesian course with examples in R and Stan</em>. CRC press. <a href="https://xcelab.net/rm/statistical-rethinking/">https://xcelab.net/rm/statistical-rethinking/</a></p>
</div>
<div id="ref-pengMasteringSoftwareDevelopment2017">
<p>Peng, R. D., Kross, S., &amp; Anderson, B. (2017). <em>Mastering software development in {}R{}</em>. <a href="https://github.com/rdpeng/RProgDA">https://github.com/rdpeng/RProgDA</a></p>
</div>
<div id="ref-R-dutchmasters">
<p>Thoen, E. (2019). <em>dutchmasters</em> [Manual]. <a href="https://github.com/EdwinTh/dutchmasters">https://github.com/EdwinTh/dutchmasters</a></p>
</div>
<div id="ref-vanderleeGender2015">
<p>Van der Lee, R., &amp; Ellemers, N. (2015). Gender contributes to personal research funding success in The Netherlands. <em>Proceedings of the National Academy of Sciences</em>, <em>112</em>(40), 12349–12353. <a href="https://doi.org/10.1073/pnas.1510159112">https://doi.org/10.1073/pnas.1510159112</a></p>
</div>
<div id="ref-vermeerGirlPearlEarring1665">
<p>Vermeer, J. (1665). <em>Girl with a pearl earring</em>.</p>
</div>
<div id="ref-volkerNoEvidenceThat2015">
<p>Volker, B., &amp; Steenbeek, W. (2015). No evidence that gender contributes to personal research funding success in The Netherlands: A reaction to van der Lee and Ellemers. <em>Proceedings of the National Academy of Sciences</em>, <em>112</em>(51), E7036–E7037. <a href="https://doi.org/10.1073/pnas.1519046112">https://doi.org/10.1073/pnas.1519046112</a></p>
</div>
<div id="ref-wickhamGgplot2ElegantGraphics2016">
<p>Wickham, H. (2016). <em>ggplot2: Elegant graphics for data analysis</em>. Springer-Verlag New York. <a href="https://ggplot2-book.org/">https://ggplot2-book.org/</a></p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="multilevel-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="missing-data-and-other-opportunities.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
